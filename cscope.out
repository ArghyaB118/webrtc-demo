cscope 15 $HOME/webrtc-demo               0000146401
	@scream/code/NetQueue.cpp

1 
	~"N‘Queue.h
"

2 
	~<io¡»am
>

3 
	~<¡ršg.h
>

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<®gÜ™hm
>

8 
usšg
 
Çme¥aû
 
	g¡d
;

13 
	gN‘QueueI‹m
::
	$N‘QueueI‹m
() {

14 
·ck‘
 = 0;

15 
u£d
 = 
çl£
;

16 
size
 = 0;

17 
£qNr
 = 0;

18 
tR–—£
 = 0.0;

19 
tQueue
 = 0.0;

20 
	}
}

22 
	gN‘Queue
::
	$N‘Queue
(
d–ay_
, 
¿‹_
, 
j™‹r_
, 
boŞ
 
isL4s_
) {

23 
n
=0;‚ < 
N‘QueueSize
;‚++) {

24 
™ems
[
n
] = 
Ãw
 
	`N‘QueueI‹m
();

26 
h—d
 = -1;

27 

 = 0;

28 
nI‹ms
 = 0;

29 
¿‹
 = 
¿‹_
;

30 
d–ay
 = 
d–ay_
;

31 
j™‹r
 = 
j™‹r_
;

32 
Ï¡QueueLow
 = 0.0;

33 
ÃxtTx
 = 0;

34 
isL4s
 = 
isL4s_
;

35 
by‹sTx
 = 0;

36 
Ï¡R©eUpd©eT
 = 0;

37 
pDrİ
 = 0.0f;

38 
´evR©eF¿c
 = 0.0f;

39 
l4sTh
 = 0.002;

40 
tQueueAvg
 = 0.0;

41 
	}
}

43 
	gN‘Queue
::
	$š£¹
(
time
,

44 *
¹pPack‘
,

45 
s¤c
,

46 
size
,

47 
£qNr
,

48 
boŞ
 
isCe
) {

49 
´evH—d
 = 
h—d
;

50 
h—d
++; ià(h—d =ğ
N‘QueueSize
) head = 0;

51 
™ems
[
h—d
]->
u£d
 = 
Œue
;

52 
™ems
[
h—d
]->
·ck‘
 = 
¹pPack‘
;

53 
™ems
[
h—d
]->
s¤c
 = ssrc;

54 
™ems
[
h—d
]->
size
 = size;

55 
™ems
[
h—d
]->
£qNr
 = seqNr;

56 
™ems
[
h—d
]->
tR–—£
 = 
time
+
d–ay
+
j™‹r
*(
	`¿nd
()/(
RAND_MAX
));

57 
™ems
[
h—d
]->
tQueue
 = 
time
;

58 
™ems
[
h—d
]->
isCe
 = isCe;

59 ià(
¿‹
 > 0) {

60 
d–ay
 = 
size
*8.0à/ 
¿‹
;

61 ià(
´evH—d
 !ğ-1 && 
™ems
[´evH—d]->
u£d
) {

62 
™ems
[
h—d
]->
tR–—£
 = i‹ms[
´evH—d
]->tR–—£ + 
d–ay
;

65 
™ems
[
h—d
]->
tR–—£
 = 
time
 + 
d–ay
;

68 
™ems
[
h—d
]->
tR–—£
 = 
¡d
::
	`max
(™ems[h—d]->tR–—£, 
ÃxtTx
);

69 
ÃxtTx
 = 
™ems
[
h—d
]->
tR–—£
;

70 
	}
}

72 
boŞ
 
	gN‘Queue
::
	$exŒaù
(
time
,

73 *
¹pPack‘
,

74 &
s¤c
,

75 & 
size
,

76 & 
£qNr
,

77 
boŞ
& 
isCe
) {

78 ià(
™ems
[

]->
u£d
 =ğ
çl£
) {

79 
Ï¡QueueLow
 = 
time
;

80  
çl£
;

82 ià(
time
 >ğ
™ems
[

]->
tR–—£
) {

83 
¹pPack‘
 = 
™ems
[

]->
·ck‘
;

84 
£qNr
 = 
™ems
[

]->seqNr;

85 
s¤c
 = 
™ems
[

]->ssrc;

86 
size
 = 
™ems
[

]->size;

87 
isCe
 = 
™ems
[

]->isCe;

88 
™ems
[

]->
u£d
 = 
çl£
;

92 
qD–
 = 
time
 - 
™ems
[

]->
tQueue
;

93 ià(!
isL4s
 && 
time
 - 
™ems
[

]->
tQueue
 <ğ0.005 && 
¿‹
 > 0.0) {

94 
Ï¡QueueLow
 = 
time
;

96 ià(!
isL4s
 && 
time
 - 
Ï¡QueueLow
 > 0.1 && 
¿‹
 > 0.0) {

97 
isCe
 = 
Œue
;

98 
Ï¡QueueLow
 = 
time
;

100 
tQueueAvg
 = (
time
-
™ems
[

]->
tQueue
);

102 ià(
çl£
 && 
¿‹
 > 0)

103 
û¼
 << 
tQueueAvg
 << 
’dl
;

104 ià(
isL4s
 && 
tQueueAvg
 > 
l4sTh
 && 
¿‹
 > 0.0) {

105 
isCe
 = 
Œue
;

107 ià(
çl£
 && 
isL4s
 && 
pDrİ
 > 0.0f) {

108 
ºd
 = (
	`¿nd
()è/ 
RAND_MAX
;

109 ià(
ºd
 < 
pDrİ
) {

110 
isCe
 = 
Œue
;

113 
by‹sTx
 +ğ
size
;

114 

++; iàÑa =ğ
N‘QueueSize
)ail = 0;

116  
Œue
;

118  
çl£
;

120 
	}
}

122 
	gN‘Queue
::
	$sizeOfQueue
() {

123 
size
 = 0;

124 
n
=0;‚ < 
N‘QueueSize
;‚++) {

125 ià(
™ems
[
n
]->
u£d
)

126 
size
 +ğ
™ems
[
n
]->size;

128  
size
;

129 
	}
}

131 cÚ¡ 
	g¿‹Upd©eT
 = 0.05;

133 
	gN‘Queue
::
	$upd©eR©e
(
time
) {

134 ià(
time
 - 
Ï¡R©eUpd©eT
 >ğ
¿‹Upd©eT
 && 
¿‹
 > 0) {

135 
dT
 = 
time
 - 
Ï¡R©eUpd©eT
;

136 
¿‹T
 = 
by‹sTx
 * 8 / 
dT
;

137 
by‹sTx
 = 0;

138 
Ï¡R©eUpd©eT
 = 
time
;

139 
¿‹F¿c
 = 
¿‹T
 / 
¿‹
 - 0.9;

140 
¿‹F¿c
 /= 0.2;

141 
¿‹F¿c
 = 
¡d
::
	`max
(0.0f, std::
	`mš
(1.0f,„ateFrac));

142 
pDrİ
 = 0.9*pDrİ + 0.1*
¿‹F¿c
;

143 
pDrİ
 = 
¡d
::
	`mš
(1.0f, std::
	`max
(0.0f,…Drop));

144 
´evR©eF¿c
 = 
¿‹F¿c
;

145 ià(
çl£
 && 
pDrİ
 > 0)

146 
û¼
 << 
pDrİ
 << 
’dl
;;

148 
	}
}

	@scream/code/NetQueue.h

1 #iâdeà
NET_QUEUE


2 
	#NET_QUEUE


	)

5 şas 
	cN‘QueueI‹m
 {

6 
	mpublic
:

7 
N‘QueueI‹m
();

8 * 
	m·ck‘
;

9 
	ms¤c
;

10 
	msize
;

11 
	m£qNr
;

12 
	mtR–—£
;

13 
	mtQueue
;

14 
boŞ
 
	misCe
;

15 
boŞ
 
	mu£d
;

17 cÚ¡ 
	gN‘QueueSize
 = 10000;

18 şas 
	cN‘Queue
 {

19 
	mpublic
:

21 
N‘Queue
(
d–ay
, 
¿‹
=0.0f, 
j™‹r
=0.0f, 
boŞ
 
isL4s
 = 
çl£
);

23 
š£¹
(
time
,

24 *
¹pPack‘
,

25 
s¤c
,

26 
size
,

27 
£qNr
,

28 
boŞ
 
isCe
 = 
çl£
);

29 
boŞ
 
exŒaù
(
time
,

30 *
¹pPack‘
,

31 &
s¤c
,

32 & 
size
,

33 &
£qNr
,

34 
boŞ
 &
isCe
);

35 
sizeOfQueue
();

37 
upd©eR©e
(
time
);

39 
N‘QueueI‹m
 *
	m™ems
[
N‘QueueSize
];

40 
	mh—d
;

41 
	m
;

42 
	mnI‹ms
;

43 
	md–ay
;

44 
	m¿‹
;

45 
	mj™‹r
;

46 
	mÃxtTx
;

47 
	mÏ¡QueueLow
;

48 
boŞ
 
	misL4s
;

49 
	mby‹sTx
;

50 
	mÏ¡R©eUpd©eT
;

51 
	mpDrİ
;

52 
	m´evR©eF¿c
;

53 
	ml4sTh
;

54 
	mtQueueAvg
;

	@scream/code/RtpQueue.cpp

1 
	~"RQueue.h
"

2 
	~<io¡»am
>

3 
	~<¡ršg.h
>

4 
usšg
 
Çme¥aû
 
	g¡d
;

9 
	gRQueueI‹m
::
	$RQueueI‹m
() {

10 
u£d
 = 
çl£
;

11 
size
 = 0;

12 
£qNr
 = 0;

13 
	}
}

16 
	gRQueue
::
	$RQueue
() {

17 
n
=0;‚ < 
kRQueueSize
;‚++) {

18 
™ems
[
n
] = 
Ãw
 
	`RQueueI‹m
();

20 
h—d
 = -1;

21 

 = 0;

22 
nI‹ms
 = 0;

23 
sizeOfLa¡F¿me
 = 0;

24 
by‹sInQueue_
 = 0;

25 
sizeOfQueue_
 = 0;

26 
sizeOfNextR_
 = -1;

27 
	}
}

29 
boŞ
 
	gRQueue
::
	$push
(*
¹pPack‘
, 
size
, 
£qNr
, 
boŞ
 
isM¬k
, 
ts
) {

30 
ix
 = 
h—d
+1;

31 ià(
ix
 =ğ
kRQueueSize
) ix = 0;

32 ià(
™ems
[
ix
]->
u£d
) {

36  (
çl£
);

38 
h—d
 = 
ix
;

39 
™ems
[
h—d
]->
£qNr
 = seqNr;

40 
™ems
[
h—d
]->
size
 = size;

41 
™ems
[
h—d
]->
ts
 =s;

42 
™ems
[
h—d
]->
isM¬k
 = isMark;

43 
™ems
[
h—d
]->
u£d
 = 
Œue
;

44 
by‹sInQueue_
 +ğ
size
;

45 
sizeOfQueue_
 += 1;

46 #iâdeà
IGNORE_PACKET


47 
™ems
[
h—d
]->
·ck‘
 = 
¹pPack‘
;

49 
	`compu‹SizeOfNextR
();

50  (
Œue
);

51 
	}
}

52 
boŞ
 
	gRQueue
::
	$pİ
(**
¹pPack‘
, & 
size
, & 
£qNr
, 
boŞ
 &
isM¬k
)

54 ià(
™ems
[

]->
u£d
 =ğ
çl£
) {

55 *
¹pPack‘
 = 
NULL
;

56  
çl£
;

57 
sizeOfNextR_
 = -1;

59 
size
 = 
™ems
[

]->size;

61 #iâdeà
IGNORE_PACKET


62 *
¹pPack‘
 = 
™ems
[

]->
·ck‘
;

64 
£qNr
 = 
™ems
[

]->seqNr;

65 
isM¬k
 = 
™ems
[

]->isMark;

66 
™ems
[

]->
u£d
 = 
çl£
;

67 

++; iàÑa =ğ
kRQueueSize
)ail = 0;

68 
by‹sInQueue_
 -ğ
size
;

69 
sizeOfQueue_
 -= 1;

70 
	`compu‹SizeOfNextR
();

71  
Œue
;

73 
	}
}

75 
	gRQueue
::
	$compu‹SizeOfNextR
() {

76 ià(!
™ems
[

]->
u£d
) {

77 
sizeOfNextR_
 = - 1;

79 
sizeOfNextR_
 = 
™ems
[

]->
size
;

81 
	}
}

83 
	gRQueue
::
	$sizeOfNextR
() {

84  
sizeOfNextR_
;

85 
	}
}

87 
	gRQueue
::
	$£qNrOfNextR
() {

88 ià(!
™ems
[

]->
u£d
) {

91  
™ems
[

]->
£qNr
;

93 
	}
}

95 
	gRQueue
::
	$£qNrOfLa¡R
() {

96 ià(!
™ems
[
h—d
]->
u£d
) {

99  
™ems
[
h—d
]->
£qNr
;

101 
	}
}

103 
	gRQueue
::
	$by‹sInQueue
() {

104  
by‹sInQueue_
;

105 
	}
}

107 
	gRQueue
::
	$sizeOfQueue
() {

108  
sizeOfQueue_
;

109 
	}
}

111 
	gRQueue
::
	$g‘D–ay
(
cu¼Ts
) {

112 ià(
™ems
[

]->
u£d
 =ğ
çl£
) {

115  
cu¼Ts
-
™ems
[

]->
ts
;

117 
	}
}

119 
boŞ
 
	gRQueue
::
	$£ndPack‘
(**
¹pPack‘
, & 
size
, & 
£qNr
) {

120 ià(
	`sizeOfQueue
() > 0) {

121 
boŞ
 
isM¬k
;

122 
	`pİ
(
¹pPack‘
, 
size
, 
£qNr
, 
isM¬k
);

123  
Œue
;

125  
çl£
;

126 
	}
}

128 #iâdeà
IGNORE_PACKET


129 
·ck‘_ä“
(*
buf
);

131 
	gRQueue
::
	$ş—r
() {

132 
ušt16_t
 
£qNr
;

133 
ä“d
 = 0;

134 
size
;

135 *
buf
;

136 
	`sizeOfQueue
() > 0) {

137 
boŞ
 
isM¬k
;

138 
	`pİ
(&
buf
, 
size
, 
£qNr
, 
isM¬k
);

139 ià(
buf
 !ğ
NULL
) {

140 
ä“d
++;

142 #iâdeà
IGNORE_PACKET


143 
	`·ck‘_ä“
(
buf
);

146  (
ä“d
);

147 
	}
}

	@scream/code/RtpQueue.h

1 #iâdeà
RTP_QUEUE


2 
	#RTP_QUEUE


	)

9 şas 
	cRQueueIçû
 {

10 
	mpublic
:

11 
vœtu®
 
ş—r
() = 0;

12 
vœtu®
 
sizeOfNextR
() = 0;

13 
vœtu®
 
£qNrOfNextR
() = 0;

14 
vœtu®
 
£qNrOfLa¡R
() = 0;

15 
vœtu®
 
by‹sInQueue
() = 0;

16 
vœtu®
 
sizeOfQueue
() = 0;

17 
vœtu®
 
g‘D–ay
(
cu¼Ts
) = 0;

18 
vœtu®
 
g‘SizeOfLa¡F¿me
() = 0;

21 şas 
	cRQueueI‹m
 {

22 
	mpublic
:

23 
RQueueI‹m
();

24 * 
	m·ck‘
;

25 
	msize
;

26 
	m£qNr
;

27 
	mts
;

28 
boŞ
 
	misM¬k
;

29 
boŞ
 
	mu£d
;

32 cÚ¡ 
	gkRQueueSize
 = 1024;

33 şas 
	cRQueue
 : 
public
 
RQueueIçû
 {

34 
public
:

35 
RQueue
();

37 
boŞ
 
push
(*
¹pPack‘
, 
size
, 
£qNr
, boŞ 
isM¬k
, 
ts
);

38 
boŞ
 
pİ
(**
¹pPack‘
, &
size
, &
£qNr
, boŞ &
isM¬k
);

39 
sizeOfNextR
();

40 
£qNrOfNextR
();

41 
£qNrOfLa¡R
();

42 
by‹sInQueue
();

43 
sizeOfQueue
();

44 
g‘D–ay
(
cu¼Ts
);

45 
boŞ
 
£ndPack‘
(**
¹pPack‘
, &
size
, &
£qNr
);

46 
ş—r
();

47 
	$g‘SizeOfLa¡F¿me
(è{ 
sizeOfLa¡F¿me
;};

48 
	$£tSizeOfLa¡F¿me
(
sz
è{
sizeOfLa¡F¿me
=sz;
	}
};

49 
compu‹SizeOfNextR
();

51 
RQueueI‹m
 *
	g™ems
[
kRQueueSize
];

52 
	gh—d
;

53 
	g
;

54 
	gnI‹ms
;

55 
	gsizeOfLa¡F¿me
;

57 
	gby‹sInQueue_
;

58 
	gsizeOfQueue_
;

59 
	gsizeOfNextR_
;

	@scream/code/ScreamRx.cpp

1 
	~"Sü—mRx.h
"

2 #ifdeà
_MSC_VER


3 
	#NOMINMAX


	)

4 
	~<WšSock2.h
>

6 
	~<¬·/š‘.h
>

8 
	~<¡ršg.h
>

9 
	~<şim™s
>

10 
	~<®gÜ™hm
>

11 
	~<io¡»am
>

12 
usšg
 
Çme¥aû
 
	g¡d
;

14 cÚ¡ 
	gkMaxRtıSize
 = 900;

17 cÚ¡ 
	gkTimeSmpAtoSÿË
 = 1024;

18 cÚ¡ 
	gÁp2SecSÿËFaùÜ
 = 1.0 / 65536;

20 
	gSü—mRx
::
SŒ—m
::
	$SŒ—m
(
ušt32_t
 
s¤c_
) {

21 
s¤c
 = 
s¤c_
;

22 
»ûiveTime¡amp
 = 0x0;

23 
highe¡SeqNr
 = 0x0;

24 
highe¡SeqNrTx
 = 0x0;

25 
Ï¡F“dbackT_Áp
 = 0;

26 
nRSšûLa¡Rtı
 = 0;

27 
fœ¡Reûived
 = 
çl£
;

29 
n
 = 0;‚ < 
kRxHi¡ÜySize
;‚++) {

30 
ûB™sHi¡
[
n
] = 0x00;

31 
rxTimeHi¡
[
n
] = 0;

32 
£qNrHi¡
[
n
] = 0x0000;

35 
	}
}

37 
boŞ
 
	gSü—mRx
::
SŒ—m
::
	$checkIfFlushAck
(
ackDiff
) {

38 
ušt32_t
 
diff
 = 
highe¡SeqNr
 - 
highe¡SeqNrTx
;

39  (
diff
 >ğ
ackDiff
);

40 
	}
}

42 
	gSü—mRx
::
SŒ—m
::
	$»ûive
(
ušt32_t
 
time_Áp
,

43 * 
¹pPack‘
,

44 
size
,

45 
ušt16_t
 
£qNr
,

46 
boŞ
 
isEúCe
,

47 
ušt8_t
 
ûB™s_
) {

52 
nRSšûLa¡Rtı
++;

57 ià(
fœ¡Reûived
 =ğ
çl£
) {

58 
highe¡SeqNr
 = 
£qNr
;

59 
highe¡SeqNr
--;

60 
n
 = 0;‚ < 
kRxHi¡ÜySize
;‚++) {

62 
£qNrHi¡
[
n
] = 
£qNr
 + 1;

64 
fœ¡Reûived
 = 
Œue
;

69 
ix
 = 
£qNr
 % 
kRxHi¡ÜySize
;

70 
ûB™sHi¡
[
ix
] = 
ûB™s_
;

71 
rxTimeHi¡
[
ix
] = 
time_Áp
;

72 
£qNrHi¡
[
ix
] = 
£qNr
;

74 
ušt32_t
 
£qNrExt
 = 
£qNr
;

75 
ušt32_t
 
highe¡SeqNrExt
 = 
highe¡SeqNr
;

76 ià(
£qNr
 < 
highe¡SeqNr
) {

77 ià(
highe¡SeqNr
 - 
£qNr
 > 16384)

78 
£qNrExt
 += 65536;

80 ià(
highe¡SeqNr
 < 
£qNr
) {

81 ià(
£qNr
 - 
highe¡SeqNr
 > 16384)

82 
highe¡SeqNrExt
 += 65536;

96 ià(
£qNrExt
 >ğ
highe¡SeqNrExt
) {

100 
highe¡SeqNr
 = 
£qNr
;

102 
	}
}

104 
boŞ
 
	gSü—mRx
::
SŒ—m
::
	$g‘Snd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

105 *
buf
,

106 &
size
) {

107 
ušt16_t
 
tmp_s
;

108 
ušt32_t
 
tmp_l
;

109 
size
 = 0;

113 
tmp_l
 = 
	`htÚl
(
s¤c
);

114 
	`memıy
(
buf
, &
tmp_l
, 4);

115 
size
 += 4;

120 
tmp_s
 = 
highe¡SeqNr
 - 
	`ušt16_t
(
nR•Ü‹dRPack‘s
 - 1);

121 
tmp_s
 = 
	`htÚs
(tmp_s);

122 
	`memıy
(
buf
 + 4, &
tmp_s
, 2);

123 
size
 += 2;

128 
tmp_s
 = 
nR•Ü‹dRPack‘s
 - 1;

129 
tmp_s
 = 
	`htÚs
(tmp_s);

130 
	`memıy
(
buf
 + 6, &
tmp_s
, 2);

131 
size
 += 2;

132 
±r
 = 8;

137 
ušt16_t
 
¢_lo
 = 
highe¡SeqNr
 - 
	`ušt16_t
(
nR•Ü‹dRPack‘s
 - 1);

139 
ušt16_t
 
k
 = 0; k < 
nR•Ü‹dRPack‘s
; k++) {

140 
ušt16_t
 
¢
 = 
¢_lo
 + 
k
;

142 
ix
 = 
¢
 % 
kRxHi¡ÜySize
;

143 
ušt32_t
 
©o
 = (
time_Áp
 - 
rxTimeHi¡
[
ix
]);

144 
©o
 =‡to >> 6;

145 ià(
©o
 > 8189)

146 
©o
 = 0x1FFE;

148 
tmp_s
 = 0x0000;

149 ià(
£qNrHi¡
[
ix
] =ğ
¢
 && 
rxTimeHi¡
[ix] != 0) {

150 
tmp_s
 = 0x8000 | ((
ûB™sHi¡
[
ix
] & 0x03è<< 13è| (
©o
 & 0x01FFF);;

153 
tmp_s
 = 
	`htÚs
(tmp_s);

154 
	`memıy
(
buf
 + 
±r
, &
tmp_s
, 2);

155 
size
 += 2;

156 
±r
 += 2;

161 ià(
nR•Ü‹dRPack‘s
 % 2 == 1) {

162 
tmp_s
 = 0x0000;

163 
	`memıy
(
buf
 + 
±r
, &
tmp_s
, 2);

164 
size
 += 2;

165 
±r
 += 2;

168  
Œue
;

169 
	}
}

171 
	gSü—mRx
::
	$Sü—mRx
(
ušt32_t
 
s¤c_
, 
ackDiff_
, 
nR•Ü‹dRPack‘s_
) {

172 
Ï¡F“dbackT_Áp
 = 0;

173 
by‹sReûived
 = 0;

174 
Ï¡R©eCompu‹T_Áp
 = 0;

175 
av”ageReûivedR©e
 = 1e5;

176 
¹ıFbIÁ”v®_Áp
 = 13107;

177 
s¤c
 = 
s¤c_
;

178 
ix
 = 0;

179 
nR•Ü‹dRPack‘s
 = 
nR•Ü‹dRPack‘s_
;

180 ià(
ackDiff_
 > 0)

181 
ackDiff
 = 
ackDiff_
;

183 
ackDiff
 = 
¡d
::
	`max
(1, 
nR•Ü‹dRPack‘s
 / 4);

185 
	}
}

187 
	gSü—mRx
::~
	$Sü—mRx
() {

188 ià(!
¡»ams
.
	`em±y
()) {

189 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

190 
	`d–‘e
 (*
™
);

193 
	}
}

195 
boŞ
 
	gSü—mRx
::
	$checkIfFlushAck
() {

196 ià(
ackDiff
 == 1)

197  
Œue
;

198 ià(!
¡»ams
.
	`em±y
()) {

199 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

200 ià((*
™
)->
	`checkIfFlushAck
(
ackDiff
))

201  
Œue
;

204  
çl£
;

205 
	}
}

207 
	gSü—mRx
::
	$»ûive
(
ušt32_t
 
time_Áp
,

208 * 
¹pPack‘
,

209 
ušt32_t
 
s¤c
,

210 
size
,

211 
ušt16_t
 
£qNr
,

212 
ušt8_t
 
ûB™s
) {

214 
by‹sReûived
 +ğ
size
;

215 ià(
Ï¡R©eCompu‹T_Áp
 == 0)

216 
Ï¡R©eCompu‹T_Áp
 = 
time_Áp
;

217 ià(
time_Áp
 - 
Ï¡R©eCompu‹T_Áp
 > 6554) {

222 
d–
 = (
time_Áp
 - 
Ï¡R©eCompu‹T_Áp
è* 
Áp2SecSÿËFaùÜ
;

223 
Ï¡R©eCompu‹T_Áp
 = 
time_Áp
;

224 
av”ageReûivedR©e
 = 
¡d
::
	`max
(0.95f*av”ageReûivedR©e, 
by‹sReûived
 * 8 / 
d–
);

225 
by‹sReûived
 = 0;

231 
¿‹
 = 0.02f*
av”ageReûivedR©e
 / (100.0f * 8.0f);

232 
¿‹
 = 
¡d
::
	`mš
(500.0f, std::
	`max
(10.0f,„ate));

238 
¹ıFbIÁ”v®_Áp
 = 
	`ušt32_t
(65536.0à/ 
¿‹
);

241 ià(!
¡»ams
.
	`em±y
()) {

242 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

243 ià((*
™
)->
	`isM©ch
(
s¤c
)) {

248 (*
™
)->
	`»ûive
(
time_Áp
, 
¹pPack‘
, 
size
, 
£qNr
, 
ûB™s
 == 0x03, ceBits);

257 
SŒ—m
 *
¡»am
 = 
Ãw
 
	`SŒ—m
(
s¤c
);

258 
¡»am
->
nR•Ü‹dRPack‘s
 =‚ReportedRtpPackets;

259 
¡»am
->
ix
 = ix++;

260 
¡»am
->
	`»ûive
(
time_Áp
, 
¹pPack‘
, 
size
, 
£qNr
, 
ûB™s
 == 0x03, ceBits);

261 
¡»ams
.
	`push_back
(
¡»am
);

262 
	}
}

264 
ušt32_t
 
	gSü—mRx
::
	$g‘RtıFbIÁ”v®
() {

265  
¹ıFbIÁ”v®_Áp
;

266 
	}
}

268 
boŞ
 
	gSü—mRx
::
	$isF“dback
(
ušt32_t
 
time_Áp
) {

269 ià(!
¡»ams
.
	`em±y
()) {

270 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

271 
SŒ—m
 *
¡»am
 = (*
™
);

272 ià(
¡»am
->
nRSšûLa¡Rtı
 >= 1) {

273  
Œue
;

277  
çl£
;

278 
	}
}

280 
	gSü—mRx
::
	$g‘Ix
(
ušt32_t
 
s¤c
) {

281 ià(!
¡»ams
.
	`em±y
()) {

282 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

283 
SŒ—m
 *
¡»am
 = (*
™
);

284 ià(
s¤c
 =ğ
¡»am
->ssrc)

285  
¡»am
->
ix
;

289 
	}
}

291 
boŞ
 
	gSü—mRx
::
	$ü—‹Snd¬dizedF“dback
(
ušt32_t
 
time_Áp
, 
boŞ
 
isM¬k
, *
buf
, &
size
) {

293 
ušt16_t
 
tmp_s
;

294 
ušt32_t
 
tmp_l
;

295 
buf
[0] = 0x80;

296 
buf
[1] = 205;

300 
tmp_l
 = 
	`htÚl
(
s¤c
);

301 
	`memıy
(
buf
 + 4, &
tmp_l
, 4);

302 
size
 = 8;

303 
±r
 = 8;

304 
boŞ
 
isF“dback
 = 
çl£
;

308 
size
 < 
kMaxRtıSize
) {

313 
SŒ—m
 *
¡»am
 = 
NULL
;

314 
ušt64_t
 
mšT_Áp
 = 
ULONG_MAX
;

315 autØ
™
 = 
¡»ams
.
	`begš
(); iˆ!ğ¡»ams.
	`’d
(); ++it) {

316 
ušt32_t
 
diffT_Áp
 = 
time_Áp
 - (*
™
)->
Ï¡F“dbackT_Áp
;

317 
nRSšûLa¡Rtı
 = (*
™
)->nRtpSinceLastRtcp;

318 ià((
nRSšûLa¡Rtı
 >ğ
¡d
::
	`mš
(8, 
ackDiff
è|| 
diffT_Áp
 > 655 || (
isM¬k
 &&‚RtpSinceLastRtcp > 0)) &&

319 (*
™
)->
Ï¡F“dbackT_Áp
 < 
mšT_Áp
) {

320 
¡»am
 = *
™
;

321 
mšT_Áp
 = (*
™
)->
Ï¡F“dbackT_Áp
;

324 ià(
¡»am
 =ğ
NULL
)

326 
isF“dback
 = 
Œue
;

327 
size_¡»am
 = 0;

328 
¡»am
->
	`g‘Snd¬dizedF“dback
(
time_Áp
, &
buf
[
±r
], 
size_¡»am
);

329 
size
 +ğ
size_¡»am
;

330 
±r
 +ğ
size_¡»am
;

331 
¡»am
->
Ï¡F“dbackT_Áp
 = 
time_Áp
;

332 
¡»am
->
nRSšûLa¡Rtı
 = 0;

333 
¡»am
->
highe¡SeqNrTx
 = sŒ—m->
highe¡SeqNr
;

335 ià(!
isF“dback
)

336  
çl£
;

340 
tmp_l
 = 
	`htÚl
(
time_Áp
);

341 
	`memıy
(
buf
 + 
±r
, &
tmp_l
, 4);

342 
size
 += 4;

347 
ušt16_t
 
Ëngth
 = 
size
 / 4 - 1;

348 
tmp_s
 = 
	`htÚs
(
Ëngth
);

349 
	`memıy
(
buf
 + 2, &
tmp_s
, 2);

354 
Ï¡F“dbackT_Áp
 = 
time_Áp
;

356  
Œue
;

357 
	}
}

	@scream/code/ScreamRx.h

1 #iâdeà
SCREAM_RX


2 
	#SCREAM_RX


	)

3 
	~<c¡dšt
>

4 
	~<li¡
>

5 cÚ¡ 
	gkR•Ü‹dRPack‘s
 = 64;

6 cÚ¡ 
	gkRxHi¡ÜySize
 = 128;

31 şas 
	cSü—mRx
 {

32 
	mpublic
:

33 
Sü—mRx
(
ušt32_t
 
s¤c
, 
ackDiff
 = -1, 
nR•Ü‹dRPack‘s
 = 
kR•Ü‹dRPack‘s
);

34 ~
Sü—mRx
();

39 şas 
	cSŒ—m
 {

40 
	mpublic
:

41 
SŒ—m
(
ušt32_t
 
s¤c
);

43 
boŞ
 
isM©ch
(
ušt32_t
 
s¤c_
è{  
	ms¤c
 == ssrc_; };

45 
boŞ
 
checkIfFlushAck
(
ackDiff
);

50 
»ûive
(
ušt32_t
 
time_Áp
,

51 *
¹pPack‘
,

52 
size
,

53 
ušt16_t
 
£qNr
,

54 
boŞ
 
isEúCe
,

55 
ušt8_t
 
ûB™s
);

61 
boŞ
 
g‘Snd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

62 *
buf
,

63 &
size
);

66 
ušt32_t
 
	ms¤c
;

67 
ušt16_t
 
	mhighe¡SeqNr
;

68 
ušt16_t
 
	mhighe¡SeqNrTx
;

69 
ušt32_t
 
	m»ûiveTime¡amp
;

70 
ušt8_t
 
	mûB™sHi¡
[
kRxHi¡ÜySize
];

72 
ušt32_t
 
	mrxTimeHi¡
[
kRxHi¡ÜySize
];

74 
ušt16_t
 
	m£qNrHi¡
[
kRxHi¡ÜySize
];

76 
ušt32_t
 
	mÏ¡F“dbackT_Áp
;

78 
	mnRSšûLa¡Rtı
;

80 
boŞ
 
	mfœ¡Reûived
;

82 
	mtimeSmpCÚv”siÚFaùÜ
;

84 
	mix
;

86 
	mnR•Ü‹dRPack‘s
;

95 
boŞ
 
checkIfFlushAck
();

100 
»ûive
(
ušt32_t
 
time_Áp
,

101 * 
¹pPack‘
,

102 
ušt32_t
 
s¤c
,

103 
size
,

104 
ušt16_t
 
£qNr
,

105 
ušt8_t
 
ûB™s
 = 0x00);

111 
boŞ
 
isF“dback
(
ušt32_t
 
time_Áp
);

116 
ušt32_t
 
g‘RtıFbIÁ”v®
();

125 
boŞ
 
ü—‹Snd¬dizedF“dback
(
ušt32_t
 
time_Áp
, boŞ 
isM¬k
, *
buf
, &
size
);

130 
ušt32_t
 
	$g‘La¡F“dbackT
(è{  
Ï¡F“dbackT_Áp
; 
	}
};

132 
ušt32_t
 
	gÏ¡F“dbackT_Áp
;

133 
	gby‹sReûived
;

134 
ušt32_t
 
	gÏ¡R©eCompu‹T_Áp
;

135 
	gav”ageReûivedR©e
;

136 
ušt32_t
 
	g¹ıFbIÁ”v®_Áp
;

137 
ušt32_t
 
	gs¤c
;

139 
g‘Ix
(
ušt32_t
 
s¤c
);

140 
	gix
;

141 
	gackDiff
;

143 
	gnR•Ü‹dRPack‘s
;

147 
	g¡d
::
li¡
<
SŒ—m
*> 
¡»ams
;

	@scream/code/ScreamTx.cpp

1 
	~"RQueue.h
"

2 
	~"Sü—mTx.h
"

3 #ifdeà
_MSC_VER


4 
	#NOMINMAX


	)

5 
	~<wšSock2.h
>

7 
	~<¬·/š‘.h
>

9 
	~<c¡dšt
>

10 
	~<cm©h
>

11 
	~<¡ršg.h
>

12 
	~<io¡»am
>

13 
	~<®gÜ™hm
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<m©h.h
>

19 #ifdeà
NO_LOG_TAG


20 cÚ¡ *
	glog_g
 = "scream_lib";

22 cÚ¡ *
	glog_g
 = "";

28 cÚ¡ 
boŞ
 
	gkEÇbËCÚ£cutiveFa¡S¹
 = 
Œue
;

30 cÚ¡ 
boŞ
 
	gkEÇbËPack‘Pacšg
 = 
Œue
;

33 cÚ¡ 
ušt32_t
 
	gkR©eAdju¡IÁ”v®_Áp
 = 1311;

37 cÚ¡ 
	gkMšPaûIÁ”v®
 = 0.000f;

38 cÚ¡ 
	gkMšimumBªdwidth
 = 5000.0f;

41 cÚ¡ 
	gkIn™Mss
 = 100;

44 cÚ¡ 
	gkQueueD–ayT¬g‘Max
 = 0.3f;

47 cÚ¡ 
	gkBy‹sInFlightHi¡IÁ”v®_Áp
 = 65536;

48 cÚ¡ 
	gkMaxBy‹sInFlightH—dRoom
 = 1.25f;

50 cÚ¡ 
ušt32_t
 
	gkQueueD–ayF¿ùiÚHi¡IÁ”v®_us
 = 3277;

52 cÚ¡ 
ušt32_t
 
	gkR©eUpd©eIÁ”v®_Áp
 = 3277;

55 cÚ¡ 
ušt32_t
 
	gkReÜd”time_Áp
 = 655;

56 cÚ¡ 
ušt32_t
 
	gkMšRQueueDisÿrdIÁ”v®_Áp
 = 16384;

59 cÚ¡ 
ušt32_t
 
	gkBa£D–ayUpd©eIÁ”v®_Áp
 = 655360;

62 cÚ¡ 
	gkL4sG
 = 0.125f;

65 cÚ¡ 
	gkL4sAÍhaMax
 = 1.0;

68 cÚ¡ 
	gkMšCwndMss
 = 3;

71 cÚ¡ 
ušt32_t
 
	gkMaxClockdriáCom³n§tiÚ
 = 33;

74 cÚ¡ 
	gkTimeSmpAtoSÿË
 = 1024;

75 cÚ¡ 
	gÁp2SecSÿËFaùÜ
 = 1.0 / 65536;

77 
	gSü—mTx
::
	$Sü—mTx
(
lossB‘a_
,

78 
eúCeB‘a_
,

79 
queueD–ayT¬g‘Mš_
,

80 
boŞ
 
’abËSbd_
,

81 
gašUp_
,

82 
gašDown_
,

83 
cwnd_
,

84 
·ck‘PacšgH—droom_
,

85 
by‹sInFlightHi¡Size_
,

86 
boŞ
 
isL4s_
,

87 
boŞ
 
İ’Wšdow_
,

88 
boŞ
 
’abËClockDriáCom³n§tiÚ_


90 
	`sR‰Sh_Áp
(0),

91 
	`lossB‘a
(
lossB‘a_
),

92 
	`eúCeB‘a
(
eúCeB‘a_
),

93 
	`queueD–ayT¬g‘Mš
(
queueD–ayT¬g‘Mš_
),

94 
	`’abËSbd
(
’abËSbd_
),

95 
	`gašUp
(
gašUp_
),

96 
	`gašDown
(
gašDown_
),

97 
	`·ck‘PacšgH—droom
(
·ck‘PacšgH—droom_
),

98 
	`by‹sInFlightHi¡Size
(
by‹sInFlightHi¡Size_
),

99 
	`isL4s
(
isL4s_
),

100 
	`İ’Wšdow
(
İ’Wšdow_
),

101 
	`’abËClockDriáCom³n§tiÚ
(
’abËClockDriáCom³n§tiÚ_
),

102 
	`sR‰_Áp
(0),

103 
	`sR‰
(0.0f),

104 
	`ackedOwd
(0),

105 
	`ba£Owd
(
UINT32_MAX
),

106 
	`queueD–ay
(0.0),

107 
	`queueD–ayF¿ùiÚAvg
(0.0),

108 
	`queueD–ayT»nd
(0.0),

109 
	`queueD–ayT¬g‘
(
queueD–ayT¬g‘Mš
),

110 
	`queueD–aySbdV¬
(0.0),

111 
	`queueD–aySbdM—n
(0.0),

112 
	`queueD–aySbdM—nSh
(0.0),

114 
	`by‹sNewlyAcked
(0),

115 
	`mss
(
kIn™Mss
),

116 
	`cwnd
(
kIn™Mss
 * 2),

117 
	`cwndMš
(
kIn™Mss
 * 2),

118 
	`cwndMšLow
(0),

119 
	`Ï¡By‹sInFlightT_Áp
(0),

120 
	`by‹sInFlightMaxLo
(0),

121 
	`by‹sInFlightMaxHi
(0),

122 
	`by‹sInFlightHi¡LoMem
(0),

123 
	`by‹sInFlightHi¡HiMem
(0),

124 
	`maxBy‹sInFlight
(0.0f),

126 
	`lossEv’t
(
çl£
),

127 
	`wasLossEv’t
(
çl£
),

128 
	`lossEv’tR©e
(0.0),

129 
	`eúCeEv’t
(
çl£
),

130 
	`isCeThisF“dback
(
çl£
),

131 
	`l4sAÍha
(0.1f),

132 
	`by‹sM¬kedThisR‰
(0),

133 
	`by‹sD–iv”edThisR‰
(0),

134 
	`Ï¡L4sAÍhaUpd©eT_Áp
(0),

135 
	`šFa¡S¹
(
Œue
),

136 
	`maxTÙ®B™¿‹
(0.0f),

137 
	`po¡CÚge¡iÚSÿË
(1.0f),

138 
	`po¡CÚge¡iÚD–ay
(0.1f),

139 
	`by‹sInFlightR©io
(0.0f),

141 
	`·ûIÁ”v®_Áp
(0),

142 
	`·ûIÁ”v®
(0.0),

143 
	`¿‹T¿nsm™‹dAvg
(0.0),

145 
	`isIn™Ÿlized
(
çl£
),

146 
	`Ï¡SR‰Upd©eT_Áp
(0),

147 
	`Ï¡Ba£OwdAddT_Áp
(0),

148 
	`ba£OwdRe£tT_Áp
(0),

149 
	`Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
(0),

150 
	`Ï¡LossEv’tT_Áp
(0),

151 
	`Ï¡T¿nsm™T_Áp
(0),

152 
	`ÃxtT¿nsm™T_Áp
(0),

153 
	`Ï¡R©eUpd©eT_Áp
(0),

154 
	`accBy‹sInFlightMax
(0),

155 
	`nAccBy‹sInFlightMax
(0),

156 
	`¿‹T¿nsm™‹d
(0.0f),

157 
	`¿‹Acked
(0.0f),

158 
	`¿‹R
(0.0f),

159 
	`queueD–ayT»ndMem
(0.0f),

160 
	`Ï¡CwndUpd©eT_Áp
(0),

161 
	`by‹sInFlight
(0),

162 
	`by‹sInFlightLog
(0),

163 
	`Ï¡Ba£D–ayReäeshT_Áp
(0),

164 
	`maxR©e
(0.0f),

165 
	`ba£OwdHi¡Mš
(
UINT32_MAX
),

166 
	`şockDriáCom³n§tiÚ
(0),

167 
	`şockDriáCom³n§tiÚInc
(0),

168 
	`’abËR©eUpd©e
(
Œue
),

170 
	`by‹sNewlyAckedLog
(0),

171 
	`eúCeM¬kedBy‹sLog
(0),

172 
	`isU£ExŒaD‘aedLog
(
çl£
),

173 
	`å_log
(0),

174 
	$com¶‘eLogI‹m
(
çl£
)

176 
	`¡rıy
(
d‘aedLogExŒaD©a
, "");

177 ià(
cwnd_
 == 0) {

178 
cwnd
 = 
kIn™Mss
 * 2;

181 
cwnd
 = 
cwnd_
;

183 ià(
İ’Wšdow
) {

184 
cwndMš
 = 10000000;

185 
cwnd
 = 
cwndMš
;

188 
n
 = 0;‚ < 
kBa£OwdHi¡Size
;‚++)

189 
ba£OwdHi¡
[
n
] = 
UINT32_MAX
;

190 
ba£OwdHi¡PŒ
 = 0;

191 
n
 = 0;‚ < 
kQueueD–ayF¿ùiÚHi¡Size
;‚++)

192 
queueD–ayF¿ùiÚHi¡
[
n
] = 0.0f;

193 
queueD–ayF¿ùiÚHi¡PŒ
 = 0;

194 
n
 = 0;‚ < 
kQueueD–ayNÜmHi¡Size
;‚++)

195 
queueD–ayNÜmHi¡
[
n
] = 0.0f;

196 
queueD–ayNÜmHi¡PŒ
 = 0;

197 
n
 = 0;‚ < 
kBy‹sInFlightHi¡SizeMax
;‚++) {

198 
by‹sInFlightHi¡Lo
[
n
] = 0;

199 
by‹sInFlightHi¡Hi
[
n
] = 0;

201 
by‹sInFlightHi¡PŒ
 = 0;

202 
nSŒ—ms
 = 0;

203 
n
 = 0;‚ < 
kMaxSŒ—ms
;‚++)

204 
¡»ams
[
n
] = 
NULL
;

206 
queueD–ayMax
 = 0.0f;

207 
queueD–ayMšAvg
 = 0.0f;

208 
queueD–ayMš
 = 1000.0;

210 
¡©i¡ics
 = 
Ãw
 
	`Sti¡ics
();

211 
	}
}

213 
	gSü—mTx
::~
	$Sü—mTx
() {

214 
n
 = 0;‚ < 
nSŒ—ms
;‚++)

215 
d–‘e
 
¡»ams
[
n
];

216 
d–‘e
 
¡©i¡ics
;

217 
	}
}

219 
	gSü—mTx
::
Sti¡ics
::
	$Sti¡ics
() {

220 
sumR©eTx
 = 0.0f;

221 
sumR©eLo¡
 = 0.0f;

222 
avgR©eTx
 = 0.0f;

223 
avgR‰
 = 0.0f;

224 
avgQueueD–ay
 = 0.0f;

225 
¿‹Lo¡Acc
 = 0.0f;

226 
¿‹Lo¡N
 = 0;

227 
n
 = 0;‚ < 
kLossR©eHi¡Size
;‚++) {

228 
lossR©eHi¡
[
n
] = 0.0f;

230 
lossR©eHi¡PŒ
 = 0;

231 
	}
}

233 
	gSü—mTx
::
Sti¡ics
::
	$add
(
¿‹Tx
, 
¿‹Lo¡
, 
¹t
, 
queueD–ay
) {

234 cÚ¡ 
®pha
 = 0.98f;

235 
sumR©eTx
 +ğ
¿‹Tx
;

236 
sumR©eLo¡
 +ğ
¿‹Lo¡
;

237 ià(
avgR©eTx
 == 0.0f) {

238 
avgR©eTx
 = 
¿‹Tx
;

239 
avgR‰
 = 
¹t
;

240 
avgQueueD–ay
 = 
queueD–ay
;

243 
avgR©eTx
 = 
®pha
 *‡vgR©eTx + (1.0à-‡Íha)*
¿‹Tx
;

244 
¿‹Lo¡Acc
 +ğ
¿‹Lo¡
;

245 
¿‹Lo¡N
++;

246 ià(
¿‹Lo¡N
 == 10) {

247 
¿‹Lo¡Acc
 /= 10;

248 
¿‹Lo¡N
 = 0;

249 
lossR©e
 = 0.0f;

250 ià(
¿‹Tx
 > 0)

251 
lossR©e
 = 
¿‹Lo¡Acc
 / 
¿‹Tx
 * 100.0f;

252 
lossR©eHi¡
[
lossR©eHi¡PŒ
] = 
lossR©e
;

253 
lossR©eHi¡PŒ
 = (lossR©eHi¡PŒ + 1è% 
kLossR©eHi¡Size
;

255 
avgR‰
 = 
®pha
 *‡vgR‰ + (1.0à-‡Íha)*
¹t
;

256 
avgQueueD–ay
 = 
®pha
 *‡vgQueueD–ay + (1.0à-‡Íha)*
queueD–ay
;

258 
	}
}

260 
	gSü—mTx
::
Sti¡ics
::
	$g‘Summ¬y
(
time
, 
s
[]) {

261 
lossR©e
 = 0.0f;

262 
n
 = 0;‚ < 
kLossR©eHi¡Size
;‚++)

263 
lossR©e
 +ğ
lossR©eHi¡
[
n
];

264 
lossR©e
 /ğ
kLossR©eHi¡Size
;

265 
lossR©eLÚg
 = 0.0f;

266 ià(
sumR©eTx
 > 100000.0f) {

267 
lossR©eLÚg
 = 
sumR©eLo¡
 / 
sumR©eTx
 * 100.0f;

269 
	`¥rštf
(
s
, "%s summary %5.1f Transmit„ate = %5.0fkbps, PLR = %5.2f%%(%5.2f%%), RTT = %5.3fs, Queue delay = %5.3fs",

270 
log_g
,

271 
time
,

272 
avgR©eTx
 / 1000.0f,

273 
lossR©e
,

274 
lossR©eLÚg
,

275 
avgR‰
,

276 
avgQueueD–ay
);

277 
	}
}

282 
	gSü—mTx
::
	$»gi¡”NewSŒ—m
(
RQueueIçû
 *
¹pQueue
,

283 
ušt32_t
 
s¤c
,

284 
´iÜ™y
,

285 
mšB™¿‹
,

286 
¡¬tB™¿‹
,

287 
maxB™¿‹
,

288 
¿mpUpS³ed
,

289 
¿mpUpSÿË
,

290 
maxRQueueD–ay
,

291 
txQueueSizeFaùÜ
,

292 
queueD–ayGu¬d
,

293 
lossEv’tR©eSÿË
,

294 
eúCeEv’tR©eSÿË
,

295 
boŞ
 
isAd­tiveT¬g‘R©eSÿË
,

296 
hy¡”esis
) {

297 
SŒ—m
 *
¡»am
 = 
Ãw
 
	`SŒ—m
(
this
,

298 
¹pQueue
,

299 
s¤c
,

300 
´iÜ™y
,

301 
mšB™¿‹
,

302 
¡¬tB™¿‹
,

303 
maxB™¿‹
,

304 
¿mpUpS³ed
,

305 
¿mpUpSÿË
,

306 
maxRQueueD–ay
,

307 
txQueueSizeFaùÜ
,

308 
queueD–ayGu¬d
,

309 
lossEv’tR©eSÿË
,

310 
eúCeEv’tR©eSÿË
,

311 
isAd­tiveT¬g‘R©eSÿË
,

312 
hy¡”esis
);

313 
¡»ams
[
nSŒ—ms
++] = 
¡»am
;

314 
	}
}

316 
	gSü—mTx
::
	$upd©eB™¿‹SŒ—m
(
ušt32_t
 
s¤c
,

317 
mšB™¿‹
,

318 
maxB™¿‹
) {

319 
id
;

320 
SŒ—m
 *
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
id
);

321 
¡»am
->
mšB™¿‹
 = minBitrate;

322 
¡»am
->
maxB™¿‹
 = maxBitrate;

323 
	}
}

325 
RQueueIçû
 * 
	gSü—mTx
::
	$g‘SŒ—mQueue
(
ušt32_t
 
s¤c
) {

326 
id
;

327 
SŒ—m
* 
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
id
);

328 ià(
¡»am
 == 0)

331  
¡»am
->
¹pQueue
;

332 
	}
}

338 
	gSü—mTx
::
	$ÃwMedŸF¿me
(
ušt32_t
 
time_Áp
, ušt32_ˆ
s¤c
, 
by‹sR
) {

339 ià(!
isIn™Ÿlized
è
	`š™Ÿlize
(
time_Áp
);

341 
id
;

342 
SŒ—m
 *
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
id
);

343 
¡»am
->
	`upd©eT¬g‘B™¿‹
(
time_Áp
);

344 ià(
time_Áp
 - 
Ï¡CwndUpd©eT_Áp
 < 32768) {

349 
¡»am
->
	`upd©eT¬g‘B™¿‹
(
time_Áp
);

351 ià(
time_Áp
 - 
Ï¡Ba£D–ayReäeshT_Áp
 < 
sR‰_Áp
 * 2) {

360 
cur_ş—»d
 = 
¡»am
->
¹pQueue
->
	`ş—r
();

361 ià(
cur_ş—»d
) {

362 
û¼
 << 
log_g
 << "„eäesh " << 
time_Áp
 / 65536.0à<< " RTP queu" << 
cur_ş—»d
 << "…ack‘e disÿrded fÜ SSRC " << 
s¤c
 << 
’dl
;

363 
¡»am
->
ş—»d
 +ğ
cur_ş—»d
;

367 
¡»am
->
by‹sR
 += bytesRtp;

368 
¡»am
->
·ck‘sR
++;

374 
sizeOfNextR
 = 
¡»am
->
¹pQueue
->
	`sizeOfNextR
();

375 
mss
 = 
¡d
::
	`max
(mss, 
sizeOfNextR
);

376 ià(!
İ’Wšdow
)

377 
cwndMš
 = 
¡d
::
	`max
(
cwndMšLow
, 2 * 
mss
);

378 
cwnd
 = 
	`max
(cwnd, 
cwndMš
);

380 
	}
}

385 
	gSü—mTx
::
	$isOkToT¿nsm™
(
ušt32_t
 
time_Áp
, ušt32_ˆ&
s¤c
) {

386 ià(!
isIn™Ÿlized
è
	`š™Ÿlize
(
time_Áp
);

394 
ušt32_t
 
tmp
 = 
kR©eUpd©eIÁ”v®_Áp
;

396 ià(
¿‹Acked
 < 50000.0f) {

397 
tmp
 *= 2;

400 ià(
time_Áp
 - 
Ï¡R©eUpd©eT_Áp
 > 
tmp
) {

401 
¿‹T¿nsm™‹d
 = 0.0f;

402 
¿‹Acked
 = 0.0f;

403 
¿‹R
 = 0.0f;

404 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

405 
¡»ams
[
n
]->
	`upd©eR©e
(
time_Áp
);

406 
¿‹T¿nsm™‹d
 +ğ
¡»ams
[
n
]->rateTransmitted;

407 
¿‹R
 +ğ
¡»ams
[
n
]->rateRtp;

408 
¿‹T¿nsm™‹dAvg
 = 0.9f*¿‹T¿nsm™‹dAvg + 0.1f*
¿‹T¿nsm™‹d
;

409 
¿‹Acked
 +ğ
¡»ams
[
n
]->rateAcked;

410 ià(
n
 == 0)

411 
¡©i¡ics
->
	`add
(
¡»ams
[0]->
¿‹T¿nsm™‹d
, sŒ—ms[0]->
¿‹Lo¡
, 
sR‰
, 
queueD–ay
);

413 
Ï¡R©eUpd©eT_Áp
 = 
time_Áp
;

417 
	`adju¡PriÜ™›s
(
time_Áp
);

422 
maxR©e
 = 0.0f;

423 
n
 = 0;‚ < 
nSŒ—ms
;‚++)

424 
maxR©e
 +ğ
¡»ams
[
n
]->
	`g‘MaxR©e
();

430 ià(
maxTÙ®B™¿‹
 > 0) {

431 
tmp
 = 
maxTÙ®B™¿‹
 * 0.9f;

432 ià(
¿‹R
 > 
tmp
) {

433 
šFa¡S¹
 = 
çl£
;

438 
d–
 = (
¿‹R
 - 
tmp
) /mp;

439 
d–
 /ğ
kR©eUpD©eSize
;

443 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

444 
SŒ—m
* 
¡»am
 = 
¡»ams
[
n
];

445 
¡»am
->
rg‘B™¿‹
 *ğ(1.0à- 
d–
);

446 
¡»am
->
rg‘B™¿‹I
 = 
¡»ams
[
n
]->
rg‘B™¿‹
;

447 
¡»am
->
Ï¡B™¿‹Adju¡T_Áp
 = 
time_Áp
;

456 
SŒ—m
* 
¡»am
 = 
	`g‘PriÜ™izedSŒ—m
(
time_Áp
);

458 ià(
¡»am
 =ğ
NULL
)

463 
s¤c
 = 
¡»am
->ssrc;

465 
by‹sInFlightMaxHi
 = 
¡d
::
	`max
(
by‹sInFlight
, bytesInFlightMaxHi);

470 ià(
time_Áp
 - 
Ï¡By‹sInFlightT_Áp
 > 
kBy‹sInFlightHi¡IÁ”v®_Áp
) {

471 
by‹sInFlightMaxLo
 = 0;

472 ià(
nAccBy‹sInFlightMax
 > 0) {

473 
by‹sInFlightMaxLo
 = 
accBy‹sInFlightMax
 / 
nAccBy‹sInFlightMax
;

475 
by‹sInFlightHi¡Lo
[
by‹sInFlightHi¡PŒ
] = 
by‹sInFlightMaxLo
;

476 
by‹sInFlightHi¡Hi
[
by‹sInFlightHi¡PŒ
] = 
by‹sInFlightMaxHi
;

477 
by‹sInFlightHi¡PŒ
 = (by‹sInFlightHi¡PŒ + 1è% 
by‹sInFlightHi¡Size
;

478 
Ï¡By‹sInFlightT_Áp
 = 
time_Áp
;

479 
accBy‹sInFlightMax
 = 0;

480 
nAccBy‹sInFlightMax
 = 0;

481 
by‹sInFlightMaxHi
 = 0;

482 
by‹sInFlightHi¡LoMem
 = 0;

483 
by‹sInFlightHi¡HiMem
 = 0;

484 
n
 = 0;‚ < 
by‹sInFlightHi¡Size
;‚++) {

485 
by‹sInFlightHi¡LoMem
 = 
¡d
::
	`max
(by‹sInFlightHi¡LoMem, 
by‹sInFlightHi¡Lo
[
n
]);

486 
by‹sInFlightHi¡HiMem
 = 
¡d
::
	`max
(by‹sInFlightHi¡HiMem, 
by‹sInFlightHi¡Hi
[
n
]);

494 
mss
 = 
kIn™Mss
;

495 ià(!
İ’Wšdow
)

496 
cwndMš
 = 
¡d
::
	`max
(
cwndMšLow
, 
kMšCwndMss
 * 
mss
);

497 
cwnd
 = 
	`max
(cwnd, 
cwndMš
);

503 
şockDriáCom³n§tiÚ
 +ğ
şockDriáCom³n§tiÚInc
;

506 
sizeOfNextR
 = 
¡»am
->
¹pQueue
->
	`sizeOfNextR
();

507 ià(
sizeOfNextR
 == -1) {

514 
boŞ
 
ex™
 = 
çl£
;

515 ià(
queueD–ay
 < 
queueD–ayT¬g‘
)

516 
ex™
 = (
by‹sInFlight
 + 
sizeOfNextR
è> 
cwnd
 + 
mss
;

518 
ex™
 = (
by‹sInFlight
 + 
sizeOfNextR
è> 
cwnd
;

522 
»tV®
 = 0.0f;

523 
ušt32_t
 
tmp_l
 = 
ÃxtT¿nsm™T_Áp
 - 
time_Áp
;

524 ià(
kEÇbËPack‘Pacšg
 && (
ÃxtT¿nsm™T_Áp
 > 
time_Áp
è&& (
tmp_l
 < 0xFFFF0000)) {

525 
»tV®
 = (
ÃxtT¿nsm™T_Áp
 - 
time_Áp
è* 
Áp2SecSÿËFaùÜ
;

531 ià(
time_Áp
 - 
Ï¡T¿nsm™T_Áp
 > 32768 &&†astTransmitT_ntp <ime_ntp) {

532 
n
 = 0;‚ < 
kMaxTxPack‘s
;‚++) {

533 
¡»am
->
txPack‘s
[
n
].
isU£d
 = 
çl£
;

535 
by‹sInFlight
 = 0;

536 
ex™
 = 
çl£
;

537 
»tV®
 = 0.0f;

540 ià(!
ex™
) {

544  
»tV®
;

548 
	}
}

553 
	gSü—mTx
::
	$addT¿nsm™‹d
(
ušt32_t
 
time_Áp
,

554 
ušt32_t
 
s¤c
,

555 
size
,

556 
ušt16_t
 
£qNr
,

557 
boŞ
 
isM¬k
) {

558 ià(!
isIn™Ÿlized
)

559 
	`š™Ÿlize
(
time_Áp
);

562 
id
;

563 
SŒ—m
 *
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
id
);

565 
ix
 = 
£qNr
 % 
kMaxTxPack‘s
;

566 
T¿nsm™‹d
 *
txPack‘
 = &(
¡»am
->
txPack‘s
[
ix
]);

567 
¡»am
->
hiSeqTx
 = 
£qNr
;

568 
txPack‘
->
timeTx_Áp
 = 
time_Áp
;

569 
txPack‘
->
size
 = size;

570 
txPack‘
->
£qNr
 = seqNr;

571 
txPack‘
->
isM¬k
 = isMark;

572 
txPack‘
->
isU£d
 = 
Œue
;

573 
txPack‘
->
isAcked
 = 
çl£
;

574 
txPack‘
->
isAá”ReûivedEdge
 = 
çl£
;

579 
by‹sInFlight
 +ğ
size
;

580 
by‹sInFlightLog
 = 
¡d
::
	`max
(by‹sInFlightLog, 
by‹sInFlight
);

582 
¡»am
->
by‹sT¿nsm™‹d
 +ğ
size
;

583 
Ï¡T¿nsm™T_Áp
 = 
time_Áp
;

584 
¡»am
->
Ï¡T¿nsm™T_Áp
 = 
time_Áp
;

588 
	`addC»d™
(
time_Áp
, 
¡»am
, 
size
);

592 
	`subŒaùC»d™
(
time_Áp
, 
¡»am
, 
size
);

597 
mss
 = 
¡d
::
	`max
(mss, 
size
);

598 ià(!
İ’Wšdow
)

599 
cwndMš
 = 
¡d
::
	`max
(
cwndMšLow
, 2 * 
mss
);

600 
cwnd
 = 
	`max
(cwnd, 
cwndMš
);

605 ià(
kEÇbËPack‘Pacšg
)

606 
ÃxtT¿nsm™T_Áp
 = 
time_Áp
 + 
·ûIÁ”v®_Áp
;

608 
ÃxtT¿nsm™T_Áp
 = 
time_Áp
;

609  
·ûIÁ”v®
;

610 
	}
}

613 
ušt32_t
 
	gunu£d
;

614 
ušt32_t
 
	gtime_Áp_´ev
 = 0;

615 
	gSü—mTx
::
	$šcomšgSnd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

616 * 
buf
,

617 
size
) {

619 ià(!
isIn™Ÿlized
è
	`š™Ÿlize
(
time_Áp
);

620 
±r
 = 2;

624 
ušt16_t
 
Ëngth
;

625 
	`memıy
(&
Ëngth
, 
buf
 + 
±r
, 2);

626 
Ëngth
 = 
	`Áohs
(length);

627 
±r
 += 2;

631 
ušt32_t
 
s¤c_¹ı
;

632 
	`memıy
(&
s¤c_¹ı
, 
buf
 + 
±r
, 4);

633 
s¤c_¹ı
 = 
	`Áohl
(ssrc_rtcp);

634 
±r
 += 4;

638 
ušt32_t
 
¹s
;

639 
	`memıy
(&
¹s
, 
buf
 + 
Ëngth
 * 4, 4);

640 
¹s
 = 
	`Áohl
(rts);

644 
±r
 !ğ
size
 - 4) {

648 
ušt32_t
 
s¤c
;

649 
	`memıy
(&
s¤c
, 
buf
 + 
±r
, 4);

650 
s¤c
 = 
	`Áohl
(ssrc);

651 
±r
 += 4;

655 
ušt16_t
 
begš_£q
, 
’d_£q
;

656 
ušt16_t
 
num_»pÜts
;

657 
	`memıy
(&
begš_£q
, 
buf
 + 
±r
, 2);

658 
±r
 += 2;

659 
	`memıy
(&
num_»pÜts
, 
buf
 + 
±r
, 2);

660 
±r
 += 2;

661 
begš_£q
 = 
	`Áohs
(begin_seq);

662 
num_»pÜts
 = 
	`Áohs
(num_reports) + 1;

663 
’d_£q
 = 
begš_£q
 + 
num_»pÜts
 - 1;

671 
¡»amId
 = -1;

672 
SŒ—m
 *
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
¡»amId
);

673 ià(
¡»am
 == 0) {

680 
ušt16_t
 
diff
 = 
’d_£q
 - 
¡»am
->
hiSeqAck
;

682 ià(
diff
 > 65000 && 
¡»am
->
hiSeqAck
 !ğ0 && sŒ—m->
timeTxAck_Áp
 != 0) {

688 
ušt32_t
 
size_befÜe
 = 
¡»am
->
¹pQueue
->
	`sizeOfQueue
();

689 
ušt16_t
 
N
 = 
’d_£q
 - 
begš_£q
;

691 
ušt16_t
 
nRx
 = 0;

692 
ušt16_t
 
fœ¡
 = 0;

693 
ušt16_t
 
Ï¡
 = 0;

694 
unu£d
 = 0;

695 
n
 = 0;‚ <ğ
N
;‚++) {

696 
ušt16_t
 
¢
 = 
begš_£q
 + 
n
;

697 
ušt16_t
 
tmp_s
;

698 
	`memıy
(&
tmp_s
, 
buf
 + 
±r
, 2);

699 
tmp_s
 = 
	`Áohs
(tmp_s);

700 
±r
 += 2;

701 
boŞ
 
isRx
 = ((
tmp_s
 & 0x8000) == 0x8000);

702 ià(
isRx
) {

703 ià(
fœ¡
 == 0) {

704 
fœ¡
 = 
n
;

706 
Ï¡
 = 
n
;

707 
nRx
++;

711 
ušt8_t
 
ûB™s
 = (
tmp_s
 & 0x6FFF) >> 13;

712 
ušt32_t
 
rxTime
 = (
tmp_s
 & 0x1FFF) << 6;

713 
rxTime
 = 
¹s
 -„xTime;

714 
	`šcomšgSnd¬dizedF“dback
(
time_Áp
, 
¡»amId
, 
rxTime
, 
¢
, 
ûB™s
, 
n
 =ğ
N
);

717 ià(
isU£ExŒaD‘aedLog
) {

718 
time_Áp
 =ime_ntp;

719 
¹pQueueD–ay
 = 
¡»am
->
¹pQueue
->
	`g‘D–ay
(
time_Áp
 * 
Áp2SecSÿËFaùÜ
);

720 
La¡
 = 
¡»am
->
¹pQueue
->
	`£qNrOfLa¡R
();

721 
·k_diff
 = (
La¡
 =ğ-1è? -1 : ((La¡ >ğ
¡»am
->
hiSeqTx
 ) ? (Last - stream->hiSeqTx ) : Last + 0xffff - stream->hiSeqTx);

722 
	`´štf
("%s diff %d %6u %u beg_seq %u‚um_reps %uƒnd_seq %u‚Rx %u unused %u sQ %d first %u†ast %u NrNext %d Last %d hiSeqTx %u hiSeqAck %u…acketsRtp %lu„tpQueueDelay %f sRtt %f\n",

723 
log_g
, 
·k_diff
,

724 
time_Áp
 - 
time_Áp_´ev
,ime_Áp, 
begš_£q
, 
num_»pÜts
, 
’d_£q
, 
nRx
, 
unu£d
, 
size_befÜe
,

725 
fœ¡
, 
Ï¡
, 
¡»am
->
¹pQueue
->
	`£qNrOfNextR
(), 
La¡
,

726 
¡»am
->
hiSeqTx
, sŒ—m->
hiSeqAck
, sŒ—m->
·ck‘sR
, 
¹pQueueD–ay
, 
sR‰
);

727 
time_Áp_´ev
 = 
time_Áp
;

732 ià((
N
 + 1) % 2 == 1) {

733 
±r
 += 2;

736 
	}
}

741 
	gSü—mTx
::
	$šcomšgSnd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

742 
¡»amId
,

743 
ušt32_t
 
time¡amp
,

744 
ušt16_t
 
£qNr
,

745 
ušt8_t
 
ûB™s
,

746 
boŞ
 
isLa¡
) {

748 
SŒ—m
 *
¡»am
 = 
¡»ams
[
¡»amId
];

749 
accBy‹sInFlightMax
 +ğ
by‹sInFlight
;

750 
nAccBy‹sInFlightMax
++;

751 
T¿nsm™‹d
 *
txPack‘s
 = 
¡»am
->txPackets;

752 
com¶‘eLogI‹m
 = 
çl£
;

753 
´evBy‹sInFlight
 = 
by‹sInFlight
;

757 
boŞ
 
isM¬k
 = 
çl£
;

758 
isCeThisF“dback
 |ğ
	`m¬kAcked
(
time_Áp
, 
txPack‘s
, 
£qNr
, 
time¡amp
, 
¡»am
, 
ûB™s
, 
eúCeM¬kedBy‹sLog
, 
isLa¡
, 
isM¬k
);

763 ià(
isU£ExŒaD‘aedLog
 || 
isLa¡
 || 
isM¬k
) {

764 
	`d‘eùLoss
(
time_Áp
, 
txPack‘s
, 
£qNr
, 
¡»am
);

767 ià(
isLa¡
) {

768 ià(
isCeThisF“dback
 && 
time_Áp
 - 
Ï¡LossEv’tT_Áp
 > 
sR‰_Áp
) {

769 
eúCeEv’t
 = 
Œue
;

770 
Ï¡LossEv’tT_Áp
 = 
time_Áp
;

772 
isCeThisF“dback
 = 
çl£
;

773 ià(
isL4s
) {

778 ià(
time_Áp
 - 
Ï¡L4sAÍhaUpd©eT_Áp
 > 
sR‰_Áp
) {

779 
Ï¡L4sAÍhaUpd©eT_Áp
 = 
time_Áp
;

780 ià(
by‹sD–iv”edThisR‰
 > 0) {

781 
F
 = (
by‹sM¬kedThisR‰
è/ (
by‹sD–iv”edThisR‰
);

789 
l4sAÍha
 = 
¡d
::
	`mš
(
kL4sAÍhaMax
, 
kL4sG
 * 
F
 + (1.0f - kL4sG)*l4sAlpha);

790 
by‹sD–iv”edThisR‰
 = 0;

791 
by‹sM¬kedThisR‰
 = 0;

796 ià(
lossEv’t
 || 
eúCeEv’t
) {

797 
Ï¡LossEv’tT_Áp
 = 
time_Áp
;

798 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

799 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

800 ià(
lossEv’t
)

801 
tmp
->
lossEv’tFÏg
 = 
Œue
;

803 
tmp
->
eúCeEv’tFÏg
 = 
Œue
;

807 ià(
Ï¡CwndUpd©eT_Áp
 == 0)

808 
Ï¡CwndUpd©eT_Áp
 = 
time_Áp
;

810 ià(
time_Áp
 - 
Ï¡CwndUpd©eT_Áp
 > 655) {

815 
by‹sInFlightR©io
 = 
¡d
::
	`mš
(1.0f,(
´evBy‹sInFlight
è/ 
cwnd
);

816 
	`upd©eCwnd
(
time_Áp
);

817 
Ï¡CwndUpd©eT_Áp
 = 
time_Áp
;

821 ià(
isU£ExŒaD‘aedLog
 || 
isLa¡
 || 
isM¬k
) {

822 ià(
å_log
 && 
com¶‘eLogI‹m
) {

823 
	`årštf
(
å_log
, " %d,%d,%d,%1.0f,%d,%d,%d,%d,%1.0f,%1.0f,%1.0f,%1.0f,%1.0f,%d",

824 
cwnd
, 
by‹sInFlight
, 
šFa¡S¹
, 
¿‹T¿nsm™‹d
, 
¡»amId
, 
£qNr
, 
by‹sNewlyAckedLog
, 
eúCeM¬kedBy‹sLog
, 
¡»am
->
¿‹R
, sŒ—m->¿‹T¿nsm™‹d, sŒ—m->
¿‹Acked
, sŒ—m->
¿‹Lo¡
, sŒ—m->
¿‹Ce
, 
isM¬k
);

825 ià(
	`¡¾’
(
d‘aedLogExŒaD©a
) > 0) {

826 
	`årštf
(
å_log
, ",%s", 
d‘aedLogExŒaD©a
);

828 
by‹sNewlyAckedLog
 = 0;

829 
eúCeM¬kedBy‹sLog
 = 0;

831 ià(
å_log
 && 
com¶‘eLogI‹m
) {

832 
	`årštf
(
å_log
, "\n");

836 
	}
}

841 
boŞ
 
	gSü—mTx
::
	$m¬kAcked
(
ušt32_t
 
time_Áp
,

842 
T¿nsm™‹d
 *
txPack‘s
,

843 
ušt16_t
 
£qNr
,

844 
ušt32_t
 
time¡amp
,

845 
SŒ—m
 *
¡»am
,

846 
ušt8_t
 
ûB™s
,

847 &
’cCeM¬kedBy‹sLog
,

848 
boŞ
 
isLa¡
,

849 
boŞ
 &
isM¬k
) {

851 
boŞ
 
isCe
 = 
çl£
;

852 
ix
 = 
£qNr
 % 
kMaxTxPack‘s
;

853 ià(
txPack‘s
[
ix
].
isU£d
) {

857 
T¿nsm™‹d
 *
tmp
 = &
txPack‘s
[
ix
];

862 ià((
tmp
->
£qNr
 =ğ£qNrè& !tmp->
isAcked
) {

863 
by‹sD–iv”edThisR‰
 +ğ
tmp
->
size
;

864 
isM¬k
 = 
tmp
->isMark;

865 ià(
ûB™s
 == 0x03) {

869 
’cCeM¬kedBy‹sLog
 +ğ
tmp
->
size
;

870 
by‹sM¬kedThisR‰
 +ğ
tmp
->
size
;

871 
¡»am
->
by‹sCe
 +ğ
tmp
->
size
;

872 
¡»am
->
·ck‘sCe
++;

873 
isCe
 = 
Œue
;

875 
tmp
->
isAcked
 = 
Œue
;

876 
ackedOwd
 = 
time¡amp
 - 
tmp
->
timeTx_Áp
;

881 
	`e¡im©eOwd
(
time_Áp
);

885 
ackedOwd
 -ğ
şockDriáCom³n§tiÚ
;

887 
ušt32_t
 
qD–
 = 
ackedOwd
 - 
	`g‘Ba£Owd
();

889 ià(
qD–
 > 0xFFFF0000 && 
şockDriáCom³n§tiÚ
 != 0) {

894 
ušt32_t
 
diff
 = 0 - 
qD–
;

895 
şockDriáCom³n§tiÚ
 -ğ
diff
;

896 
qD–
 = 0;

899 ià(
qD–
 > 0xFFFF0000 || 
şockDriáCom³n§tiÚ
 > 0xFFFF0000) {

904 
şockDriáCom³n§tiÚ
 = 0;

905 
şockDriáCom³n§tiÚInc
 = 0;

906 
queueD–ayMšAvg
 = 0.0f;

907 
queueD–ay
 = 0.0f;

908 
n
 = 0;‚ < 
kBa£OwdHi¡Size
;‚++)

909 
ba£OwdHi¡
[
n
] = 
UINT32_MAX
;

910 
ba£Owd
 = 
UINT32_MAX
;

911 
ba£OwdHi¡Mš
 = 
UINT32_MAX
;

912 
ba£OwdRe£tT_Áp
 = 
time_Áp
;

913 
qD–
 = 0;

919 
queueD–ay
 = 
qD–
 * 
Áp2SecSÿËFaùÜ
;

921 
ušt32_t
 
¹t
 = 
time_Áp
 - 
tmp
->
timeTx_Áp
;

923 ià(
å_log
 && (
isU£ExŒaD‘aedLog
 || 
isLa¡
 || 
isM¬k
)) {

924 
	`årštf
(
å_log
, "%s,%1.4f,%1.4f,", 
timeSŒšg
, 
queueD–ay
, 
¹t
*
Áp2SecSÿËFaùÜ
);

925 
com¶‘eLogI‹m
 = 
Œue
;

927 ià(
¹t
 < 1000000 && 
isLa¡
) {

928 
sR‰Sh_Áp
 = (7 * sR‰Sh_Á°+ 
¹t
) / 8;

929 ià(
time_Áp
 - 
Ï¡SR‰Upd©eT_Áp
 > 
sR‰Sh_Áp
) {

930 
sR‰_Áp
 = (7 * sR‰_Á°+ 
sR‰Sh_Áp
) / 8;

931 
Ï¡SR‰Upd©eT_Áp
 = 
time_Áp
;

932 
sR‰
 = 
sR‰_Áp
 * 
Áp2SecSÿËFaùÜ
;

935 
¡»am
->
timeTxAck_Áp
 = 
tmp
->
timeTx_Áp
;

938 
unu£d
++;

940  
isCe
;

941 
	}
}

946 
	gSü—mTx
::
	$d‘eùLoss
(
ušt32_t
 
time_Áp
, 
T¿nsm™‹d
 *
txPack‘s
, 
ušt16_t
 
highe¡SeqNr
, 
SŒ—m
 *
¡»am
) {

951 
ix1
 = 
highe¡SeqNr
; ix1 = ix1 % 
kMaxTxPack‘s
;

952 
ix0
 = 
¡»am
->
hiSeqAck
 - 256;

953 
¡»am
->
hiSeqAck
 = 
highe¡SeqNr
;

954 ià(
ix0
 < 0èix0 +ğ
kMaxTxPack‘s
;

955 
ix1
 < 
ix0
)

956 
ix1
 +ğ
kMaxTxPack‘s
;

961 
m
 = 
ix0
; m <ğ
ix1
; m++) {

962 
n
 = 
m
 % 
kMaxTxPack‘s
;

966 ià(
txPack‘s
[
n
].
isU£d
) {

967 
T¿nsm™‹d
 *
tmp
 = &
txPack‘s
[
n
];

974 
ušt32_t
 
£qNrExt
 = 
tmp
->
£qNr
;

975 
ušt32_t
 
highe¡SeqNrExt
 = 
highe¡SeqNr
;

976 ià(
£qNrExt
 < 
highe¡SeqNrExt
 && highestSeqNrExt - seqNrExt > 20000)

977 
£qNrExt
 += 65536;

978 ià(
£qNrExt
 > 
highe¡SeqNrExt
 && seqNrExt - highestSeqNrExt > 20000)

979 
highe¡SeqNrExt
 += 65536;

988 ià(
£qNrExt
 <ğ
highe¡SeqNrExt
 && 
tmp
->
isAá”ReûivedEdge
 =ğ
çl£
) {

989 
by‹sNewlyAcked
 +ğ
tmp
->
size
;

990 
by‹sNewlyAckedLog
 +ğ
tmp
->
size
;

991 
by‹sInFlight
 -ğ
tmp
->
size
;

992 ià(
by‹sInFlight
 < 0)

993 
by‹sInFlight
 = 0;

994 
¡»am
->
by‹sAcked
 +ğ
tmp
->
size
;

995 
tmp
->
isAá”ReûivedEdge
 = 
Œue
;

998 ià(
tmp
->
timeTx_Áp
 + 
kReÜd”time_Áp
 < 
¡»am
->
timeTxAck_Áp
 && !tmp->
isAcked
) {

1003 ià(
time_Áp
 - 
Ï¡LossEv’tT_Áp
 > 
sR‰_Áp
 && 
lossB‘a
 < 1.0f) {

1004 
lossEv’t
 = 
Œue
;

1006 
¡»am
->
by‹sLo¡
 +ğ
tmp
->
size
;

1007 
¡»am
->
·ck‘Lo¡
++;

1008 
tmp
->
isU£d
 = 
çl£
;

1009 
û¼
 << 
log_g
 << " LOSS d‘eùed by„eÜd”im” SSRC=" << 
¡»am
->
s¤c
 << " SN=" << 
tmp
->
£qNr
 << 
’dl
;

1010 
¡»am
->
»·œLoss
 = 
Œue
;

1012 ià(
tmp
->
isAcked
) {

1013 
tmp
->
isU£d
 = 
çl£
;

1017 
	}
}

1019 
	gSü—mTx
::
	$g‘T¬g‘B™¿‹
(
ušt32_t
 
s¤c
) {

1020 
id
;

1021  
	`g‘SŒ—m
(
s¤c
, 
id
)->
	`g‘T¬g‘B™¿‹
();

1022 
	}
}

1024 
	gSü—mTx
::
	$£tT¬g‘PriÜ™y
(
ušt32_t
 
s¤c
, 
´iÜ™y
) {

1025 
id
;

1026 
SŒ—m
 *
¡»am
 = 
	`g‘SŒ—m
(
s¤c
, 
id
);

1027 ià(
queueD–ayF¿ùiÚAvg
 > 0.1 || !
šFa¡S¹
) {

1028 
¡»am
->
rg‘B™¿‹
 *ğ
´iÜ™y
 / sŒ—m->
rg‘PriÜ™y
;

1029 
¡»am
->
rg‘B™¿‹
 = 
¡d
::
	`mš
(¡d::
	`max
(¡»am->rg‘B™¿‹, sŒ—m->
mšB™¿‹
), sŒ—m->
maxB™¿‹
);

1031 
¡»am
->
rg‘PriÜ™y
 = 
´iÜ™y
;

1032 
¡»am
->
rg‘PriÜ™yInv
 = 1.0à/ 
´iÜ™y
;

1033 
	}
}

1035 
	gSü—mTx
::
	$g‘LogH—d”
(*
s
) {

1036 
	`¥rštf
(
s
,

1038 
	}
}

1040 
	gSü—mTx
::
	$g‘Log
(
time
, *
s
, 
boŞ
 
ş—r
) {

1041 
šFlightMax
 = 
¡d
::
	`max
(
by‹sInFlight
, 
by‹sInFlightHi¡HiMem
);

1042 
	`¥rštf
(
s
, "%s Log, %4.3f, %4.3f, %4.3f, %4.3f, %6d, %6d, %6.0f, %1d, ",

1043 
log_g
, 
queueD–ay
, 
queueD–ayMax
, 
queueD–ayMšAvg
, 
sR‰
,

1044 
cwnd
, 
by‹sInFlightLog
, 
¿‹T¿nsm™‹d
 / 1000.0f, 
	`isInFa¡S¹
());

1045 
by‹sInFlightLog
 = 
by‹sInFlight
;

1046 
queueD–ayMax
 = 0.0;

1047 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1048 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1049 
s2
[200];

1050 
	`¥rštf
(
s2
, "%4.3f, %d,%d,%6.0f, %6.0f, %lu, %6.0f, %6.0f, %5.0f, %5.0f, %lu, %5d, %lu,%lu",

1051 
¡d
::
	`max
(0.0f, 
tmp
->
¹pQueue
->
	`g‘D–ay
(
time
)),

1052 
tmp
->
¹pQueue
->
	`by‹sInQueue
(),

1053 
tmp
->
¹pQueue
->
	`sizeOfQueue
(),

1054 
tmp
->
rg‘B™¿‹
 / 1000.0f,mp->
¿‹R
 / 1000.0f,

1055 
tmp
->
·ck‘sR
,

1056 
tmp
->
¿‹T¿nsm™‹d
 / 1000.0f,mp->
¿‹Acked
 / 1000.0f,

1057 
tmp
->
¿‹Lo¡
 / 1000.0f,mp->
¿‹Ce
 / 1000.0f,

1058 
tmp
->
·ck‘sCe
,

1059 
tmp
->
hiSeqAck
,

1060 
tmp
->
ş—»d
,mp->
·ck‘Lo¡
);

1061 
	`¡rÿt
(
s
, 
s2
);

1062 ià(
ş—r
) {

1063 
tmp
->
·ck‘sR
 = 0;

1064 
tmp
->
·ck‘sCe
 = 0;

1065 
tmp
->
ş—»d
 = 0;

1066 
tmp
->
·ck‘Lo¡
 = 0;

1070 
	}
}

1072 
	gSü—mTx
::
	$g‘ShÜtLog
(
time
, *
s
) {

1073 
šFlightMax
 = 
¡d
::
	`max
(
by‹sInFlight
, 
by‹sInFlightHi¡HiMem
);

1074 
	`¥rštf
(
s
, "%s %4.3f, %4.3f, %6d, %6d, %6.0f, %1d, ",

1075 
log_g
, 
queueD–ay
, 
sR‰
,

1076 
cwnd
, 
by‹sInFlightLog
, 
¿‹T¿nsm™‹d
 / 1000.0f, 
	`isInFa¡S¹
());

1077 
by‹sInFlightLog
 = 
by‹sInFlight
;

1078 
queueD–ayMax
 = 0.0;

1079 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1080 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1081 
s2
[200];

1082 
	`¥rštf
(
s2
, "%4.3f, %6.0f, %6.0f, %6.0f, %5.0f, %5.0f,",

1083 
¡d
::
	`max
(0.0f, 
tmp
->
¹pQueue
->
	`g‘D–ay
(
time
)),

1084 
tmp
->
rg‘B™¿‹
 / 1000.0f,mp->
¿‹R
 / 1000.0f,

1085 
tmp
->
¿‹T¿nsm™‹d
 / 1000.0f,

1086 
tmp
->
¿‹Lo¡
 / 1000.0f,mp->
¿‹Ce
 / 1000.0f);

1087 
	`¡rÿt
(
s
, 
s2
);

1089 
	}
}

1091 
	gSü—mTx
::
	$g‘V”yShÜtLog
(
time
, *
s
) {

1092 
šFlightMax
 = 
¡d
::
	`max
(
by‹sInFlight
, 
by‹sInFlightHi¡HiMem
);

1093 
	`¥rštf
(
s
, "%s %4.3f, %4.3f, %6d, %6d, %6.0f, ",

1094 
log_g
, 
queueD–ay
, 
sR‰
,

1095 
cwnd
, 
by‹sInFlightLog
, 
¿‹T¿nsm™‹d
 / 1000.0f);

1096 
by‹sInFlightLog
 = 
by‹sInFlight
;

1097 
queueD–ayMax
 = 0.0;

1098 
n
 = 0;‚ < 1;‚++) {

1099 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1100 
s2
[200];

1101 
	`¥rštf
(
s2
, "%5.0f, %5.0f, ",

1102 
tmp
->
¿‹Lo¡
 / 1000.0f,mp->
¿‹Ce
 / 1000.0f);

1103 
	`¡rÿt
(
s
, 
s2
);

1105 
	}
}

1107 
	gSü—mTx
::
	$g‘Sti¡ics
(
time
, *
s
) {

1108 
¡©i¡ics
->
	`g‘Summ¬y
(
time
, 
s
);

1109 
	}
}

1111 
	gSü—mTx
::
	$g‘Qu®™yIndex
(
time
, 
th»shŞdR©e
, 
¹tMš
) {

1119 
qu®™yIndex
 = 
¡d
::
	`max
(0.0f, std::
	`mš
(1.0f, (
¿‹T¿nsm™‹d
 - 
th»shŞdR©e
 * 0.1f) / (thresholdRate*0.9f)));

1120 
qu®™yIndex
 *ğ
¡d
::
	`max
(0.0f, (0.1à- 
¡»ams
[0]->
¹pQueue
->
	`g‘D–ay
(
time
)) / 0.1f);

1121 
qu®™yIndex
 *ğ
¡d
::
	`max
(0.0f, std::
	`mš
(1.0f, (4 * 
¹tMš
 - (
sR‰
 -„ttMin)) / (4 *„ttMin)));

1122  
qu®™yIndex
 * 100.0f;

1123 
	}
}

1125 
boŞ
 
	gSü—mTx
::
	$isLossEpoch
(
ušt32_t
 
s¤c
) {

1126 
id
;

1127  
	`g‘SŒ—m
(
s¤c
, 
id
)->
	`isLossEpoch
();

1128 
	}
}

1130 
	gSü—mTx
::
	$š™Ÿlize
(
ušt32_t
 
time_Áp
) {

1131 
isIn™Ÿlized
 = 
Œue
;

1132 
Ï¡SR‰Upd©eT_Áp
 = 
time_Áp
;

1133 
Ï¡Ba£OwdAddT_Áp
 = 
time_Áp
;

1134 
ba£OwdRe£tT_Áp
 = 
time_Áp
;

1135 
Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
 = 
time_Áp
;

1136 
Ï¡LossEv’tT_Áp
 = 
time_Áp
;

1137 
Ï¡T¿nsm™T_Áp
 = 
time_Áp
;

1138 
ÃxtT¿nsm™T_Áp
 = 
time_Áp
;

1139 
Ï¡R©eUpd©eT_Áp
 = 
time_Áp
;

1140 
Ï¡Adju¡PriÜ™›sT_Áp
 = 
time_Áp
;

1141 
Ï¡R‰T_Áp
 = 
time_Áp
;

1142 
Ï¡Ba£D–ayReäeshT_Áp
 = 
time_Áp
 - 1;

1143 
Ï¡L4sAÍhaUpd©eT_Áp
 = 
time_Áp
;

1144 
š™Time_Áp
 = 
time_Áp
;

1145 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 0;

1146 
	}
}

1148 
	gSü—mTx
::
	$g‘TÙ®T¬g‘B™¿‹
() {

1149 
tÙ®T¬g‘B™¿‹
 = 0.0f;

1150 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1151 
tÙ®T¬g‘B™¿‹
 +ğ
¡»ams
[
n
]->
rg‘B™¿‹
;

1153  
tÙ®T¬g‘B™¿‹
;

1154 
	}
}

1159 
	gSü—mTx
::
	$upd©eCwnd
(
ušt32_t
 
time_Áp
) {

1160 
dT
 = 0.001f;

1161 ià(
Ï¡CwndUpd©eT_Áp
 == 0)

1162 
Ï¡CwndUpd©eT_Áp
 = 
time_Áp
;

1164 
dT
 = (
time_Áp
 - 
Ï¡CwndUpd©eT_Áp
è* 
Áp2SecSÿËFaùÜ
;

1172 
by‹sNewlyAckedLim™ed
 = (
by‹sNewlyAcked
);

1173 ià(
maxR©e
 > 1.0e5f)

1174 
by‹sNewlyAckedLim™ed
 = 
¡d
::
	`mš
(by‹sNewlyAckedLim™ed, 1.25f*
maxR©e
*
dT
 / 8.0f);

1176 
by‹sNewlyAckedLim™ed
 = 2.0f*
mss
;

1178 
queueD–ayMš
 = 
¡d
::
	`mš
(queueD–ayMš, 
queueD–ay
);

1180 
queueD–ayMax
 = 
¡d
::
	`max
(queueD–ayMax, 
queueD–ay
);

1182 
time
 = 
time_Áp
 * 
Áp2SecSÿËFaùÜ
;

1183 ià(
queueD–ayMšAvg
 > 0.25f*
queueD–ayT¬g‘
 && 
time_Áp
 - 
ba£OwdRe£tT_Áp
 > 1310720) {

1188 
şockDriáCom³n§tiÚ
 = 0;

1189 
şockDriáCom³n§tiÚInc
 = 0;

1190 
queueD–ayMšAvg
 = 0.0f;

1191 
queueD–ay
 = 0.0f;

1192 
n
 = 0;‚ < 
kBa£OwdHi¡Size
;‚++)

1193 
ba£OwdHi¡
[
n
] = 
UINT32_MAX
;

1194 
ba£Owd
 = 
UINT32_MAX
;

1195 
ba£OwdHi¡Mš
 = 
UINT32_MAX
;

1196 
ba£OwdRe£tT_Áp
 = 
time_Áp
;

1203 
queueD–ayF¿ùiÚAvg
 = 0.9f*queueD–ayF¿ùiÚAvg + 0.1f*
	`g‘QueueD–ayF¿ùiÚ
();

1212 ià((
time_Áp
 - 
Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
) >

1213 
kQueueD–ayF¿ùiÚHi¡IÁ”v®_us
) {

1220 
·ûIÁ”v®
 = 
kMšPaûIÁ”v®
;

1221 ià((
queueD–ayF¿ùiÚAvg
 > 0.02à|| 
isL4s
 || 
maxTÙ®B™¿‹
 > 0è&& 
kEÇbËPack‘Pacšg
) {

1222 
h—dRoom
 = 
·ck‘PacšgH—droom
;

1223 ià(
Ï¡CÚge¡iÚD‘eùedT_Áp
 == 0) {

1228 
h—dRoom
 = 
¡d
::
	`max
(headRoom,1.5f);

1230 
·cšgB™¿‹
 = 
¡d
::
	`max
(
	`g‘TÙ®T¬g‘B™¿‹
(), 
¿‹R
);

1231 
·cšgB™¿‹
 = 
¡d
::
	`max
(1.0e5f, 
h—dRoom
*pacingBitrate);

1232 ià(
maxTÙ®B™¿‹
 > 0) {

1233 
·cšgB™¿‹
 = 
¡d
::
	`mš
ÕacšgB™¿‹, 
maxTÙ®B™¿‹
);

1235 

 = (
mss
 * 8.0fè/ 
·cšgB™¿‹
;

1236 
·ûIÁ”v®
 = 
¡d
::
	`max
(
kMšPaûIÁ”v®
, 

);

1238 
·ûIÁ”v®_Áp
 = (
ušt32_t
)(
·ûIÁ”v®
 * 65536);

1240 ià(
queueD–ayMš
 < 
queueD–ayMšAvg
)

1241 
queueD–ayMšAvg
 = 
queueD–ayMš
;

1243 
queueD–ayMšAvg
 = 0.001f*
queueD–ayMš
 + 0.999f*queueDelayMinAvg;

1244 
queueD–ayMš
 = 1000.0f;

1248 
nI‹r
 = ()(
time_Áp
 - 
Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
è/ 
kQueueD–ayF¿ùiÚHi¡IÁ”v®_us
;

1249 
n
 = 0;‚ < 
nI‹r
;‚++) {

1250 
queueD–ayF¿ùiÚHi¡
[
queueD–ayF¿ùiÚHi¡PŒ
] = 
	`g‘QueueD–ayF¿ùiÚ
();

1251 
queueD–ayF¿ùiÚHi¡PŒ
 = (queueD–ayF¿ùiÚHi¡PŒ + 1è% 
kQueueD–ayF¿ùiÚHi¡Size
;

1254 ià(
time_Áp
 - 
š™Time_Áp
 > 131072) {

1258 
	`compu‹QueueD–ayT»nd
();

1261 
queueD–ayT»ndMem
 = 
¡d
::
	`max
(queueD–ayT»ndMem*0.98f, 
queueD–ayT»nd
);

1266 
maxBy‹sInFlightHi
 = ()(
¡d
::
	`max
(
by‹sInFlightMaxHi
, 
by‹sInFlightHi¡HiMem
));

1267 
maxBy‹sInFlightLo
 = ()(
¡d
::
	`max
(
by‹sInFlight
, 
by‹sInFlightHi¡LoMem
));

1269 
maxBy‹sInFlight
 =

1270 (
maxBy‹sInFlightHi
*(1.0à- 
queueD–ayT»nd
è+ 
maxBy‹sInFlightLo
 * queueDelayTrend)*

1271 
kMaxBy‹sInFlightH—dRoom
;

1272 ià(
’abËSbd
) {

1276 
queueD–ayNÜm
 = 
queueD–ay
 / 
queueD–ayT¬g‘Mš
;

1277 
queueD–ayNÜmHi¡
[
queueD–ayNÜmHi¡PŒ
] = 
queueD–ayNÜm
;

1278 
queueD–ayNÜmHi¡PŒ
 = (queueD–ayNÜmHi¡PŒ + 1è% 
kQueueD–ayNÜmHi¡Size
;

1283 
	`compu‹Sbd
();

1288 
oh
 = 
queueD–ayT¬g‘Mš
 * (
queueD–aySbdM—nSh
 + 
	`sq¹
(
queueD–aySbdV¬
));

1289 ià(
lossEv’tR©e
 > 0.002 && 
queueD–aySbdM—nSh
 > 0.5 && 
queueD–aySbdV¬
 < 0.2) {

1290 
queueD–ayT¬g‘
 = 
¡d
::
	`mš
(
kQueueD–ayT¬g‘Max
, 
oh
*1.5f);

1293 ià(
queueD–aySbdV¬
 < 0.2 && 
queueD–aySbdSkew
 < 0.05) {

1294 
queueD–ayT¬g‘
 = 
¡d
::
	`max
(
queueD–ayT¬g‘Mš
, std::
	`mš
(
kQueueD–ayT¬g‘Max
, 
oh
));

1297 ià(
oh
 < 
queueD–ayT¬g‘
)

1298 
queueD–ayT¬g‘
 = 
¡d
::
	`max
(
queueD–ayT¬g‘Mš
, std::max(queueD–ayT¬g‘*0.99f, 
oh
));

1300 
queueD–ayT¬g‘
 = 
¡d
::
	`max
(
queueD–ayT¬g‘Mš
, queueDelayTarget*0.999f);

1304 
Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
 = 
time_Áp
;

1309 
offT¬g‘
 = (
queueD–ayT¬g‘
 - 
queueD–ay
) / (queueDelayTarget);

1311 ià(
lossEv’t
) {

1315 
cwnd
 = 
¡d
::
	`max
(
cwndMš
, ()(
lossB‘a
*cwnd));

1316 
lossEv’t
 = 
çl£
;

1317 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 
time_Áp
;

1319 
šFa¡S¹
 = 
çl£
;

1320 
wasLossEv’t
 = 
Œue
;

1321 
po¡CÚge¡iÚSÿË
 = 0.0;

1323 ià(
eúCeEv’t
) {

1327 ià(
isL4s
) {

1328 
cwnd
 = 
¡d
::
	`max
(
cwndMš
, ()((1.0à- 
l4sAÍha
/(2.0*
·ck‘PacšgH—droom
))*cwnd));

1331 
cwnd
 = 
¡d
::
	`max
(
cwndMš
, ()(
eúCeB‘a
*cwnd));

1333 
eúCeEv’t
 = 
çl£
;

1334 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 
time_Áp
;

1336 
šFa¡S¹
 = 
çl£
;

1337 
wasLossEv’t
 = 
Œue
;

1338 
po¡CÚge¡iÚSÿË
 = 0.0;

1341 
po¡CÚge¡iÚSÿË
 = 
¡d
::
	`max
(0.0f, std::
	`mš
(1.0f, (
time_Áp
 - 
Ï¡CÚge¡iÚD‘eùedT_Áp
è/ (
po¡CÚge¡iÚD–ay
*65536.0f)));

1343 ià(
time_Áp
 - 
Ï¡R‰T_Áp
 > 
sR‰_Áp
) {

1344 ià(
wasLossEv’t
)

1345 
lossEv’tR©e
 = 0.99f*lossEventRate + 0.01f;

1347 
lossEv’tR©e
 *= 0.99f;

1348 
wasLossEv’t
 = 
çl£
;

1349 
Ï¡R‰T_Áp
 = 
time_Áp
;

1352 ià(
šFa¡S¹
) {

1356 ià(
queueD–ayT»nd
 < 0.2) {

1366 
by‹sInFlightM¬gš
 = 1.5f;

1367 ià(
by‹sInFlight
*
by‹sInFlightM¬gš
 + 
by‹sNewlyAcked
 > 
cwnd
) {

1368 
cwnd
 +ğ(
po¡CÚge¡iÚSÿË
*
by‹sNewlyAckedLim™ed
);

1372 
šFa¡S¹
 = 
çl£
;

1376 ià(
offT¬g‘
 > 0.0f) {

1381 
by‹sInFlightM¬gš
 = 1.2f;

1382 ià(
by‹sInFlight
*
by‹sInFlightM¬gš
 + 
by‹sNewlyAcked
 > 
cwnd
) {

1383 
šüem’t
 = 
gašUp
 * 
offT¬g‘
 * 
by‹sNewlyAckedLim™ed
 * 
mss
 / 
cwnd
;

1384 
cwnd
 +ğ()(
šüem’t
 + 0.5f);

1395 
d–
 = -(
gašDown
 * 
offT¬g‘
 * 
by‹sNewlyAcked
 * 
mss
 / 
cwnd
);

1396 
d–
 = 
¡d
::
	`mš
(d–, 
cwnd
 / 4.0f);

1397 
cwnd
 -ğ()(
d–
);

1404 
¿‹TÙ®
 = 0.0f;

1405 
n
 = 0;‚ < 
nSŒ—ms
;‚++)

1406 
¿‹TÙ®
 +ğ
¡»ams
[
n
]->
	`g‘MaxR©e
();

1407 ià(
¿‹TÙ®
 < 1.0e5f) {

1408 
d–
 = d– / 
cwnd
;

1409 
¿‹Adju¡FaùÜ
 = (1.0à- 
d–
);

1410 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1411 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1412 
tmp
->
rg‘B™¿‹
 = 
¡d
::
	`max
Ñmp->
mšB™¿‹
,

1413 
¡d
::
	`mš
(
tmp
->
maxB™¿‹
,

1414 
tmp
->
rg‘B™¿‹
*
¿‹Adju¡FaùÜ
));

1417 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 
time_Áp
;

1425 ià(
maxBy‹sInFlight
 > 5000 && 
Ï¡CÚge¡iÚD‘eùedT_Áp
 > 0) {

1426 
cwnd
 = 
¡d
::
	`mš
(cwnd, ()
maxBy‹sInFlight
);

1429 
cwnd
 = 
¡d
::
	`max
(
cwndMš
, cwnd);

1434 ià(
queueD–ayT»nd
 > 0.2) {

1435 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 
time_Áp
;

1437 ià(
time_Áp
 - 
Ï¡CÚge¡iÚD‘eùedT_Áp
 > 16384 &&

1438 !
šFa¡S¹
 && 
kEÇbËCÚ£cutiveFa¡S¹
) {

1442 
šFa¡S¹
 = 
Œue
;

1443 
Ï¡CÚge¡iÚD‘eùedT_Áp
 = 
time_Áp
;

1445 
by‹sNewlyAcked
 = 0;

1446 
	}
}

1452 
	gSü—mTx
::
	$e¡im©eOwd
(
ušt32_t
 
time_Áp
) {

1453 
ba£Owd
 = 
¡d
::
	`mš
(ba£Owd, 
ackedOwd
);

1454 ià(
time_Áp
 - 
Ï¡Ba£OwdAddT_Áp
 >ğ
kBa£D–ayUpd©eIÁ”v®_Áp
) {

1455 ià(
’abËClockDriáCom³n§tiÚ
) {

1462 
±r
 = 
ba£OwdHi¡PŒ
;

1463 
k
 = 0;

1464 
ušt32_t
 
bw0
 = 
UINT32_MAX
;

1465 
k
 = 0; k < 
kBa£OwdHi¡Size
 - 1; k++) {

1466 ià(
ba£OwdHi¡
[
±r
] !ğ
UINT32_MAX
) {

1467 
bw0
 = 
ba£OwdHi¡
[
±r
];

1468 
±r
 =…tr - 1;

1469 ià(
±r
 < 0è±¸+ğ
kBa£OwdHi¡Size
;

1475 
ušt32_t
 
bw1
 = 
ba£Owd
;

1476 ià(
k
 > 0) {

1477 ià((
bw1
 > 
bw0
))

1478 
şockDriáCom³n§tiÚInc
 = (
bw1
 - 
bw0
è/ (
kBa£D–ayUpd©eIÁ”v®_Áp
 / 65536 * 
k
);

1480 
şockDriáCom³n§tiÚInc
 = 0;

1481 
şockDriáCom³n§tiÚInc
 = 
¡d
::
	`mš
(
kMaxClockdriáCom³n§tiÚ
, clockDriftCompensationInc);

1482 ià(
şockDriáCom³n§tiÚ
 == 0) {

1487 
şockDriáCom³n§tiÚ
 +ğ
şockDriáCom³n§tiÚInc
 * (
kBa£D–ayUpd©eIÁ”v®_Áp
 / 65536);

1491 
ba£OwdHi¡PŒ
 = (ba£OwdHi¡PŒ + 1è% 
kBa£OwdHi¡Size
;

1492 
ba£OwdHi¡
[
ba£OwdHi¡PŒ
] = 
ba£Owd
;

1493 
Ï¡Ba£OwdAddT_Áp
 = 
time_Áp
;

1494 
ba£Owd
 = 
UINT32_MAX
;

1495 
ba£OwdHi¡Mš
 = 
UINT32_MAX
;

1496 
n
 = 0;‚ < 
kBa£OwdHi¡Size
;‚++)

1497 
ba£OwdHi¡Mš
 = 
¡d
::
	`mš
(ba£OwdHi¡Mš, 
ba£OwdHi¡
[
n
]);

1503 ià(
time_Áp
 - 
Ï¡Ba£D–ayReäeshT_Áp
 > 
kBa£D–ayUpd©eIÁ”v®_Áp
*(
kBa£OwdHi¡Size
 - 1)) {

1504 
Ï¡Ba£D–ayReäeshT_Áp
 = 
time_Áp
;

1507 
	}
}

1512 
ušt32_t
 
	gSü—mTx
::
	$g‘Ba£Owd
() {

1513  
¡d
::
	`mš
(
ba£Owd
, 
ba£OwdHi¡Mš
);

1514 
	}
}

1519 
	gSü—mTx
::
	$g‘QueueD–ayF¿ùiÚ
() {

1520  
queueD–ay
 / 
queueD–ayT¬g‘
;

1521 
	}
}

1526 
	gSü—mTx
::
	$compu‹QueueD–ayT»nd
() {

1527 
queueD–ayT»nd
 = 0.0;

1528 
±r
 = 
queueD–ayF¿ùiÚHi¡PŒ
;

1529 
avg
 = 0.0f, 
x1
, 
x2
, 
a0
, 
a1
;

1531 
n
 = 0;‚ < 
kQueueD–ayF¿ùiÚHi¡Size
;‚++) {

1532 
avg
 +ğ
queueD–ayF¿ùiÚHi¡
[
±r
];

1533 
±r
 = (±¸+ 1è% 
kQueueD–ayF¿ùiÚHi¡Size
;

1535 
avg
 /ğ
kQueueD–ayF¿ùiÚHi¡Size
;

1537 
±r
 = 
queueD–ayF¿ùiÚHi¡PŒ
;

1538 
x2
 = 0.0f;

1539 
a0
 = 0.0f;

1540 
a1
 = 0.0f;

1541 
n
 = 0;‚ < 
kQueueD–ayF¿ùiÚHi¡Size
;‚++) {

1542 
x1
 = 
queueD–ayF¿ùiÚHi¡
[
±r
] - 
avg
;

1543 
a0
 +ğ
x1
 * x1;

1544 
a1
 +ğ
x1
 * 
x2
;

1545 
x2
 = 
x1
;

1546 
±r
 = (±¸+ 1è% 
kQueueD–ayF¿ùiÚHi¡Size
;

1548 ià(
a0
 > 0) {

1549 
queueD–ayT»nd
 = 
¡d
::
	`max
(0.0f, std::
	`mš
(1.0f, (
a1
 / 
a0
)*
queueD–ayF¿ùiÚAvg
));

1551 
	}
}

1556 
	gSü—mTx
::
	$compu‹Sbd
() {

1557 
queueD–ayNÜm
, 
tmp
;

1558 
queueD–aySbdM—n
 = 0.0;

1559 
queueD–aySbdM—nSh
 = 0.0;

1560 
queueD–aySbdV¬
 = 0.0;

1561 
±r
 = 
queueD–ayNÜmHi¡PŒ
;

1562 
n
 = 0;‚ < 
kQueueD–ayNÜmHi¡Size
;‚++) {

1563 
queueD–ayNÜm
 = 
queueD–ayNÜmHi¡
[
±r
];

1564 
queueD–aySbdM—n
 +ğ
queueD–ayNÜm
;

1565 ià(
n
 >ğ
kQueueD–ayNÜmHi¡Size
 - 
kQueueD–ayNÜmHi¡SizeSh
) {

1566 
queueD–aySbdM—nSh
 +ğ
queueD–ayNÜm
;

1568 
±r
 = (±¸+ 1è% 
kQueueD–ayNÜmHi¡Size
;

1570 
queueD–aySbdM—n
 /ğ
kQueueD–ayNÜmHi¡Size
;

1571 
queueD–aySbdM—nSh
 /ğ
kQueueD–ayNÜmHi¡SizeSh
;

1573 
±r
 = 
queueD–ayNÜmHi¡PŒ
;

1574 
n
 = 0;‚ < 
kQueueD–ayNÜmHi¡Size
;‚++) {

1575 
queueD–ayNÜm
 = 
queueD–ayNÜmHi¡
[
±r
];

1576 
tmp
 = 
queueD–ayNÜm
 - 
queueD–aySbdM—n
;

1577 
queueD–aySbdV¬
 +ğ
tmp
 *mp;

1578 
queueD–aySbdSkew
 +ğ
tmp
 *mp *mp;

1579 
±r
 = (±¸+ 1è% 
kQueueD–ayNÜmHi¡Size
;

1581 
queueD–aySbdV¬
 /ğ
kQueueD–ayNÜmHi¡Size
;

1582 
queueD–aySbdSkew
 /ğ
kQueueD–ayNÜmHi¡Size
;

1583 
	}
}

1589 
boŞ
 
	gSü—mTx
::
	$isCom³tšgFlows
() {

1590  
queueD–ayT¬g‘
 > 
queueD–ayT¬g‘Mš
;

1591 
	}
}

1596 
	gSü—mTx
::
	$g‘QueueD–ayT»nd
() {

1597  
queueD–ayT»nd
;

1598 
	}
}

1603 
	gSü—mTx
::
	$d‘”mšeAùiveSŒ—ms
(
ušt32_t
 
time_Áp
) {

1604 
su½lusB™¿‹
 = 0.0f;

1605 
sumPrio
 = 0.0;

1606 
boŞ
 
¡»amS‘IÇùive
 = 
çl£
;

1607 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1608 ià(
time_Áp
 - 
¡»ams
[
n
]->
Ï¡F¿meT_Áp
 > 65536 && sŒ—ms[n]->
isAùive
) {

1609 
¡»ams
[
n
]->
isAùive
 = 
çl£
;

1610 
su½lusB™¿‹
 +ğ
¡»ams
[
n
]->
rg‘B™¿‹
;

1611 
¡»ams
[
n
]->
rg‘B™¿‹
 = sŒ—ms[n]->
mšB™¿‹
;

1612 
¡»amS‘IÇùive
 = 
Œue
;

1615 
sumPrio
 +ğ
¡»ams
[
n
]->
rg‘PriÜ™y
;

1618 ià(
¡»amS‘IÇùive
) {

1619 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1620 ià(
¡»ams
[
n
]->
isAùive
) {

1621 
¡»ams
[
n
]->
rg‘B™¿‹
 = 
¡d
::
	`mš
(¡»ams[n]->
maxB™¿‹
,

1622 
¡»ams
[
n
]->
rg‘B™¿‹
 +

1623 
su½lusB™¿‹
 * 
¡»ams
[
n
]->
rg‘PriÜ™y
 / 
sumPrio
);

1627 
	}
}

1632 
	gSü—mTx
::
	$addC»d™
(
ušt32_t
 
time_Áp
, 
SŒ—m
* 
£rvedSŒ—m
, 
Œªsm™‹dBy‹s
) {

1636 ià(
nSŒ—ms
 == 1)

1641 
maxC»d™
 = 5 * 
mss
;

1642 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1643 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1644 ià(
tmp
 !ğ
£rvedSŒ—m
) {

1645 
üed™
 = ()(
Œªsm™‹dBy‹s
*
tmp
->
rg‘PriÜ™y
 * 
£rvedSŒ—m
->
rg‘PriÜ™yInv
);

1646 ià(
tmp
->
¹pQueue
->
	`sizeOfQueue
() > 0) {

1647 
tmp
->
üed™
 += credit;

1650 
tmp
->
üed™
 += credit;

1651 ià(
tmp
->
üed™
 > 
maxC»d™
) {

1652 
tmp
->
üed™Lo¡
 +ğtmp->
üed™
 - 
maxC»d™
;

1653 
tmp
->
üed™
 = 
maxC»d™
;

1658 
	}
}

1663 
	gSü—mTx
::
	$subŒaùC»d™
(
ušt32_t
 
time_Áp
, 
SŒ—m
* 
£rvedSŒ—m
, 
Œªsm™‹dBy‹s
) {

1668 ià(
nSŒ—ms
 == 1)

1673 
£rvedSŒ—m
->
üed™
 = 
¡d
::
	`max
(0, s”vedSŒ—m->üed™ - 
Œªsm™‹dBy‹s
);

1674 
	}
}

1686 
	gSü—mTx
::
	$adju¡PriÜ™›s
(
ušt32_t
 
time_Áp
) {

1687 ià(
nSŒ—ms
 =ğ1 || 
time_Áp
 - 
Ï¡Adju¡PriÜ™›sT_Áp
 < 65536) {

1694 ià(
¿‹T¿nsm™‹d
 > 0) {

1695 
tÙ®PriÜ™y
 = 0.0f;

1696 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1697 ià(
¡»ams
[
n
]->
isAùive
)

1698 
tÙ®PriÜ™y
 +ğ
¡»ams
[
n
]->
rg‘PriÜ™y
;

1701 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1702 ià(
¡»ams
[
n
]->
isAùive
) {

1703 
çœR©e
 = 
¿‹T¿nsm™‹d
 * 
¡»ams
[
n
]->
rg‘PriÜ™y
 / 
tÙ®PriÜ™y
;

1704 ià(
¡»ams
[
n
]->
¿‹R
 > 
çœR©e
*1.2f) {

1705 
sÿË
 = 
¡d
::
	`max
(0.8,1.0à- 0.1f*
queueD–ayT»nd
 - 
l4sAÍha
 * (1.0 - 
po¡CÚge¡iÚSÿË
));

1706 
¡»ams
[
n
]->
rg‘B™¿‹
 = 
¡d
::
	`max
(¡»ams[n]->
mšB™¿‹
, sŒ—ms[n]->rg‘B™¿‹*
sÿË
);

1710 
Ï¡Adju¡PriÜ™›sT_Áp
 = 
time_Áp
;

1712 
	}
}

1717 
	gSü—mTx
::
SŒ—m
* 
Sü—mTx
::
	$g‘PriÜ™izedSŒ—m
(
ušt32_t
 
time_Áp
) {

1723 ià(
nSŒ—ms
 == 1)

1727  
¡»ams
[0];

1729 
maxC»d™
 = 1;

1730 
SŒ—m
 *
¡»am
 = 
NULL
;

1735 
ušt32_t
 
maxDiff
 = 0;

1736 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1737 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1738 ià(
tmp
->
¹pQueue
->
	`sizeOfQueue
() == 0) {

1744 
ušt32_t
 
diff
 = 
time_Áp
 - 
tmp
->
Ï¡T¿nsm™T_Áp
;

1748 ià(
tmp
->
üed™
 >ğ
maxC»d™
 && 
diff
 > 
maxDiff
) {

1749 
¡»am
 = 
tmp
;

1750 
maxDiff
 = 
diff
;

1751 
maxC»d™
 = 
tmp
->
üed™
;

1755 ià(
¡»am
 !ğ
NULL
) {

1756  
¡»am
;

1763 
maxPrio
 = 0.0;

1764 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1765 
SŒ—m
 *
tmp
 = 
¡»ams
[
n
];

1766 
´iÜ™y
 = 
tmp
->
rg‘PriÜ™y
;

1767 ià(
tmp
->
¹pQueue
->
	`sizeOfQueue
(è> 0 && 
´iÜ™y
 > 
maxPrio
) {

1768 
maxPrio
 = 
´iÜ™y
;

1769 
¡»am
 = 
tmp
;

1772  
¡»am
;

1773 
	}
}

1775 
	gSü—mTx
::
SŒ—m
::
	$SŒ—m
(
Sü—mTx
 *
·»Á_
,

1776 
RQueueIçû
 *
¹pQueue_
,

1777 
ušt32_t
 
s¤c_
,

1778 
´iÜ™y_
,

1779 
mšB™¿‹_
,

1780 
¡¬tB™¿‹_
,

1781 
maxB™¿‹_
,

1782 
¿mpUpS³ed_
,

1783 
¿mpUpSÿË_
,

1784 
maxRQueueD–ay_
,

1785 
txQueueSizeFaùÜ_
,

1786 
queueD–ayGu¬d_
,

1787 
lossEv’tR©eSÿË_
,

1788 
eúCeEv’tR©eSÿË_
,

1789 
boŞ
 
isAd­tiveT¬g‘R©eSÿË_
,

1790 
hy¡”esis_
) {

1791 
·»Á
 = 
·»Á_
;

1792 
¹pQueue
 = 
¹pQueue_
;

1793 
s¤c
 = 
s¤c_
;

1794 
rg‘PriÜ™y
 = 
´iÜ™y_
;

1795 
rg‘PriÜ™yInv
 = 1.0à/ 
rg‘PriÜ™y
;

1796 
mšB™¿‹
 = 
mšB™¿‹_
;

1797 
maxB™¿‹
 = 
maxB™¿‹_
;

1798 
rg‘B™¿‹
 = 
¡d
::
	`mš
(
maxB™¿‹
, std::
	`max
(
mšB™¿‹
, 
¡¬tB™¿‹_
));

1799 
rg‘B™¿‹H
 = 
rg‘B™¿‹
;

1800 
¿mpUpS³ed
 = 
¿mpUpS³ed_
;

1801 
¿mpUpSÿË
 = 
¿mpUpSÿË_
;

1802 
maxRQueueD–ay
 = 
maxRQueueD–ay_
;

1803 
txQueueSizeFaùÜ
 = 
txQueueSizeFaùÜ_
;

1804 
queueD–ayGu¬d
 = 
queueD–ayGu¬d_
;

1805 
lossEv’tR©eSÿË
 = 
lossEv’tR©eSÿË_
;

1806 
eúCeEv’tR©eSÿË
 = 
eúCeEv’tR©eSÿË_
;

1807 
isAd­tiveT¬g‘R©eSÿË
 = 
isAd­tiveT¬g‘R©eSÿË_
;

1808 
hy¡”esis
 = 
hy¡”esis_
;

1809 
rg‘B™¿‹Hi¡Upd©eT_Áp
 = 0;

1810 
rg‘B™¿‹I
 = 1.0f;

1811 
üed™
 = 0;

1812 
üed™Lo¡
 = 0;

1813 
by‹sT¿nsm™‹d
 = 0;

1814 
by‹sAcked
 = 0;

1815 
by‹sLo¡
 = 0;

1816 
hiSeqAck
 = 0;

1817 
hiSeqTx
 = 0;

1818 
¿‹T¿nsm™‹d
 = 0.0f;

1819 
¿‹Acked
 = 0.0f;

1820 
¿‹Lo¡
 = 0.0f;

1821 
¿‹Ce
 = 0.0;

1822 
lossEv’tFÏg
 = 
çl£
;

1823 
eúCeEv’tFÏg
 = 
çl£
;

1824 
txSizeB™sAvg
 = 0.0f;

1825 
Ï¡R©eUpd©eT_Áp
 = 0;

1826 
Ï¡B™¿‹Adju¡T_Áp
 = 0;

1827 
Ï¡T¬g‘B™¿‹IUpd©eT_Áp
 = 0;

1828 
by‹sR
 = 0;

1829 
·ck‘sR
 = 0;

1830 
¿‹R
 = 0.0f;

1831 
timeTxAck_Áp
 = 0;

1832 
Ï¡T¿nsm™T_Áp
 = 0;

1833 
numb”OfUpd©eR©e
 = 0;

1834 
ş—»d
 = 0;

1835 
·ck‘Lo¡
 = 0;

1836 
n
 = 0;‚ < 
kR©eUpD©eSize
;‚++) {

1837 
¿‹RHi¡
[
n
] = 0.0f;

1838 
¿‹AckedHi¡
[
n
] = 0.0f;

1839 
¿‹Lo¡Hi¡
[
n
] = 0.0f;

1840 
¿‹CeHi¡
[
n
] = 0.0f;

1841 
¿‹T¿nsm™‹dHi¡
[
n
] = 0.0f;

1843 
¿‹Upd©eHi¡PŒ
 = 0;

1844 
n
 = 0;‚ < 
kT¬g‘B™¿‹Hi¡Size
;‚++) {

1845 
rg‘B™¿‹Hi¡
[
n
] = 0;

1847 
rg‘B™¿‹Hi¡PŒ
 = 0;

1848 
rg‘R©eSÿË
 = 1.0;

1849 
isAùive
 = 
çl£
;

1850 
Ï¡F¿meT_Áp
 = 0;

1851 
š™Time_Áp
 = 0;

1852 
¹pQueueDisÿrd
 = 
çl£
;

1853 
Ï¡RQueueDisÿrdT_Áp
 = 0;

1854 
Ï¡FuÎWšdowT_Áp
 = 0;

1855 
by‹sLo¡
 = 0;

1856 
by‹sCe
 = 0;

1857 
wasR•aœLoss
 = 
çl£
;

1858 
»·œLoss
 = 
çl£
;

1859 
n
 = 0;‚ < 
kMaxTxPack‘s
;‚++)

1860 
txPack‘s
[
n
].
isU£d
 = 
çl£
;

1861 
txPack‘sPŒ
 = 0;

1862 
lossEpoch
 = 
çl£
;

1863 
	}
}

1868 
	gSü—mTx
::
SŒ—m
::
	$upd©eR©e
(
ušt32_t
 
time_Áp
) {

1869 ià(
Ï¡R©eUpd©eT_Áp
 !ğ0 && 
·»Á
->
’abËR©eUpd©e
) {

1870 
numb”OfUpd©eR©e
++;

1871 
tD–
 = (
time_Áp
 - 
Ï¡R©eUpd©eT_Áp
è* 
Áp2SecSÿËFaùÜ
;

1872 
¿‹T¿nsm™‹dHi¡
[
¿‹Upd©eHi¡PŒ
] = 
by‹sT¿nsm™‹d
 * 8.0à/ 
tD–
;

1873 
¿‹AckedHi¡
[
¿‹Upd©eHi¡PŒ
] = 
by‹sAcked
 * 8.0à/ 
tD–
;

1874 
¿‹Lo¡Hi¡
[
¿‹Upd©eHi¡PŒ
] = 
by‹sLo¡
 * 8.0à/ 
tD–
;

1875 
¿‹CeHi¡
[
¿‹Upd©eHi¡PŒ
] = 
by‹sCe
 * 8.0à/ 
tD–
;

1876 
¿‹RHi¡
[
¿‹Upd©eHi¡PŒ
] = 
by‹sR
 * 8.0à/ 
tD–
;

1878 
¿‹Upd©eHi¡PŒ
 = (¿‹Upd©eHi¡PŒ + 1è% 
kR©eUpD©eSize
;

1879 
¿‹T¿nsm™‹d
 = 0.0f;

1880 
¿‹Acked
 = 0.0f;

1881 
¿‹Lo¡
 = 0.0f;

1882 
¿‹Ce
 = 0.0f;

1883 
¿‹R
 = 0.0f;

1884 
n
 = 0;‚ < 
kR©eUpD©eSize
;‚++) {

1885 
¿‹T¿nsm™‹d
 +ğ
¿‹T¿nsm™‹dHi¡
[
n
];

1886 
¿‹Acked
 +ğ
¿‹AckedHi¡
[
n
];

1887 
¿‹Lo¡
 +ğ
¿‹Lo¡Hi¡
[
n
];

1888 
¿‹Ce
 +ğ
¿‹CeHi¡
[
n
];

1889 
¿‹R
 +ğ
¿‹RHi¡
[
n
];

1891 
¿‹T¿nsm™‹d
 /ğ
kR©eUpD©eSize
;

1892 
¿‹Acked
 /ğ
kR©eUpD©eSize
;

1893 
¿‹Lo¡
 /ğ
kR©eUpD©eSize
;

1894 
¿‹Ce
 /ğ
kR©eUpD©eSize
;

1895 
¿‹R
 /ğ
kR©eUpD©eSize
;

1896 ià(
¿‹R
 > 0 && 
isAd­tiveT¬g‘R©eSÿË
 && 
numb”OfUpd©eR©e
 > 
kR©eUpD©eSize
) {

1902 cÚ¡ 
diff
 = 
rg‘B™¿‹
 * 
rg‘R©eSÿË
 / 
¿‹R
;

1903 
®pha
 = 0.02f;

1904 
rg‘R©eSÿË
 *ğ(1.0à- 
®pha
);

1905 
rg‘R©eSÿË
 +ğ
®pha
 * 
diff
;

1906 
rg‘R©eSÿË
 = 
¡d
::
	`mš
(1.1f, std::
	`max
(0.8f,argetRateScale));

1908 ià(
¿‹Lo¡
 > 0) {

1909 
lossEpoch
 = 
Œue
;

1913 
by‹sT¿nsm™‹d
 = 0;

1914 
by‹sAcked
 = 0;

1915 
by‹sR
 = 0;

1916 
by‹sLo¡
 = 0;

1917 
by‹sCe
 = 0;

1918 
Ï¡R©eUpd©eT_Áp
 = 
time_Áp
;

1919 
	}
}

1924 
	gSü—mTx
::
SŒ—m
::
	$g‘MaxR©e
() {

1925  
¡d
::
	`max
(
¿‹T¿nsm™‹d
, 
¿‹Acked
);

1926 
	}
}

1931 
	gSü—mTx
::
SŒ—m
* 
Sü—mTx
::
	$g‘SŒ—m
(
ušt32_t
 
s¤c
, &
¡»amId
) {

1932 
n
 = 0;‚ < 
nSŒ—ms
;‚++) {

1933 ià(
¡»ams
[
n
]->
	`isM©ch
(
s¤c
)) {

1934 
¡»amId
 = 
n
;

1935  
¡»ams
[
n
];

1938 
¡»amId
 = -1;

1939  
NULL
;

1940 
	}
}

1947 
	gSü—mTx
::
SŒ—m
::
	$g‘T¬g‘B™¿‹
() {

1949 
boŞ
 
»que¡Reäesh
 = 
	`isRQueueDisÿrd
(è|| 
»·œLoss
;

1950 
»·œLoss
 = 
çl£
;

1951 ià(
»que¡Reäesh
 && !
wasR•aœLoss
) {

1952 
wasR•aœLoss
 = 
Œue
;

1955 
¿‹
 = 
rg‘R©eSÿË
 * 
rg‘B™¿‹H
;

1956 
wasR•aœLoss
 = 
çl£
;

1957  
¿‹
;

1958 
	}
}

1965 
	gSü—mTx
::
SŒ—m
::
	$upd©eT¬g‘B™¿‹I
(
br
) {

1966 
rg‘B™¿‹Hi¡
[
rg‘B™¿‹Hi¡PŒ
] = 
¡d
::
	`mš
(
br
, 
rg‘B™¿‹
);

1967 
rg‘B™¿‹Hi¡PŒ
 = (rg‘B™¿‹Hi¡PŒ + 1è% 
kT¬g‘B™¿‹Hi¡Size
;

1968 
rg‘B™¿‹I
 = 
¡d
::
	`mš
(
br
, 
rg‘B™¿‹
);

1969 
n
 = 0;‚ < 
kT¬g‘B™¿‹Hi¡Size
;‚++) {

1970 
rg‘B™¿‹I
 = 
¡d
::
	`max
Ñ¬g‘B™¿‹I, 
rg‘B™¿‹Hi¡
[
n
]);

1972 
	}
}

1984 
	gSü—mTx
::
SŒ—m
::
	$upd©eT¬g‘B™¿‹
(
ušt32_t
 
time_Áp
) {

1989 
br
 = 
	`g‘MaxR©e
();

1990 
¿‹RLim™
 = 
¡d
::
	`max
(
¿‹R
, 
br
);

1991 ià(
š™Time_Áp
 == 0) {

1995 
š™Time_Áp
 = 
time_Áp
;

1996 
Ï¡RQueueDisÿrdT_Áp
 = 
time_Áp
;

1999 ià(
Ï¡B™¿‹Adju¡T_Áp
 =ğ0èÏ¡B™¿‹Adju¡T_Á°ğ
time_Áp
;

2000 
isAùive
 = 
Œue
;

2001 
Ï¡F¿meT_Áp
 = 
time_Áp
;

2002 ià(
lossEv’tFÏg
 || 
eúCeEv’tFÏg
) {

2008 
	`upd©eT¬g‘B™¿‹I
(
br
);

2009 
Ï¡T¬g‘B™¿‹IUpd©eT_Áp
 = 
time_Áp
;

2010 ià(
lossEv’tFÏg
)

2011 
rg‘B™¿‹
 = 
¡d
::
	`max
(
mšB™¿‹
,¬g‘B™¿‹*
lossEv’tR©eSÿË
);

2012 ià(
eúCeEv’tFÏg
) {

2013 ià(
·»Á
->
isL4s
) {

2022 
backOff
 = 
·»Á
->
by‹sInFlightR©io
*·»Á->
l4sAÍha
/(2.0*
kMaxBy‹sInFlightH—dRoom
*·»Á->
·ck‘PacšgH—droom
);

2024 
rg‘B™¿‹
 = 
¡d
::
	`max
(
mšB™¿‹
,¬g‘B™¿‹*(1.0à- 
backOff
));

2027 
rg‘B™¿‹
 = 
¡d
::
	`max
(
mšB™¿‹
,¬g‘B™¿‹*
eúCeEv’tR©eSÿË
);

2030 
¹pQueueD–ay
 = 
¹pQueue
->
	`g‘D–ay
(
time_Áp
 * 
Áp2SecSÿËFaùÜ
);

2031 ià(
¹pQueueD–ay
 > 
maxRQueueD–ay
 &&

2032 (
time_Áp
 - 
Ï¡RQueueDisÿrdT_Áp
 > 
kMšRQueueDisÿrdIÁ”v®_Áp
)) {

2038 
£qNrOfNextR
 = 
¹pQueue
->
	`£qNrOfNextR
();

2039 
£qNrOfLa¡R
 = 
¹pQueue
->
	`£qNrOfLa¡R
();

2040 
·k_diff
 = (
£qNrOfLa¡R
 =ğ-1è? -1 : ((£qNrOfLa¡R >ğ
hiSeqTx
 ) ? (seqNrOfLastRtp - hiSeqTx ) : seqNrOfLastRtp + 0xffff - hiSeqTx);

2042 
cur_ş—»d
 = 
¹pQueue
->
	`ş—r
();

2043 
û¼
 << 
log_g
 << "„QueueD–ay " << 
¹pQueueD–ay
 << "oØÏrg1 " << 
time_Áp
 / 65536.0à<< " RTP queu" << 
cur_ş—»d
 <<

2044 "…ack‘ disÿrded fÜ SSRC " << 
s¤c
 << " hiSeqTx " << 
hiSeqTx
 << " hiSeqAck’dÈ" << 
hiSeqAck
 <<

2045 " seqNrOfNextR " << 
£qNrOfNextR
 << " seqNrOfLa¡R " << 
£qNrOfLa¡R
 << " difà" << 
·k_diff
 << 
’dl
;

2046 
ş—»d
 +ğ
cur_ş—»d
;

2047 
¹pQueueDisÿrd
 = 
Œue
;

2048 
lossEpoch
 = 
Œue
;

2050 
Ï¡RQueueDisÿrdT_Áp
 = 
time_Áp
;

2051 
rg‘R©eSÿË
 = 1.0;

2052 
txSizeB™sAvg
 = 0.0f;

2055 
lossEv’tFÏg
 = 
çl£
;

2056 
eúCeEv’tFÏg
 = 
çl£
;

2057 
Ï¡B™¿‹Adju¡T_Áp
 = 
time_Áp
;

2060 ià(
time_Áp
 - 
Ï¡B™¿‹Adju¡T_Áp
 < 
kR©eAdju¡IÁ”v®_Áp
)

2062 ià(
·»Á
->
by‹sInFlightR©io
 > 0.9 && 
time_Áp
 - 
Ï¡FuÎWšdowT_Áp
 > 6554) {

2069 
rg‘B™¿‹
 *= 0.95;

2070 
Ï¡FuÎWšdowT_Áp
 = 
time_Áp
;

2079 
sşI
 = (
rg‘B™¿‹
 - 
rg‘B™¿‹I
) /argetBitrateI;

2080 ià(
·»Á
->
isL4s
)

2081 
sşI
 *= 16;

2083 
sşI
 *= 4;

2084 
sşI
 = sclI * sclI;

2085 
sşI
 = 
¡d
::
	`max
(0.2f, std::
	`mš
(1.0f, sclI));

2086 
šüem’t
 = 0.0f;

2098 
Ï¡By‹s
 = 
¹pQueue
->
	`g‘SizeOfLa¡F¿me
();

2099 
txSizeB™sLim™
 = ()(
rg‘B™¿‹
*0.02);

2100 
txSizeB™s
 = 
¡d
::
	`max
(0, 
¹pQueue
->
	`by‹sInQueue
(è- 
Ï¡By‹s
) * 8;

2101 
txSizeB™s
 = 
¡d
::
	`mš
ÑxSizeB™s, 
txSizeB™sLim™
);

2103 cÚ¡ 
®pha
 = 0.5f;

2105 
txSizeB™sAvg
 =xSizeB™sAvg * 
®pha
 + 
txSizeB™s
 * (1.0f -‡lpha);

2110 
¿mpUpS³edTmp
 = 
¡d
::
	`mš
(
¿mpUpS³ed
, 
rg‘B™¿‹
*
¿mpUpSÿË
);

2111 ià(
·»Á
->
	`isCom³tšgFlows
()) {

2112 
¿mpUpS³edTmp
 *= 2.0f;

2115 
¹pQueueD–ay
 = 
¹pQueue
->
	`g‘D–ay
(
time_Áp
 * 
Áp2SecSÿËFaùÜ
);

2116 ià(
¹pQueueD–ay
 > 
maxRQueueD–ay
 &&

2117 (
time_Áp
 - 
Ï¡RQueueDisÿrdT_Áp
 > 
kMšRQueueDisÿrdIÁ”v®_Áp
)) {

2123 
£qNrOfNextR
 = 
¹pQueue
->
	`£qNrOfNextR
();

2124 
£qNrOfLa¡R
 = 
¹pQueue
->
	`£qNrOfLa¡R
();

2125 
·k_diff
 = (
£qNrOfLa¡R
 =ğ-1è? -1 : ((£qNrOfLa¡R >ğ
hiSeqTx
 ) ? (seqNrOfLastRtp - hiSeqTx ) : seqNrOfLastRtp + 0xffff - hiSeqTx);

2127 
cur_ş—»d
 = 
¹pQueue
->
	`ş—r
();

2128 
û¼
 << 
log_g
 << "„QueueD–ay " << 
¹pQueueD–ay
 << "oØÏrg2 " << 
time_Áp
 / 65536.0à<< " RTP queu" << 
cur_ş—»d
 <<

2129 "…ack‘ disÿrded fÜ SSRC " << 
s¤c
 << " hiSeqTx " << 
hiSeqTx
 << " hiSeqAck’dÈ" << 
hiSeqAck
 <<

2130 " seqNrOfNextR " << 
£qNrOfNextR
 << " seqNrOfLa¡R " << 
£qNrOfLa¡R
 << " difà" << 
·k_diff
 << 
’dl
;

2131 
ş—»d
 +ğ
cur_ş—»d
;

2132 
¹pQueueDisÿrd
 = 
Œue
;

2133 
lossEpoch
 = 
Œue
;

2134 
Ï¡RQueueDisÿrdT_Áp
 = 
time_Áp
;

2135 
rg‘R©eSÿË
 = 1.0;

2136 
txSizeB™sAvg
 = 0.0f;

2138 ià((
·»Á
->
isL4s
 &&…¬’t->
l4sAÍha
 > 0.001è||…¬’t->
šFa¡S¹
 && 
¹pQueueD–ay
 < 0.1f) {

2142 
šüem’t
 = 
¿mpUpS³edTmp
 * (
kR©eAdju¡IÁ”v®_Áp
 * 
Áp2SecSÿËFaùÜ
);

2146 
šüem’t
 *ğ
sşI
 * 
	`sq¹
(
rg‘PriÜ™y
);

2150 ià(
rg‘B™¿‹
 > 
¿‹RLim™
) {

2158 
sÿË
 = 
¡d
::
	`max
(-1.0f, 2.0f*(
¿‹RLim™
 / 
rg‘B™¿‹
 - 1.0f));

2159 
šüem’t
 *ğ(1.0 + 
sÿË
);

2164 
šüem’t
 *ğ
·»Á
->
po¡CÚge¡iÚSÿË
;

2169 
rg‘B™¿‹
 +ğ
šüem’t
;

2170 
wasFa¡S¹
 = 
Œue
;

2173 ià(
wasFa¡S¹
) {

2174 
wasFa¡S¹
 = 
çl£
;

2175 ià(
time_Áp
 - 
Ï¡T¬g‘B™¿‹IUpd©eT_Áp
 > 32768) {

2181 
	`upd©eT¬g‘B™¿‹I
(
br
);

2182 
Ï¡T¬g‘B™¿‹IUpd©eT_Áp
 = 
time_Áp
;

2189 
šüem’t
 = 
br
;

2193 
sş
 = 
queueD–ayGu¬d
 * 
·»Á
->
	`g‘QueueD–ayT»nd
();

2194 ià(
·»Á
->
	`isCom³tšgFlows
())

2195 
sş
 *= 0.05f;

2196 
šüem’t
 = inüem’ˆ* (1.0à- 
sş
è- 
txQueueSizeFaùÜ
 * 
txSizeB™sAvg
;

2197 
šüem’t
 -ğ
rg‘B™¿‹
;

2198 ià(
txSizeB™s
 > 12000 && 
šüem’t
 > 0)

2199 
šüem’t
 = 0;

2201 ià(
šüem’t
 > 0) {

2202 
wasFa¡S¹
 = 
Œue
;

2206 
šüem’t
 *ğ
·»Á
->
po¡CÚge¡iÚSÿË
;

2212 
šüem’tSÿË
 = 1.0à+ 0.05f*
¡d
::
	`mš
(1.0f, 50000.0à/ 
rg‘B™¿‹
);

2213 
šüem’t
 *ğ
šüem’tSÿË
;

2214 ià(!
·»Á
->
	`isCom³tšgFlows
()) {

2219 
šüem’t
 *ğ
sşI
;

2220 
šüem’t
 = 
¡d
::
	`mš
(šüem’t, ()(
¿mpUpS³edTmp
*(
kR©eAdju¡IÁ”v®_Áp
 * 
Áp2SecSÿËFaùÜ
)));

2225 ià(
rg‘B™¿‹
 > 
¿‹RLim™
) {

2233 
sÿË
 = 
¡d
::
	`max
(-1.0f, 2.0f*(
¿‹RLim™
 / 
rg‘B™¿‹
 - 1.0f));

2234 
šüem’t
 *ğ(1.0 + 
sÿË
);

2238 ià(
¿‹RLim™
 < 
rg‘B™¿‹
) {

2244 
sÿË
 = 
¡d
::
	`max
(-1.0f, 2.0f*(
¿‹RLim™
 / 
rg‘B™¿‹
 - 1.0f));

2245 
šüem’t
 *ğ(1.0 + 
sÿË
);

2254 ià(
¿‹RLim™
 > 
rg‘B™¿‹
*2.0f)

2255 
šüem’t
 = 0.0f;

2257 
rg‘B™¿‹
 +ğ
šüem’t
;

2260 
Ï¡B™¿‹Adju¡T_Áp
 = 
time_Áp
;

2263 
rg‘B™¿‹
 = 
¡d
::
	`mš
(
maxB™¿‹
, std::
	`max
(
mšB™¿‹
,argetBitrate));

2264 
diff
 = (
rg‘B™¿‹
-
rg‘B™¿‹H
)/targetBitrateH;

2265 ià(
diff
 > 
hy¡”esis
 || diff < -hysteresis/4) {

2269 
rg‘B™¿‹H
 = 
rg‘B™¿‹
;

2271 
	}
}

2273 
boŞ
 
	gSü—mTx
::
SŒ—m
::
	$isRQueueDisÿrd
() {

2274 
boŞ
 
tmp
 = 
¹pQueueDisÿrd
;

2275 
¹pQueueDisÿrd
 = 
çl£
;

2276  
tmp
;

2277 
	}
}

2279 
boŞ
 
	gSü—mTx
::
SŒ—m
::
	$isLossEpoch
() {

2280 
boŞ
 
tmp
 = 
lossEpoch
;

2281 
lossEpoch
 = 
çl£
;

2282  
tmp
;

2283 
	}
}

	@scream/code/ScreamTx.h

1 #iâdeà
SCREAM_TX


2 
	#SCREAM_TX


	)

4 
	~<¡ršg.h
>

5 
	~<io¡»am
>

6 
	~<c¡dšt
>

8 
usšg
 
Çme¥aû
 
¡d
;

31 cÚ¡ 
kLossB‘a
 = 0.8f;

33 cÚ¡ 
kEúCeB‘a
 = 0.9f;

35 cÚ¡ 
kQueueD–ayT¬g‘Mš
 = 0.1f;

44 cÚ¡ 
boŞ
 
kEÇbËSbd
 = 
çl£
;

46 cÚ¡ 
kGašUp
 = 1.0f;

47 cÚ¡ 
kGašDown
 = 2.0f;

51 cÚ¡ 
kRampUpS³ed
 = 200000.0f;

53 cÚ¡ 
kRampUpSÿË
 = 0.2f;

55 cÚ¡ 
kMaxRQueueD–ay
 = 0.1;

59 cÚ¡ 
kTxQueueSizeFaùÜ
 = 0.2f;

63 cÚ¡ 
kQueueD–ayGu¬d
 = 0.1f;

65 cÚ¡ 
kLossEv’tR©eSÿË
 = 0.9f;

67 cÚ¡ 
kEúCeEv’tR©eSÿË
 = 0.95f;

69 cÚ¡ 
kPack‘PacšgH—dRoom
 = 1.25f;

78 cÚ¡ 
kMaxTxPack‘s
 = 4096;

82 cÚ¡ 
kMaxSŒ—ms
 = 10;

86 cÚ¡ 
kBa£OwdHi¡Size
 = 50;

87 cÚ¡ 
kQueueD–ayNÜmHi¡Size
 = 200;

88 cÚ¡ 
kQueueD–ayNÜmHi¡SizeSh
 = 50;

89 cÚ¡ 
kQueueD–ayF¿ùiÚHi¡Size
 = 20;

90 cÚ¡ 
kBy‹sInFlightHi¡SizeMax
 = 60;

91 cÚ¡ 
kR©eUpD©eSize
 = 8;

92 cÚ¡ 
kT¬g‘B™¿‹Hi¡Size
 = 1;

93 cÚ¡ 
kLossR©eHi¡Size
 = 10;

95 
şass
 
RQueueIçû
;

96 şas 
	cSü—mTx
 {

97 
public
:

112 
Sü—mTx
(
lossB‘a
 = 
kLossB‘a
,

113 
eúCeB‘a
 = 
kEúCeB‘a
,

114 
queueD–ayT¬g‘Mš
 = 
kQueueD–ayT¬g‘Mš
,

115 
boŞ
 
’abËSbd
 = 
kEÇbËSbd
,

116 
gašUp
 = 
kGašUp
,

117 
gašDown
 = 
kGašDown
,

118 
cwnd
 = 0,

119 
·ck‘PacšgH—droom
 = 
kPack‘PacšgH—dRoom
,

120 
by‹sInFlightHi¡Size
 = 5,

121 
boŞ
 
isL4s
 = 
çl£
,

122 
boŞ
 
İ’Wšdow
 = 
çl£
,

123 
boŞ
 
’abËClockDriáCom³n§tiÚ
 = 
çl£
);

125 ~
Sü—mTx
();

136 
»gi¡”NewSŒ—m
(
RQueueIçû
 *
¹pQueue
,

137 
ušt32_t
 
s¤c
,

138 
´iÜ™y
,

139 
mšB™¿‹
,

140 
¡¬tB™¿‹
,

141 
maxB™¿‹
,

142 
¿mpUpS³ed
 = 
kRampUpS³ed
,

143 
¿mpUpSÿË
 = 
kRampUpSÿË
,

144 
maxRQueueD–ay
 = 
kMaxRQueueD–ay
,

145 
txQueueSizeFaùÜ
 = 
kTxQueueSizeFaùÜ
,

146 
queueD–ayGu¬d
 = 
kQueueD–ayGu¬d
,

147 
lossEv’tR©eSÿË
 = 
kLossEv’tR©eSÿË
,

148 
eúCeEv’tR©eSÿË
 = 
kEúCeEv’tR©eSÿË
,

149 
boŞ
 
isAd­tiveT¬g‘R©eSÿË
 = 
Œue
,

150 
hy¡”esis
 = 0.0);

155 
upd©eB™¿‹SŒ—m
(
ušt32_t
 
s¤c
,

156 
mšB™¿‹
,

157 
maxB™¿‹
);

162 
RQueueIçû
 * 
g‘SŒ—mQueue
(
ušt32_t
 
s¤c
);

168 
ÃwMedŸF¿me
(
ušt32_t
 
time_Áp
, ušt32_ˆ
s¤c
, 
by‹sR
);

181 
isOkToT¿nsm™
(
ušt32_t
 
time_Áp
, ušt32_ˆ&
s¤c
);

188 
addT¿nsm™‹d
(
ušt32_t
 
time¡amp_Áp
,

189 
ušt32_t
 
s¤c
,

190 
size
,

191 
ušt16_t
 
£qNr
,

192 
boŞ
 
isM¬k
);

206 
šcomšgSnd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

207 * 
buf
,

208 
size
);

210 
šcomšgSnd¬dizedF“dback
(
ušt32_t
 
time_Áp
,

211 
¡»amId
,

212 
ušt32_t
 
time¡amp
,

213 
ušt16_t
 
£qNr
,

214 
ušt8_t
 
ûB™s
,

215 
boŞ
 
isLa¡
);

226 
g‘T¬g‘B™¿‹
(
ušt32_t
 
s¤c
);

231 
£tT¬g‘PriÜ™y
(
ušt32_t
 
s¤c
, 
aPriÜ™y
);

239 
£tMaxTÙ®B™¿‹
(
aMaxTÙ®B™¿‹
) {

240 
maxTÙ®B™¿‹
 = 
aMaxTÙ®B™¿‹
;

246 
g‘MaxTÙ®B™¿‹
() {

247  
maxTÙ®B™¿‹
;

254 
g‘Log
(
time
, *
s
, 
boŞ
 
ş—r
);

259 
g‘LogH—d”
(*
s
);

264 
g‘ShÜtLog
(
time
, *
s
);

269 
g‘V”yShÜtLog
(
time
, *
s
);

274 
g‘Sti¡ics
(
time
, *
s
);

279 
£tD‘aedLogFp
(
FILE
 *
å
) {

280 
å_log
 = 
å
;

283 
£tTimeSŒšg
(*
s
) {

284 
¡rıy
(
timeSŒšg
, 
s
);

290 
£tD‘aedLogExŒaD©a
(*
s
) {

291 
¡rıy
(
d‘aedLogExŒaD©a
, 
s
);

297 cÚ¡ *
g‘D‘aedLogI‹mLi¡
() {

304 
u£ExŒaD‘aedLog
(
boŞ
 
isU£ExŒaD‘aedLog_
) {

305 
isU£ExŒaD‘aedLog
 = 
isU£ExŒaD‘aedLog_
;

312 
g‘Qu®™yIndex
(
time
, 
th»shŞdR©e
, 
¹tMš
);

317 
£tCwndMšLow
(
aV®ue
) {

318 
cwndMšLow
 = 
aV®ue
;

326 
£tEÇbËR©eUpd©e
(
boŞ
 
isEÇbËR©eUpd©e
) {

327 
’abËR©eUpd©e
 = 
isEÇbËR©eUpd©e
;

333 
boŞ
 
isLossEpoch
(
ušt32_t
 
s¤c
);

340 
£tPo¡CÚge¡iÚD–ay
(
a
) {

341 
po¡CÚge¡iÚD–ay
 = 
a
;

344 
´iv©e
:

348 
	sT¿nsm™‹d
 {

349 
ušt32_t
 
timeTx_Áp
;

350 
size
;

351 
ušt16_t
 
£qNr
;

352 
boŞ
 
isM¬k
;

353 
boŞ
 
isU£d
;

354 
boŞ
 
isAcked
;

355 
boŞ
 
isAá”ReûivedEdge
;

362 şas 
	cSti¡ics
 {

363 
public
:

364 
Sti¡ics
();

365 
g‘Summ¬y
(
time
, 
s
[]);

366 
add
(
¿‹Tx
, 
¿‹Lo¡
, 
¹t
, 
queueD–ay
);

367 
´iv©e
:

368 
lossR©eHi¡
[
kLossR©eHi¡Size
];

369 
¿‹Lo¡Acc
;

370 
¿‹Lo¡N
;

371 
lossR©eHi¡PŒ
;

372 
avgR©eTx
;

373 
avgR‰
;

374 
avgQueueD–ay
;

375 
sumR©eTx
;

376 
sumR©eLo¡
;

389 şas 
	cSŒ—m
 {

390 
public
:

391 
SŒ—m
(
Sü—mTx
 *
·»Á
,

392 
RQueueIçû
 *
¹pQueue
,

393 
ušt32_t
 
s¤c
,

394 
´iÜ™y
,

395 
mšB™¿‹
,

396 
¡¬tB™¿‹
,

397 
maxB™¿‹
,

398 
¿mpUpS³ed
,

399 
¿mpUpSÿË
,

400 
maxRQueueD–ay
,

401 
txQueueSizeFaùÜ
,

402 
queueD–ayGu¬d
,

403 
lossEv’tR©eSÿË
,

404 
eúCeEv’tR©eSÿË
,

405 
boŞ
 
isAd­tiveT¬g‘R©eSÿË
,

406 
hy¡”esis
);

408 
g‘MaxR©e
();

410 
g‘T¬g‘B™¿‹
();

412 
upd©eR©e
(
ušt32_t
 
time_Áp
);

414 
upd©eT¬g‘B™¿‹I
(
br
);

416 
upd©eT¬g‘B™¿‹
(
ušt32_t
 
time_Áp
);

418 
boŞ
 
isRQueueDisÿrd
();

420 
boŞ
 
isM©ch
(
ušt32_t
 
s¤c_
è{  
s¤c
 == ssrc_; };

422 
boŞ
 
isLossEpoch
();

424 
£tR©eHy¡”esis
(
aV®ue
) {

425 
hy¡”esis
 = 
aV®ue
;

429 
Sü—mTx
 *
·»Á
;

430 
RQueueIçû
 *
¹pQueue
;

431 
ušt32_t
 
s¤c
;

432 
¿mpUpS³ed
;

433 
¿mpUpSÿË
;

434 
maxRQueueD–ay
;

435 
txQueueSizeFaùÜ
;

436 
queueD–ayGu¬d
;

437 
lossEv’tR©eSÿË
;

438 
eúCeEv’tR©eSÿË
;

439 
boŞ
 
isAd­tiveT¬g‘R©eSÿË
;

440 
hy¡”esis
;

442 
üed™
;

444 
üed™Lo¡
;

446 
rg‘PriÜ™y
;

447 
rg‘PriÜ™yInv
;

448 
by‹sT¿nsm™‹d
;

449 
by‹sAcked
;

450 
by‹sLo¡
;

451 
ušt64_t
 
·ck‘Lo¡
;

452 
ušt64_t
 
·ck‘sCe
;

453 
by‹sCe
;

454 
¿‹T¿nsm™‹d
;

455 
¿‹Acked
;

456 
¿‹Lo¡
;

457 
¿‹Ce
;

458 
ušt16_t
 
hiSeqAck
;

459 
ušt16_t
 
hiSeqTx
;

460 
mšB™¿‹
;

461 
maxB™¿‹
;

462 
rg‘B™¿‹
;

463 
rg‘B™¿‹I
;

464 
rg‘B™¿‹H
;

465 
boŞ
 
wasFa¡S¹
;

466 
boŞ
 
lossEv’tFÏg
;

467 
boŞ
 
eúCeEv’tFÏg
;

468 
txSizeB™sAvg
;

469 
ušt32_t
 
Ï¡B™¿‹Adju¡T_Áp
;

470 
ušt32_t
 
Ï¡R©eUpd©eT_Áp
;

471 
ušt32_t
 
Ï¡T¬g‘B™¿‹IUpd©eT_Áp
;

473 
ušt32_t
 
timeTxAck_Áp
;

474 
ušt32_t
 
Ï¡T¿nsm™T_Áp
;

476 
by‹sR
;

477 
ušt64_t
 
·ck‘sR
;

478 
¿‹R
;

479 
¿‹RHi¡
[
kR©eUpD©eSize
];

480 
¿‹AckedHi¡
[
kR©eUpD©eSize
];

481 
¿‹Lo¡Hi¡
[
kR©eUpD©eSize
];

482 
¿‹CeHi¡
[
kR©eUpD©eSize
];

483 
¿‹T¿nsm™‹dHi¡
[
kR©eUpD©eSize
];

484 
¿‹Upd©eHi¡PŒ
;

485 
rg‘B™¿‹Hi¡
[
kT¬g‘B™¿‹Hi¡Size
];

486 
rg‘B™¿‹Hi¡PŒ
;

487 
ušt32_t
 
rg‘B™¿‹Hi¡Upd©eT_Áp
;

488 
rg‘R©eSÿË
;

489 
ušt32_t
 
numb”OfUpd©eR©e
;

491 
boŞ
 
isAùive
;

492 
ušt32_t
 
Ï¡F¿meT_Áp
;

493 
ušt32_t
 
š™Time_Áp
;

494 
boŞ
 
¹pQueueDisÿrd
;

495 
ušt32_t
 
Ï¡RQueueDisÿrdT_Áp
;

496 
boŞ
 
wasR•aœLoss
;

497 
boŞ
 
»·œLoss
;

498 
ušt32_t
 
Ï¡FuÎWšdowT_Áp
;

500 
T¿nsm™‹d
 
txPack‘s
[
kMaxTxPack‘s
];

501 
txPack‘sPŒ
;

502 
boŞ
 
lossEpoch
;

503 
ušt64_t
 
ş—»d
;

509 
š™Ÿlize
(
ušt32_t
 
time_Áp
);

515 
boŞ
 
m¬kAcked
(
ušt32_t
 
time_Áp
,

516 
T¿nsm™‹d
 *
txPack‘s
,

517 
ušt16_t
 
£qNr
,

518 
ušt32_t
 
time¡amp
,

519 
SŒ—m
 *
¡»am
,

520 
ušt8_t
 
ûB™s
,

521 &
’cCeM¬kedBy‹s
,

522 
boŞ
 
isLa¡
,

523 
boŞ
 &
isM¬k
);

528 
g‘TÙ®T¬g‘B™¿‹
();

533 
upd©eCwnd
(
ušt32_t
 
time_Áp
);

538 
d‘eùLoss
(
ušt32_t
 
time_Áp
, 
T¿nsm™‹d
 *
txPack‘s
, 
ušt16_t
 
highe¡SeqNr
, 
SŒ—m
 *
¡»am
);

543 
d‘”mšeAùiveSŒ—ms
(
ušt32_t
 
time_Áp
);

550 
compu‹QueueD–ayT»nd
();

556 
e¡im©eOwd
(
ušt32_t
 
time_Áp
);

561 
ušt32_t
 
g‘Ba£Owd
();

566 
compu‹Sbd
();

571 
boŞ
 
isCom³tšgFlows
();

576 
SŒ—m
* 
g‘SŒ—m
(
ušt32_t
 
s¤c
, &
¡»amId
);

581 
adju¡PriÜ™›s
(
ušt32_t
 
time_Áp
);

588 
SŒ—m
* 
g‘PriÜ™izedSŒ—m
(
ušt32_t
 
time_Áp
);

593 
addC»d™
(
ušt32_t
 
time_Áp
,

594 
SŒ—m
* 
£rvedSŒ—m
,

595 
Œªsm™‹dBy‹s
);

600 
subŒaùC»d™
(
ušt32_t
 
time_Áp
,

601 
SŒ—m
* 
£rvedSŒ—m
,

602 
Œªsm™‹dBy‹s
);

607 
isInFa¡S¹
(è{  
šFa¡S¹
 ? 1 : 0; };

612 
g‘QueueD–ayF¿ùiÚ
();

617 
g‘QueueD–ayT»nd
();

626 
lossB‘a
;

627 
eúCeB‘a
;

628 
queueD–ayT¬g‘Mš
;

629 
boŞ
 
’abËSbd
;

630 
gašUp
;

631 
gašDown
;

632 
·ck‘PacšgH—droom
;

634 
ušt32_t
 
sR‰Sh_Áp
;

635 
ušt32_t
 
sR‰_Áp
;

636 
sR‰
;

637 
ušt32_t
 
ackedOwd
;

638 
ušt32_t
 
ba£Owd
;

640 
ušt32_t
 
ba£OwdHi¡
[
kBa£OwdHi¡Size
];

641 
ba£OwdHi¡PŒ
;

642 
ušt32_t
 
ba£OwdHi¡Mš
;

643 
ušt32_t
 
şockDriáCom³n§tiÚ
;

644 
ušt32_t
 
şockDriáCom³n§tiÚInc
;

646 
queueD–ay
;

647 
queueD–ayF¿ùiÚAvg
;

648 
queueD–ayF¿ùiÚHi¡
[
kQueueD–ayF¿ùiÚHi¡Size
];

649 
queueD–ayF¿ùiÚHi¡PŒ
;

650 
queueD–ayT»nd
;

651 
queueD–ayT¬g‘
;

652 
queueD–ayNÜmHi¡
[
kQueueD–ayNÜmHi¡Size
];

653 
queueD–ayNÜmHi¡PŒ
;

654 
queueD–aySbdV¬
;

655 
queueD–aySbdM—n
;

656 
queueD–aySbdSkew
;

657 
queueD–aySbdM—nSh
;

658 
queueD–ayMax
;

663 
by‹sNewlyAcked
;

664 
mss
;

665 
cwnd
;

666 
cwndMš
;

667 
cwndMšLow
;

668 
boŞ
 
İ’Wšdow
;

669 
boŞ
 
’abËClockDriáCom³n§tiÚ
;

670 
by‹sInFlight
;

671 
by‹sInFlightLog
;

672 
by‹sInFlightHi¡Lo
[
kBy‹sInFlightHi¡SizeMax
];

673 
by‹sInFlightHi¡Hi
[
kBy‹sInFlightHi¡SizeMax
];

674 
by‹sInFlightHi¡Size
;

675 
by‹sInFlightHi¡PŒ
;

676 
by‹sInFlightMaxLo
;

677 
by‹sInFlightHi¡LoMem
;

678 
by‹sInFlightMaxHi
;

679 
by‹sInFlightHi¡HiMem
;

680 
maxBy‹sInFlight
;

681 
accBy‹sInFlightMax
;

682 
nAccBy‹sInFlightMax
;

683 
¿‹T¿nsm™‹d
;

684 
¿‹Acked
;

685 
¿‹R
;

686 
queueD–ayT»ndMem
;

687 
maxR©e
;

688 
ušt32_t
 
Ï¡CwndUpd©eT_Áp
;

689 
boŞ
 
isL4s
;

690 
l4sAÍha
;

691 
by‹sM¬kedThisR‰
;

692 
by‹sD–iv”edThisR‰
;

693 
ušt32_t
 
Ï¡L4sAÍhaUpd©eT_Áp
;

694 
maxTÙ®B™¿‹
;

695 
po¡CÚge¡iÚSÿË
;

696 
po¡CÚge¡iÚD–ay
;

697 
by‹sInFlightR©io
;

702 
boŞ
 
lossEv’t
;

703 
boŞ
 
wasLossEv’t
;

704 
lossEv’tR©e
;

709 
boŞ
 
eúCeEv’t
;

710 
boŞ
 
isCeThisF“dback
;

716 
boŞ
 
šFa¡S¹
;

721 
ušt32_t
 
·ûIÁ”v®_Áp
;

722 
·ûIÁ”v®
;

723 
¿‹T¿nsm™‹dAvg
;

728 
boŞ
 
isIn™Ÿlized
;

729 
ušt32_t
 
Ï¡SR‰Upd©eT_Áp
;

730 
ušt32_t
 
Ï¡Ba£OwdAddT_Áp
;

731 
ušt32_t
 
ba£OwdRe£tT_Áp
;

732 
ušt32_t
 
Ï¡AddToQueueD–ayF¿ùiÚHi¡T_Áp
;

733 
ušt32_t
 
Ï¡By‹sInFlightT_Áp
;

734 
ušt32_t
 
Ï¡CÚge¡iÚD‘eùedT_Áp
;

735 
ušt32_t
 
Ï¡LossEv’tT_Áp
;

736 
ušt32_t
 
Ï¡T¿nsm™T_Áp
;

737 
ušt32_t
 
ÃxtT¿nsm™T_Áp
;

738 
ušt32_t
 
Ï¡R©eUpd©eT_Áp
;

739 
ušt32_t
 
Ï¡Adju¡PriÜ™›sT_Áp
;

740 
ušt32_t
 
Ï¡R‰T_Áp
;

741 
ušt32_t
 
Ï¡Ba£D–ayReäeshT_Áp
;

742 
ušt32_t
 
š™Time_Áp
;

743 
queueD–ayMš
;

744 
queueD–ayMšAvg
;

745 
boŞ
 
’abËR©eUpd©e
;

750 
SŒ—m
 *
¡»ams
[
kMaxSŒ—ms
];

751 
nSŒ—ms
;

756 
Sti¡ics
 *
¡©i¡ics
;

757 
d‘aedLogExŒaD©a
[256];

762 
FILE
 *
å_log
;

763 
boŞ
 
com¶‘eLogI‹m
;

764 
timeSŒšg
[100];

765 
boŞ
 
isU£ExŒaD‘aedLog
;

766 
by‹sNewlyAckedLog
;

767 
eúCeM¬kedBy‹sLog
;

	@scream/code/TxList.h

	@scream/code/VideoEnc.cpp

1 
	~"VideoEnc.h
"

2 
	~"RQueue.h
"

3 
	~<¡ršg.h
>

4 
	~<io¡»am
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<®gÜ™hm
>

9 
usšg
 
Çme¥aû
 
	g¡d
;

11 cÚ¡ 
	gkMaxRSize
 = 1200;

12 cÚ¡ 
	gkROv”H—d
 = 12;

14 
	gVideoEnc
::
	$VideoEnc
(
RQueue
* 
¹pQueue_
, 
äameR©e_
, *
âame
, 
ixOff£t_
) {

15 
¹pQueue
 = 
¹pQueue_
;

16 
äameR©e
 = 
äameR©e_
;

17 
ix
 = 
ixOff£t_
;

18 
nF¿mes
 = 0;

19 
£qNr
 = 0;

20 
nomš®B™¿‹
 = 0.0;

21 
FILE
 *
å
 = 
	`fİ’
(
âame
,"r");

22 
s
[100];

23 
sum
 = 0.0;

24 
	`fg‘s
(
s
,99,
å
)) {

25 ià(
nF¿mes
 < 
MAX_FRAMES
 - 1) {

26 
x
 = 
	`©of
(
s
);

27 
äameSize
[
nF¿mes
] = 
x
;

28 
nF¿mes
++;

29 
sum
 +ğ
x
;

32 
t
 = 
nF¿mes
 / 
äameR©e
;

33 
nomš®B™¿‹
 = 
sum
 * 8 / 
t
;

34 
	`fşo£
(
å
);

35 
	}
}

37 
	gVideoEnc
::
	$£tT¬g‘B™¿‹
(
rg‘B™¿‹_
) {

38 
rg‘B™¿‹
 = 
rg‘B™¿‹_
;

39 
	}
}

41 
	gVideoEnc
::
	$’code
(
time
) {

42 
¹pBy‹s
 = 0;

43 
¹pPack‘
[2000];

44 
by‹s
 = ()(
äameSize
[
ix
] / 
nomš®B™¿‹
 * 
rg‘B™¿‹
);

45 
nomš®B™¿‹
 = 0.95*nomš®B™¿‹ + 0.05*
äameSize
[
ix
] * 
äameR©e
 * 8;

46 
ix
++; ià(ix =ğ
nF¿mes
) ix = 0;

47 
by‹s
 > 0) {

48 
¹pSize
 = 
¡d
::
	`mš
(
kMaxRSize
, 
by‹s
);

49 
by‹s
 -ğ
¹pSize
;

50 
¹pSize
 +ğ
kROv”H—d
;

51 
¹pBy‹s
 +ğ
¹pSize
;

52 
¹pQueue
->
	`push
(
¹pPack‘
, 
¹pSize
, 
£qNr
, 
çl£
, 
time
);

53 
£qNr
++;

55 
¹pQueue
->
	`£tSizeOfLa¡F¿me
(
¹pBy‹s
);

56  
¹pBy‹s
;

57 
	}
}

	@scream/code/VideoEnc.h

1 #iâdeà
VIDEO_ENC


2 
	#VIDEO_ENC


	)

4 
şass
 
	gRQueue
;

5 
	#MAX_FRAMES
 10000

	)

6 şas 
	cVideoEnc
 {

7 
	mpublic
:

8 
VideoEnc
(
RQueue
* 
¹pQueue
, 
äameR©e
, *
âame
, 
ixOff£t
=0);

10 
’code
(
time
);

12 
£tT¬g‘B™¿‹
(
rg‘B™¿‹
);

14 
RQueue
* 
	m¹pQueue
;

15 
	mäameSize
[
MAX_FRAMES
];

16 
	mnF¿mes
;

17 
	mrg‘B™¿‹
;

18 
	mäameR©e
;

19 
	mnomš®B™¿‹
;

20 
	m£qNr
;

21 
	mix
;

	@scream/code/scream_receiver.cpp

2 
	~"Sü—mRx.h
"

3 
	~"sys/sock‘.h
"

4 
	~"sys/ty³s.h
"

5 
	~"Ãtš‘/š.h
"

6 
	~<¡ršg.h
>

7 
	~<sys/sock‘.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<¬·/š‘.h
>

10 
	~<sys/time.h
>

11 
	~<io¡»am
>

12 
	~<fú.h
>

13 
	~<uni¡d.h
>

14 
	~<±h»ad.h
>

15 
usšg
 
Çme¥aû
 
	g¡d
;

17 
	#BUFSIZE
 2048

	)

18 
	#ECN_CAPABLE


	)

19 
	#IS_STANDARD_FEEDBACK


	)

23 
	gfd_šcomšg_¹p
;

27 
	gfd_outgošg_¹ı
;

28 
Sü—mRx
 *
	gsü—mRx
 = 0;

32 
¡ršg
 
	gSENDER_IP
 = "192.168.0.20";

33 
	gINCOMING_RTP_PORT
 = 30122;

34 
sockaddr_š
 
	gšcomšg_¹p_addr
, 
	goutgošg_¹ı_addr
, 
	g£nd”_¹ı_addr
;

35 
sockaddr_š
 
	gloÿl_¹p_addr
;

37 
¡ršg
 
	gLOCAL_IP
 = "127.0.0.1";

38 
	gLOCAL_PORT
 = 30124;

40 
	gackDiff
 = -1;

41 
	gnR•Ü‹dRPack‘s
 = 64;

43 *
	giâame
 = 0;

45 
	gnPršt
 = 0;

46 
±h»ad_mu‹x_t
 
	glock_sü—m
;

47 
	gt0
 = 0;

54 
ušt32_t
 
	$g‘TimeInN
() {

55 
timev®
 

;

56 
	`g‘timeofday
(&

, 
NULL
);

57 
time
 = (

.
tv_£c
 +p.
tv_u£c
*1e-6è- 
t0
;

58 
ušt64_t
 
Áp64
 = 
	`ušt64_t
(
time
 * 65536);

59 
ušt32_t
 
Áp
 = 0xFFFFFFFF & (
Áp64
);

60  
Áp
;

61 
	}
}

78 
	$·r£R
(* 
buf
, 
ušt16_t
* 
£qNr
, 
ušt32_t
* 
timeSmp
) {

79 
ušt16_t
 
¿wSeq
;

80 
ušt32_t
 
¿wTs
;

81 
	`memıy
(&
¿wSeq
, 
buf
 + 2, 2);

82 
	`memıy
(&
¿wTs
, 
buf
 + 4, 4);

83 *
£qNr
 = 
	`Áohs
(
¿wSeq
);

84 *
timeSmp
 = 
	`Áohl
(
¿wTs
);

85 
	}
}

87 
ušt16_t
 
	gÏ¡FbSn
 = 0;

88 
ušt64_t
 
	gÏ¡PunchN©T_Áp
 = 0;

89 
ušt32_t
 
	gSSRC
 = 100;

90 
	#KEEP_ALIVE_PKT_SIZE
 1

	)

92 *
	$¹ıP”iodicTh»ad
(*
¬g
) {

93 
buf
[
BUFSIZE
];

94 
¹ıSize
;

95 
ušt32_t
 
¹ıFbIÁ”v®_Áp
 = 
sü—mRx
->
	`g‘RtıFbIÁ”v®
();

97 ià(
	`g‘TimeInN
(è- 
Ï¡PunchN©T_Áp
 > 32768) {

103 
»t
 = 
	`£ndto
(
fd_šcomšg_¹p
, 
buf
, 
KEEP_ALIVE_PKT_SIZE
, 0, (
sockaddr
 *)&
outgošg_¹ı_addr
, (outgoing_rtcp_addr));

104 
Ï¡PunchN©T_Áp
 = 
	`g‘TimeInN
();

105 
û¼
 << "." << 
’dl
;

107 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

108 
¹ıFbIÁ”v®_Áp
 = 
sü—mRx
->
	`g‘RtıFbIÁ”v®
();

109 ià(
sü—mRx
->
	`isF“dback
(
time_Áp
) &&

110 (
sü—mRx
->
	`checkIfFlushAck
() ||

111 (
time_Áp
 - 
sü—mRx
->
	`g‘La¡F“dbackT
(è> 
¹ıFbIÁ”v®_Áp
))) {

112 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

113 
boŞ
 
isF“dback
 = 
sü—mRx
->
	`ü—‹Snd¬dizedF“dback
(
	`g‘TimeInN
(), 
Œue
, 
buf
, 
¹ıSize
);

114 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

115 ià(
isF“dback
) {

116 
	`£ndto
(
fd_šcomšg_¹p
, 
buf
, 
¹ıSize
, 0, (
sockaddr
 *)&
outgošg_¹ı_addr
, (outgoing_rtcp_addr));

117 
Ï¡PunchN©T_Áp
 = 
	`g‘TimeInN
();

120 
	`u¦“p
(500);

122 
	}
}

124 
	$maš
(
¬gc
, * 
¬gv
[])

126 
buf
[
BUFSIZE
];

127 
buf_¹ı
[
BUFSIZE
];

128 ià(
¬gc
 <= 1) {

129 
û¼
 << "SCReAM BWe¡oŞ,„eûiv”. EricssÚ AB. V”siÚ 2022-06-10" << 
’dl
;

130 
û¼
 << "U§g:" << 
’dl
 << " > scream_bw_test_rx <options> sender_ip sender_port" <<ƒndl;

131 
û¼
 << " -ackdifà s‘hmax di¡ªû iÀ»ûived RTP tØ£nd‡ÀACK " << 
’dl
;

132 
û¼
 << " -Ä•Ü‹d s‘hnumb” oà»pÜ‹d RTP…ack‘ ³¸ACK " << 
’dl
;

133 
û¼
 << " -iàÇm bšdØ¥ecifiøš‹rçû" << 
’dl
;

134 
	`ex™
(-1);

137 
ix
 = 1;

139 ià(
¬gc
 > (
ix
 + 1è&& 
	`¡r¡r
(
¬gv
[ix], "-ackdiff")) {

140 
ackDiff
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

141 
ix
 += 2;

144 ià(
¬gc
 > (
ix
 + 1è&& 
	`¡r¡r
(
¬gv
[ix], "-nreported")) {

145 
nR•Ü‹dRPack‘s
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

146 
ix
 += 2;

149 ià(
¬gc
 > (
ix
 + 1è&& 
	`¡r¡r
(
¬gv
[ix], "-if")) {

150 
iâame
 = 
¬gv
[
ix
 + 1];

151 
ix
 += 2;

154 ià(
¬gc
 > (
ix
 + 1)) {

155 
SENDER_IP
 = 
¬gv
[
ix
];

156 
INCOMING_RTP_PORT
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

158 
û¼
 << "Insuffic›Á…¬am‘”s." << 
’dl
;

159 
	`ex™
(-1);

163 
timev®
 

;

164 
	`g‘timeofday
(&

, 
NULL
);

165 
t0
 = (

.
tv_£c
 +p.
tv_u£c
*1e-6) - 1e-3;

167 
sü—mRx
 = 
Ãw
 
	`Sü—mRx
(10, 
ackDiff
, 
nR•Ü‹dRPack‘s
);

169 
šcomšg_¹p_addr
.
sš_çmy
 = 
AF_INET
;

170 
šcomšg_¹p_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

171 
šcomšg_¹p_addr
.
sš_pÜt
 = 
	`htÚs
(
INCOMING_RTP_PORT
);

173 
outgošg_¹ı_addr
.
sš_çmy
 = 
AF_INET
;

174 
	`š‘_©Ú
(
SENDER_IP
.
	`c_¡r
(), (
š_addr
*)&
outgošg_¹ı_addr
.
sš_addr
.
s_addr
);

175 
outgošg_¹ı_addr
.
sš_pÜt
 = 
	`htÚs
(
INCOMING_RTP_PORT
);

178 
loÿl_¹p_addr
.
sš_çmy
 = 
AF_INET
;

179 
	`š‘_©Ú
(
LOCAL_IP
.
	`c_¡r
(), (
š_addr
*)&
loÿl_¹p_addr
.
sš_addr
.
s_addr
);

180 
loÿl_¹p_addr
.
sš_pÜt
 = 
	`htÚs
(
LOCAL_PORT
);

182 ià((
fd_šcomšg_¹p
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

183 
	`³¼Ü
("cannot create socket for incoming RTP…ackets");

188 ià(
iâame
 != 0) {

189 cÚ¡ 
Ën
 = 
	`¡¾’
(
iâame
);

190 ià(
	`£tsockİt
(
fd_šcomšg_¹p
, 
SOL_SOCKET
, 
SO_BINDTODEVICE
, 
iâame
, 
Ën
) < 0) {

191 
	`³¼Ü
("setsockopt(SO_BINDTODEVICE) failed");

196 
’abË
 = 1;

197 ià(
	`£tsockİt
(
fd_šcomšg_¹p
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
’abË
, ()) < 0) {

198 
	`³¼Ü
("setsockopt(SO_REUSEADDR) failed");

201 
£t
 = 0x03;

202 ià(
	`£tsockİt
(
fd_šcomšg_¹p
, 
IPPROTO_IP
, 
IP_RECVTOS
, &
£t
, (set)) < 0) {

203 
û¼
 << "ÿÂÙ s‘„ecvto Ú incomšg sock‘" << 
’dl
;

207 
û¼
 << "sock‘ s‘Ø»cvtos" << 
’dl
;

210 
ušt64_t
 
»cv_buf_size
 = 1024*1024*20;

211 ià(
	`£tsockİt
(
fd_šcomšg_¹p
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
»cv_buf_size
,(recv_buf_size)) < 0) {

212 
û¼
 << "ÿÂÙ s‘ SO_RCVBUF oÀšcomšg sock‘" << 
’dl
;

214 
û¼
 << "sock‘ SO_RCVBUF s‘Ø" << 
»cv_buf_size
 << 
’dl
;

217 ià(
	`bšd
(
fd_šcomšg_¹p
, (
sockaddr
 *)&
šcomšg_¹p_addr
, (incoming_rtp_addr)) < 0) {

218 
	`³¼Ü
("bind incoming_rtp_addr failed");

222 
û¼
 << "Li¡’ oÀpÜˆ" << 
INCOMING_RTP_PORT
 << "Ø»ûivRTP from s’d” " << 
’dl
;

225 
sockaddr_š
 
£nd”_¹p_addr
;

226 
sockËn_t
 
add¾’_£nd”_¹p_addr
 = (
£nd”_¹p_addr
);

228 
»cvËn
;

230 
ušt32_t
 
Ï¡_»ûived_time_Áp
 = 0;

231 
ušt32_t
 
»ûivedR
 = 0;

238 
	`£ndto
(
fd_šcomšg_¹p
, 
buf
, 
KEEP_ALIVE_PKT_SIZE
, 0, (
sockaddr
 *)&
outgošg_¹ı_addr
, (outgoing_rtcp_addr));

239 
Ï¡PunchN©T_Áp
 = 
	`g‘TimeInN
();

241 
±h»ad_t
 
¹ı_th»ad
;

242 
	`±h»ad_ü—‹
(&
¹ı_th»ad
, 
NULL
, 
¹ıP”iodicTh»ad
, (*)"Periodic RTCPhread...");

244 
ušt16_t
 
Ï¡Sn
 = 0;

245 
	`±h»ad_mu‹x_š™
(&
lock_sü—m
, 
NULL
);

248 
	#MAX_CTRL_SIZE
 8192

	)

249 
	#MAX_BUF_SIZE
 65536

	)

251 *
eú±r
;

252 
»ûived_eú
;

254 
msghdr
 
rcv_msg
;

255 
iovec
 
rcv_iov
[1];

256 
rcv_ù¾_d©a
[
MAX_CTRL_SIZE
];

257 
rcv_buf
[
MAX_BUF_SIZE
];

260 
rcv_iov
[0].
iov_ba£
 = 
rcv_buf
;

261 
rcv_iov
[0].
iov_Ën
 = 
MAX_BUF_SIZE
;

263 
rcv_msg
.
msg_Çme
 = 
NULL
;

264 
rcv_msg
.
msg_Çm–’
 = 0;

265 
rcv_msg
.
msg_iov
 = 
rcv_iov
;

266 
rcv_msg
.
msg_iovËn
 = 1;

267 
rcv_msg
.
msg_cÚŒŞ
 = 
rcv_ù¾_d©a
;

268 
rcv_msg
.
msg_cÚŒŞËn
 = 
MAX_CTRL_SIZE
;

279 
»ûived_eú
;

280 #ifdeà
ECN_CAPABLE


281 
»cvËn
 = 
	`»cvmsg
(
fd_šcomšg_¹p
, &
rcv_msg
, 0);

282 ià(
»cvËn
 == -1) {

283 
	`³¼Ü
("recvmsg()");

284 
	`şo£
(
fd_šcomšg_¹p
);

285  
EXIT_FAILURE
;

288 
cmsghdr
 *
cm±r
;

289 *
eú±r
;

290 
cm±r
 = 
	`CMSG_FIRSTHDR
(&
rcv_msg
);

291 
cm±r
 !ğ
NULL
;

292 
cm±r
 = 
	`CMSG_NXTHDR
(&
rcv_msg
, cmptr)) {

293 ià(
cm±r
->
cmsg_Ëv–
 =ğ
IPPROTO_IP
 && cm±r->
cmsg_ty³
 =ğ
IP_TOS
) {

294 
eú±r
 = (*)
	`CMSG_DATA
(
cm±r
);

295 
»ûived_eú
 = *
eú±r
;

298 
	`memıy
(
buf
, 
rcv_msg
.
msg_iov
[0].
iov_ba£
, 
»cvËn
);

301 
»cvËn
 = 
	`»cväom
(
fd_šcomšg_¹p
, 
buf
, 
BUFSIZE
, 0, (
sockaddr
 *)&
£nd”_¹p_addr
, &
add¾’_£nd”_¹p_addr
);

303 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

304 ià(
»cvËn
 > 1) {

305 ià(
buf
[1] == 0x7F) {

307 
»cvËn
 -= 2;

308 
s
[1000];

309 
	`memıy
(
s
, &
buf
[2], 
»cvËn
);

310 
s
[
»cvËn
] = 0x00;

311 
cout
 << 
s
 << 
’dl
;

314 ià(
time_Áp
 - 
Ï¡_»ûived_time_Áp
 > 2 * 65536) {

319 
»ûivedR
 = 0;

320 
d–‘e
 
sü—mRx
;

321 
sü—mRx
 = 
Ãw
 
	`Sü—mRx
(10, 
ackDiff
, 
nR•Ü‹dRPack‘s
);

322 
û¼
 << "Reûiv” s‹„e£ˆdutØidË iÅut" << 
’dl
;

324 
Ï¡_»ûived_time_Áp
 = 
time_Áp
;

325 
»ûivedR
++;

329 
ušt16_t
 
£qNr
;

330 
ušt32_t
 
ts
;

331 
	`·r£R
(
buf
, &
£qNr
, &
ts
);

332 
boŞ
 
isM¬k
 = (
buf
[1] & 0x80) != 0;

333 
ušt16_t
 
diff
 = 
£qNr
 - 
Ï¡Sn
;

334 ià(
diff
 > 1) {

335 
	`årštf
(
¡d”r
, "Pack‘(sèlo¡ o¸»Üd”ed : %5d wa »ûived,…»viou rcvd i %5d \n", 
£qNr
, 
Ï¡Sn
);

337 
Ï¡Sn
 = 
£qNr
;

341 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

342 
sü—mRx
->
	`»ûive
(
	`g‘TimeInN
(), 0, 
SSRC
, 
»cvËn
, 
£qNr
, 
»ûived_eú
);

343 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

345 ià(
sü—mRx
->
	`checkIfFlushAck
(è|| 
isM¬k
) {

346 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

347 
¹ıSize
;

348 
boŞ
 
isF“dback
 = 
sü—mRx
->
	`ü—‹Snd¬dizedF“dback
(
	`g‘TimeInN
(), 
isM¬k
, 
buf_¹ı
, 
¹ıSize
);

349 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

350 ià(
isF“dback
) {

351 
	`£ndto
(
fd_šcomšg_¹p
, 
buf_¹ı
, 
¹ıSize
, 0, (
sockaddr
 *)&
outgošg_¹ı_addr
, (outgoing_rtcp_addr));

352 
Ï¡PunchN©T_Áp
 = 
	`g‘TimeInN
();

358 
	}
}

	@scream/code/scream_sender.cpp

2 
	~"Sü—mTx.h
"

3 
	~"RQueue.h
"

4 
	~"sys/sock‘.h
"

5 
	~"sys/ty³s.h
"

6 
	~"Ãtš‘/š.h
"

7 
	~<¡ršg.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<sys/time.h
>

12 
	~<io¡»am
>

13 
	~<±h»ad.h
>

14 
	~<fú.h
>

15 
	~<uni¡d.h
>

16 
	~<sys/time.h
>

17 
	~<sigÇl.h
>

18 
	~<sys/tim”fd.h
>

19 
™im”v®
 
	gtim”
;

20 
sigaùiÚ
 
	g§
;

22 
	s³riodicInfo


24 
	mtim”_fd
;

25 
	mwakeupsMis£d
;

28 
usšg
 
Çme¥aû
 
	g¡d
;

30 
	#BUFSIZE
 2048

	)

32 
	gmšPaûIÁ”v®
 = 0.002f;

33 
	gmšPaûIÁ”v®Us
 = 1900;

35 
	#ECN_CAPABLE


	)

43 
	geù
 = -1;

45 
	gs›¼aLogSŒšg
[
BUFSIZE
] = " 0, 0, 0, 0";

46 
	gFPS
 = 50.0f;

47 
ušt32_t
 
	gSSRC
 = 100;

48 
	gfixedR©e
 = 0;

49 
boŞ
 
	gisKeyF¿me
 = 
çl£
;

50 
boŞ
 
	gdi§bËPacšg
 = 
çl£
;

51 
	gkeyF¿meIÁ”v®
 = 0.0;

52 
	gkeyF¿meSize
 = 1.0;

53 
	gš™R©e
 = 1000;

54 
	gmšR©e
 = 1000;

55 
	gmaxR©e
 = 200000;

56 
	g¿‹Inü—£
 = 10000;

57 
	g¿‹SÿË
 = 0.5f;

58 
	gdsÿË
 = 10.0f;

59 
boŞ
 
	g’abËClockDriáCom³n§tiÚ
 = 
çl£
;

60 
	gbur¡Time
 = -1.0;

61 
	gbur¡SË•
 = -1.0;

62 
boŞ
 
	gisBur¡
 = 
çl£
;

63 
	gbur¡S¹Time
 = -1.0;

64 
	gbur¡SË•Time
 = -1.0;

65 
boŞ
 
	gpushT¿ffic
 = 
çl£
;

66 
	g·ck‘PacšgH—droom
 = 1.25f;

67 
	gtxQueueSizeFaùÜ
 = 0.1f;

68 
	gqueueD–ayGu¬d
 = 0.05f;

69 
	ghy¡”esis
 = 0.0;

71 
	g³riodicR©eDrİIÁ”v®
 = 600;

74 
ušt16_t
 
	g£qNr
 = 0;

75 
ušt32_t
 
	gÏ¡KeyF¿meT_Áp
 = 0;

76 
	gmtu
 = 1200;

77 
	grunTime
 = -1.0;

78 
boŞ
 
	g¡İTh»ad
 = 
çl£
;

79 
±h»ad_t
 
	gü—‹_¹p_th»ad
 = 0;

80 
±h»ad_t
 
	gŒªsm™_¹p_th»ad
 = 0;

81 
±h»ad_t
 
	g¹ı_th»ad
 = 0;

82 
±h»ad_t
 
	gs›¼a_pythÚ_th»ad
 = 0;

83 
boŞ
 
	gs›¼aLog
;

85 
	gsÿËFaùÜ
 = 0.9f;

86 
	gd–ayT¬g‘
 = 0.06f;

87 
boŞ
 
	g´štSumm¬y
 = 
Œue
;

89 
	gfd_outgošg_¹p
;

90 
	gfd_s›¼a_pythÚ
;

91 
Sü—mTx
 *
	gsü—mTx
 = 0;

92 
RQueue
 *
	g¹pQueue
 = 0;

96 cÚ¡ *
	gDECODER_IP
 = "192.168.0.21";

97 
	gDECODER_PORT
 = 30110;

98 cÚ¡ *
	gDUMMY_IP
 = "217.10.68.152";

100 
	gSIERRA_PYTHON_PORT
 = 35000;

102 
sockaddr_š
 
	goutgošg_¹p_addr
;

103 
sockaddr_š
 
	gšcomšg_¹ı_addr
;

104 
sockaddr_š
 
	gdummy_¹ı_addr
;

105 
sockaddr_š
 
	gs›¼a_pythÚ_addr
;

107 
	gbuf_¹ı
[
BUFSIZE
];

109 
	gbuf_s›¼a
[
BUFSIZE
];

111 
sockËn_t
 
	gadd¾’_outgošg_¹p
;

112 
sockËn_t
 
	gadd¾’_dummy_¹ı
;

113 
ušt32_t
 
	gÏ¡LogT_Áp
 = 0;

114 
ušt32_t
 
	gÏ¡LogTv_Áp
 = 0;

115 
ušt32_t
 
	gtD_Áp
 = 0;

116 
sockËn_t
 
	gadd¾’_šcomšg_¹ı
 = (
šcomšg_¹ı_addr
);

117 
sockËn_t
 
	gadd¾’_s›¼a_pythÚ_addr
 = (
s›¼a_pythÚ_addr
);

118 
±h»ad_mu‹x_t
 
	glock_sü—m
;

119 
±h»ad_mu‹x_t
 
	glock_¹p_queue
;

120 
±h»ad_mu‹x_t
 
	glock_·û
;

122 
FILE
 *
	gå_log
 = 0;

124 *
	giâame
 = 0;

127 
boŞ
 
	gÁp
 = 
çl£
;

128 
boŞ
 
	g­³nd
 = 
çl£
;

129 
boŞ
 
	g™emli¡
 = 
çl£
;

130 
boŞ
 
	gd‘aed
 = 
çl£
;

131 
	g¿ndR©e
 = 0.0f;

133 
	gt0
 = 0;

143 
	$·ck‘_ä“
(*
buf
) {

144 
	`ä“
(
buf
);

145 
	}
}

147 
ušt32_t
 
	$g‘TimeInN
() {

148 
timev®
 

;

149 
	`g‘timeofday
(&

, 
NULL
);

150 
time
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6 - 
t0
;

151 
ušt64_t
 
Áp64
 = 
	`ušt64_t
(
time
*65536.0);

152 
ušt32_t
 
Áp
 = 0xFFFFFFFF & 
Áp64
;

153  
Áp
;

154 
	}
}

158 
	gaccumuÏ‹dPaûTime
 = 0.0f;

172 
	$·r£R
(*
buf
, 
ušt16_t
* 
£qNr
, 
ušt32_t
* 
timeSmp
, *
±
) {

173 
ušt16_t
 
¿wSeq
;

174 
ušt32_t
 
¿wTs
;

175 
	`memıy
(&
¿wSeq
, 
buf
 + 2, 2);

176 
	`memıy
(&
¿wTs
, 
buf
 + 4, 4);

177 
	`memıy
(
±
, 
buf
 + 1, 1);

178 *
£qNr
 = 
	`Áohs
(
¿wSeq
);

179 *
timeSmp
 = 
	`Áohl
(
¿wTs
);

180 
	}
}

182 
	$wr™eR
(*
buf
, 
ušt16_t
 
£qNr
, 
ušt32_t
 
timeSmp
, 
±
) {

183 
£qNr
 = 
	`htÚs
(seqNr);

184 
timeSmp
 = 
	`htÚl
(timeStamp);

185 
ušt32_t
 
tmp
 = 
	`htÚl
(
SSRC
);

186 
	`memıy
(
buf
 + 2, &
£qNr
, 2);

187 
	`memıy
(
buf
 + 4, &
timeSmp
, 4);

188 
	`memıy
(
buf
 + 8, &
tmp
, 4);

189 
	`memıy
(
buf
 + 1, &
±
, 1);

190 
buf
[0] = 0x80;

191 
	}
}

194 
	$£ndPack‘
(* 
buf
, 
size
) {

195 
	`£ndto
(
fd_outgošg_¹p
, 
buf
, 
size
, 0, (
sockaddr
 *)&
outgošg_¹p_addr
, (outgoing_rtp_addr));

196 
	}
}

203 *
	$Œªsm™RTh»ad
(*
¬g
) {

204 
size
;

205 
ušt16_t
 
£qNr
;

206 
boŞ
 
isM¬k
;

207 
buf
[2000];

208 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

209 
¦“pTime_us
 = 10;

210 
»tV®
 = 0.0f;

211 
sizeOfQueue
;

212 
timev®
 
¡¬t
, 
’d
;

213 
u£cÚds_t
 
diff
 = 0;

214 
·ûIÁ”v®FixedR©e
 = 0.0f;

215 ià(
fixedR©e
 > 0 && !
di§bËPacšg
) {

216 
·ûIÁ”v®FixedR©e
 = (
mtu
 + 40)*8.0à/ (
fixedR©e
 * 1000)*0.9;

219 ià(
¡İTh»ad
) {

220  
NULL
;

223 
¦“pTime_us
 = 1;

224 
»tV®
 = 0.0f;

225 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

226 
time_Áp
 = 
	`g‘TimeInN
();

227 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
SSRC
);

228 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

230 ià(
»tV®
 != -1.0f) {

231 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

232 
sizeOfQueue
 = 
¹pQueue
->
	`sizeOfQueue
();

233 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

235 
	`g‘timeofday
(&
¡¬t
, 0);

236 
time_Áp
 = 
	`g‘TimeInN
();

238 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
SSRC
);

239 ià(
fixedR©e
 > 0 && 
»tV®
 >ğ0.0à&& 
sizeOfQueue
 > 0)

240 
»tV®
 = 
·ûIÁ”v®FixedR©e
;

241 ià(
di§bËPacšg
 && 
sizeOfQueue
 > 0 && 
»tV®
 > 0.0f)

242 
»tV®
 = 0.0f;

243 ià(
»tV®
 > 0.0f)

244 
accumuÏ‹dPaûTime
 +ğ
»tV®
;

245 ià(
»tV®
 != -1.0) {

246 *
buf
;

247 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

248 
¹pQueue
->
	`pİ
(&
buf
, 
size
, 
£qNr
, 
isM¬k
);

249 
	`£ndPack‘
(
buf
, 
size
);

250 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

251 
	`·ck‘_ä“
(
buf
);

252 
buf
 = 
NULL
;

253 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

254 
time_Áp
 = 
	`g‘TimeInN
();

255 
»tV®
 = 
sü—mTx
->
	`addT¿nsm™‹d
(
time_Áp
, 
SSRC
, 
size
, 
£qNr
, 
isM¬k
);

256 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

259 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

260 
sizeOfQueue
 = 
¹pQueue
->
	`sizeOfQueue
();

261 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

262 
	`g‘timeofday
(&
’d
, 0);

263 
diff
 = 
’d
.
tv_u£c
 - 
¡¬t
.tv_usec;

264 
accumuÏ‹dPaûTime
 = 
¡d
::
	`max
(0.0f,‡ccumuÏ‹dPaûTim- 
diff
 * 1e-6f);

265 } 
accumuÏ‹dPaûTime
 <ğ
mšPaûIÁ”v®
 &&

266 
»tV®
 != -1.0f &&

267 
sizeOfQueue
 > 0);

268 ià(
accumuÏ‹dPaûTime
 > 0) {

269 
¦“pTime_us
 = 
¡d
::
	`mš
(()(
accumuÏ‹dPaûTime
*1e6f), 
mšPaûIÁ”v®Us
);

270 
accumuÏ‹dPaûTime
 = 0.0f;

273 
	`u¦“p
(
¦“pTime_us
);

274 
¦“pTime_us
 = 0;

276  
NULL
;

277 
	}
}

279 
	$makeP”iodic
(
³riod
, 
³riodicInfo
 *
šfo
)

281 
»t
;

282 
ns
;

283 
£c
;

284 
fd
;

285 
™im”¥ec
 
™v®
;

288 
fd
 = 
	`tim”fd_ü—‹
(
CLOCK_MONOTONIC
, 0);

289 
šfo
->
wakeupsMis£d
 = 0;

290 
šfo
->
tim”_fd
 = 
fd
;

291 ià(
fd
 == -1)

292  
fd
;

295 
£c
 = 
³riod
 / 1000000;

296 
ns
 = (
³riod
 - (
£c
 * 1000000)) * 1000;

297 
™v®
.
™_š‹rv®
.
tv_£c
 = 
£c
;

298 
™v®
.
™_š‹rv®
.
tv_n£c
 = 
ns
;

299 
™v®
.
™_v®ue
.
tv_£c
 = 
£c
;

300 
™v®
.
™_v®ue
.
tv_n£c
 = 
ns
;

301 
»t
 = 
	`tim”fd_£‰ime
(
fd
, 0, &
™v®
, 
NULL
);

302  
»t
;

303 
	}
}

305 
	$wa™P”iod
(
³riodicInfo
 *
šfo
)

307 
mis£d
;

308 
»t
;

312 
»t
 = 
	`»ad
(
šfo
->
tim”_fd
, &
mis£d
, (missed));

313 ià(
»t
 == -1)

315 
	`³¼Ü
("readimer");

320 ià(
mis£d
 > 0)

321 
šfo
->
wakeupsMis£d
 +ğ(
mis£d
 - 1);

322 
	}
}

324 *
	$ü—‹RTh»ad
(*
¬g
) {

325 
ušt32_t
 
keyF¿meIÁ”v®_Áp
 = (ušt32_t)(
keyF¿meIÁ”v®
 * 65536.0f);

326 
¿‹SÿË
 = 1.0f;

327 ià(
isKeyF¿me
) {

328 
¿‹SÿË
 = 1.0à+ 0.0*
keyF¿meSize
 / (
FPS
*
keyF¿meIÁ”v®
) / 2.0;

329 
¿‹SÿË
 = (1.0f /„ateScale);

331 
ušt32_t
 
dT_us
 = (ušt32_t)(1e6 / 
FPS
);

332 
PT
 = 98;

333 
³riodicInfo
 
šfo
;

335 
	`makeP”iodic
(
dT_us
, &
šfo
);

341 ià(
¡İTh»ad
) {

342  
NULL
;

344 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

346 
ušt32_t
 
ts
 = (ušt32_t)(
time_Áp
 / 65536.0 * 90000);

347 
¿‹Tx
 = 
sü—mTx
->
	`g‘T¬g‘B™¿‹
(
SSRC
)*
¿‹SÿË
;

348 
¿ndV®
 = (
	`¿nd
()è/ 
RAND_MAX
 - 0.5;

349 
by‹s
 = ()(
¿‹Tx
 / 
FPS
 / 8 * (1.0 + 
¿ndV®
 * 
¿ndR©e
));

351 ià(
isKeyF¿me
 && 
time_Áp
 - 
Ï¡KeyF¿meT_Áp
 >ğ
keyF¿meIÁ”v®_Áp
) {

355 
by‹s
 = ()(by‹s*
keyF¿meSize
);

356 
Ï¡KeyF¿meT_Áp
 = 
time_Áp
;

359 ià(!
pushT¿ffic
 && 
bur¡Time
 < 0) {

360 
tmp
 = 
time_Áp
 / 6554;

361 
tmp_mod
 = 
tmp
 % 
³riodicR©eDrİIÁ”v®
;

362 ià(
tmp_mod
 > (
³riodicR©eDrİIÁ”v®
 - 2)) {

369 
by‹s
 = 10;

371 ià(
tmp
 > 2 && (
tmp_mod
 > (
³riodicR©eDrİIÁ”v®
 - 2) ||mp_mod <= 2)) {

377 
sü—mTx
->
	`£tEÇbËR©eUpd©e
(
çl£
);

380 
sü—mTx
->
	`£tEÇbËR©eUpd©e
(
Œue
);

382 
time_s
 = 
time_Áp
 / 65536.0f;

383 ià(
bur¡S¹Time
 < 0) {

384 
bur¡S¹Time
 = 
time_s
;

385 
isBur¡
 = 
Œue
;

387 ià(
time_s
 > 
bur¡S¹Time
 + 
bur¡Time
 && 
isBur¡
) {

388 
isBur¡
 = 
çl£
;

389 
bur¡SË•Time
 = 
time_s
;

391 ià(
time_s
 > 
bur¡SË•Time
 + 
bur¡SË•
 && !
isBur¡
) {

392 
isBur¡
 = 
Œue
;

393 
bur¡S¹Time
 = 
time_s
;

395 ià(!
isBur¡
)

396 
by‹s
 = 0;

399 
by‹s
 > 0) {

400 
¶_size
 = 
	`mš
(
by‹s
, 
mtu
);

401 
»cvËn
 = 
¶_size
 + 12;

403 
by‹s
 = 
¡d
::
	`max
(0, by‹ - 
¶_size
);

404 
±
 = 
PT
;

405 
boŞ
 
isM¬k
;

406 ià(
by‹s
 == 0) {

408 
±
 |= 0x80;

409 
isM¬k
 = 
Œue
;

411 
isM¬k
 = 
çl£
;

413 
ušt8_t
 *
buf_¹p
 = (ušt8_ˆ*)
	`m®loc
(
BUFSIZE
);

414 
	`wr™eR
(
buf_¹p
, 
£qNr
, 
ts
, 
±
);

416 ià(
pushT¿ffic
) {

417 
	`£ndPack‘
(
buf_¹p
, 
»cvËn
);

418 
	`·ck‘_ä“
(
buf_¹p
);

419 
buf_¹p
 = 
NULL
;

422 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

423 
¹pQueue
->
	`push
(
buf_¹p
, 
»cvËn
, 
£qNr
, 
isM¬k
, (
time_Áp
) / 65536.0f);

424 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

426 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

427 
time_Áp
 = 
	`g‘TimeInN
();

428 
sü—mTx
->
	`ÃwMedŸF¿me
(
time_Áp
, 
SSRC
, 
»cvËn
);

429 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

431 
£qNr
++;

433 
	`wa™P”iod
(&
šfo
);

437  
NULL
;

438 
	}
}

440 
ušt32_t
 
	g¹ı_rx_time_Áp
 = 0;

441 
	#KEEP_ALIVE_PKT_SIZE
 1

	)

442 *
	$»adRtıTh»ad
(*
¬g
) {

447 
»cvËn
 = 
	`»cväom
(
fd_outgošg_¹p
, 
buf_¹ı
, 
BUFSIZE
, 0, (
sockaddr
 *)&
šcomšg_¹ı_addr
, &
add¾’_šcomšg_¹ı
);

448 ià(
¡İTh»ad
)

449  
NULL
;

450 ià(
»cvËn
 > 
KEEP_ALIVE_PKT_SIZE
) {

451 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

452 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

453 
s
[100];

454 ià(
Áp
) {

455 
timev®
 

;

456 
	`g‘timeofday
(&

, 
NULL
);

457 
time
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6;

458 
	`¥rštf
(
s
, "%1.6f", 
time
);

461 
	`¥rštf
(
s
, "%1.4f", 
time_Áp
 / 65536.0f);

463 
sü—mTx
->
	`£tTimeSŒšg
(
s
);

465 
sü—mTx
->
	`šcomšgSnd¬dizedF“dback
(
time_Áp
, 
buf_¹ı
, 
»cvËn
);

467 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

468 
¹ı_rx_time_Áp
 = 
time_Áp
;

470 
	`u¦“p
(10);

472  
NULL
;

473 
	}
}

475 *
	$s›¼aPythÚTh»ad
(*
¬g
) {

476 cÚ¡ *
TOK
 = " {}':,";

481 
»cvËn
 = 
	`»cväom
(
fd_s›¼a_pythÚ
, 
buf_s›¼a
, 
BUFSIZE
, 0, (
sockaddr
 *)&
s›¼a_pythÚ_addr
, &
add¾’_s›¼a_pythÚ_addr
);

482 
n
 = 0;‚ < 
	`¡¾’
((*)
buf_s›¼a
);‚++) {

483 ià(
buf_s›¼a
[
n
] == '"')

484 
buf_s›¼a
[
n
] = ' ';

486 
RSSI
 = 0;

487 
RSRP
 = 0;

488 
C–lId
 = 0;

489 
SINR
 = 0;

490 *
s
 = 
	`¡¹ok
((*)
buf_s›¼a
, 
TOK
);

491 
s
 != 0) {

492 ià(
	`¡r¡r
(
s
, "RSSI")) {

493 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

494 
RSSI
 = 
	`©oi
(
s
);

496 ià(
	`¡r¡r
(
s
, "ID")) {

497 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

498 
C–lId
 = 
	`©oi
(
s
);

500 ià(
	`¡r¡r
(
s
, "SINR")) {

501 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

502 
SINR
 = 
	`©oi
(
s
);

504 ià(
	`¡r¡r
(
s
, "RSRP")) {

505 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

506 
RSRP
 = 
	`©oi
(
s
);

508 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

511 
	`¥rštf
(
s›¼aLogSŒšg
, " %9d, %4d, %4d, %4d", 
C–lId
, 
RSRP
, 
RSSI
, 
SINR
);

512 
sü—mTx
->
	`£tD‘aedLogExŒaD©a
(
s›¼aLogSŒšg
);

513 ià(
¡İTh»ad
)

514  
NULL
;

515 
	`u¦“p
(500000);

517  
NULL
;

518 
	}
}

520 
	$£tup
() {

521 
outgošg_¹p_addr
.
sš_çmy
 = 
AF_INET
;

522 
	`š‘_©Ú
(
DECODER_IP
, (
š_addr
*)&
outgošg_¹p_addr
.
sš_addr
.
s_addr
);

523 
outgošg_¹p_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

524 
add¾’_outgošg_¹p
 = (
outgošg_¹p_addr
);

526 
šcomšg_¹ı_addr
.
sš_çmy
 = 
AF_INET
;

527 
šcomšg_¹ı_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

528 
šcomšg_¹ı_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

530 
dummy_¹ı_addr
.
sš_çmy
 = 
AF_INET
;

531 
	`š‘_©Ú
(
DUMMY_IP
, (
š_addr
*)&
dummy_¹ı_addr
.
sš_addr
.
s_addr
);

532 
dummy_¹ı_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

534 ià((
fd_outgošg_¹p
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

535 
	`³¼Ü
("cannot create socket");

539 ià(
iâame
 != 0) {

540 cÚ¡ 
Ën
 = 
	`¡¾’
(
iâame
);

541 ià(
	`£tsockİt
(
fd_outgošg_¹p
, 
SOL_SOCKET
, 
SO_BINDTODEVICE
, 
iâame
, 
Ën
) < 0) {

542 
	`³¼Ü
("setsockopt(SO_BINDTODEVICE) failed");

547 ià(
	`bšd
(
fd_outgošg_¹p
, (
sockaddr
 *)&
šcomšg_¹ı_addr
, (incoming_rtcp_addr)) < 0) {

548 
	`³¼Ü
("bind outgoing_rtp_addr failed");

552 ià(!
pushT¿ffic
)

553 
û¼
 << "Li¡’ oÀpÜˆ" << 
DECODER_PORT
 << "Ø»ûivRTCP from decod” " << 
’dl
;

556 ià(
s›¼aLog
) {

557 
s›¼a_pythÚ_addr
.
sš_çmy
 = 
AF_INET
;

558 
s›¼a_pythÚ_addr
.
sš_pÜt
 = 
	`htÚs
(
SIERRA_PYTHON_PORT
);

559 
s›¼a_pythÚ_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

561 ià((
fd_s›¼a_pythÚ
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

562 
	`³¼Ü
("cannot create socket");

566 ià(
	`bšd
(
fd_s›¼a_pythÚ
, (
sockaddr
 *)&
s›¼a_pythÚ_addr
, (sierra_python_addr)) < 0) {

567 
	`³¼Ü
("bind incoming_sierra_addr failed");

571 
û¼
 << "Li¡’ oÀpÜˆ" << 
SIERRA_PYTHON_PORT
 << "Ø»ûivd©¨äom s›¼¨pythÚ†og süˆ " << 
’dl
;

577 #ifdeà
ECN_CAPABLE


578 
tos
 = 0;

579 ià(
eù
 == 0 ||ƒct == 1)

580 
tos
 = 2 - 
eù
;

581 ià(
eù
 == 3)

582 
tos
 = 3;

583 
»s
 = 
	`£tsockİt
(
fd_outgošg_¹p
, 
IPPROTO_IP
, 
IP_TOS
, &
tos
, (iptos));

584 ià(
»s
 < 0) {

585 
û¼
 << "NÙ…ossibËØ£ˆECN b™s" << 
’dl
;

587 
tmp
 = 0;

589 
buf
[10];

590 ià(
fixedR©e
 > 0)

591 
sü—mTx
 = 
Ãw
 
	`Sü—mTx
(1.0f, 1.0f,

592 
d–ayT¬g‘
,

593 
çl£
,

595 (
fixedR©e
 * 100) / 8,

598 
eù
 == 1,

599 
Œue
,

600 
’abËClockDriáCom³n§tiÚ
);

602 
sü—mTx
 = 
Ãw
 
	`Sü—mTx
(
sÿËFaùÜ
, scaleFactor,

603 
d–ayT¬g‘
,

604 
çl£
,

605 1.0f, 
dsÿË
,

606 (
š™R©e
 * 100) / 8,

607 
·ck‘PacšgH—droom
,

609 
eù
 == 1,

610 
çl£
,

611 
’abËClockDriáCom³n§tiÚ
);

612 
¹pQueue
 = 
Ãw
 
	`RQueue
();

613 
sü—mTx
->
	`£tCwndMšLow
(5000);

615 ià(
fixedR©e
 > 0) {

616 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
,

617 
SSRC
,

619 
fixedR©e
*1000.0f,

620 
fixedR©e
*1000.0f,

621 
fixedR©e
*1000.0f,

627 
sÿËFaùÜ
,

628 
sÿËFaùÜ
,

629 
çl£
,

630 
hy¡”esis
);

633 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
,

634 
SSRC
,

636 
mšR©e
 * 1000,

637 
š™R©e
 * 1000,

638 
maxR©e
 * 1000,

639 
¿‹Inü—£
 * 1000,

640 
¿‹SÿË
,

642 
txQueueSizeFaùÜ
,

643 
queueD–ayGu¬d
,

644 
sÿËFaùÜ
,

645 
sÿËFaùÜ
,

646 
çl£
,

647 
hy¡”esis
);

650 
	}
}

652 
ušt32_t
 
	gÏ¡T_Áp
;

654 vŞ©
sig_©omic_t
 
	gdÚe
 = 0;

656 
	$¡İAÎ
(
signum
)

658 
¡İTh»ad
 = 
Œue
;

659 
	}
}

661 
	$maš
(
¬gc
, * 
¬gv
[]) {

663 
timev®
 

;

664 
	`g‘timeofday
(&

, 
NULL
);

665 
t0
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6 - 1e-3;

666 
Ï¡T_Áp
 = 
	`g‘TimeInN
();

671 ià(
¬gc
 <= 1) {

672 
û¼
 << "SCReAM BWe¡oŞ, s’d”. EricssÚ AB. V”siÚ 2022-06-10" << 
’dl
;

673 
û¼
 << "U§g: " << 
’dl
 << " > scream_bw_test_tx <options> decoder_ip decoder_port " <<ƒndl;

674 
û¼
 << " -iàÇm bšdØ¥ecifiøš‹rçû" << 
’dl
;

675 
û¼
 << " -timv®u„uÀfÜim£cÚd (deçuÉ infš™e)" << 
’dl
;

676 
û¼
 << " -bur¡ v®1 v®2 bur¡ medŸ fÜ‡ giv’imªdh’ sË• ¨giv’ime" << 
’dl
;

677 
û¼
 << "ƒxam¶-bur¡ 1.0 0.2 bur¡ medŸ fÜ 1 th’ sË• fÜ 0.2 " << 
’dl
;

678 
û¼
 << " -nİaû di§bË…ack‘…acšg" << 
’dl
;

679 
û¼
 << " -fixed¿‹ v®u s‘‡ fixed 'cod”' b™¿‹ " << 
’dl
;

680 
û¼
 << " -pushŒaffiø ju¡…ushŒaffiø©‡ fixed b™¿‹,‚Øãedback‚“ded" << 
’dl
;

681 
û¼
 << " mu¡ bu£d w™h -fixed¿‹ o±iÚ" << 
’dl
;

682 
û¼
 << " -key v®1 v®2 s‘‡ giv’ key f¿mš‹rv® [s]‡nd sizmuÉl›¸" << 
’dl
;

683 
û¼
 << "ƒxam¶-key 2.0 5.0 " << 
’dl
;

684 
û¼
 << " -¿nd v®u f¿mesize v¬y„ªdomly‡roundhnomš® " << 
’dl
;

685 
û¼
 << "ƒxam¶-¿nd 10 f¿mesizv¬y +/- 10% " << 
’dl
;

686 
û¼
 << " -š™¿‹ v®u s‘‡ s¹ b™¿‹ [kbps]" << 
’dl
;

687 
û¼
 << "ƒxam¶-š™¿‹ 2000 " << 
’dl
;

688 
û¼
 << " -mš¿‹ v®u s‘‡ mš b™¿‹ [kbps], deçuÉ 1000kbps" << 
’dl
;

689 
û¼
 << "ƒxam¶-mš¿‹ 1000 " << 
’dl
;

690 
û¼
 << " -max¿‹ v®u s‘‡ max b™¿‹ [kbps], deçuÉ 200000kbps" << 
’dl
;

691 
û¼
 << "ƒxam¶-max¿‹ 10000 " << 
’dl
;

692 
û¼
 << " -¿‹šü—£ v®u s‘‡ max‡Îowed„©šü—£ s³ed [kbps/s]," << 
’dl
;

693 
û¼
 << " deçuÉ 10000kbps/s" << 
’dl
;

694 
û¼
 << "ƒxam¶-¿‹šü—£ 1000 " << 
’dl
;

695 
û¼
 << " -¿‹sÿË v®u s‘‡ max‡Îowed„©šü—£ s³ed‡ ¨äaùiÚ oàth" << 
’dl
;

696 
û¼
 << " cu¼’ˆ¿‹, deçuÉ 0.5" << 
’dl
;

697 
û¼
 << "ƒxam¶-¿‹sÿË 1.0 " << 
’dl
;

698 
û¼
 << " -eù‚ ECN c­abË¿n¥Üt,‚ = 0 o¸1 fÜ ECT(0èÜ ECT(1)," << 
’dl
;

699 
û¼
 << " -1 fÜ‚Ù-ECT (deçuÉ)" << 
’dl
;

700 
û¼
 << " -sÿË v®u sÿË faùÜ iÀÿ£ oàlos Ü ECNƒv’ˆ(deçuÉ 0.9è" << 
’dl
;

701 
û¼
 << " -dsÿË v®u sÿË faùÜ iÀÿ£ oàšü—£d d–ay (deçuÉ 10.0è" << 
’dl
;

702 
û¼
 << " -d–ayrg‘ v®u s‘‡ queud–ay¬g‘ (deçuÉ = 0.06sè" << 
’dl
;

703 
û¼
 << " -·ûh—droom v®u s‘‡…ack‘…acšg h—droom (deçuÉ = 1.25sè" << 
’dl
;

704 
û¼
 << " -txqueuesizeçùÜ v®u»aùiÚØšü—£d RTP queud–ay (deçuÉ 0.1è" << 
’dl
;

705 
û¼
 << " -queued–aygu¬d v®u„—ùiÚØšü—£d‚‘wÜk queud–ay (deçuÉ 0.05)" << 
’dl
;

706 
û¼
 << " -mtu v®u s‘hmax RTP…aylßd siz(deçuÉ 1200 by‹)" << 
’dl
;

707 
û¼
 << " -å v®u s‘häam¿‹ (deçuÉ 50)" << 
’dl
;

708 
û¼
 << " -şockdriáƒÇbË clock driá com³n§tiÚ fÜhÿ£h©he" << 
’dl
;

709 
û¼
 << "„eûiv”ƒnd clock i ç¡”" << 
’dl
;

710 
û¼
 << " -v”bo£…ršˆ¨mÜex‹nsivlog" << 
’dl
;

711 
û¼
 << " -nosumm¬y dÚ'ˆ´šˆsumm¬y" << 
’dl
;

712 
û¼
 << " -log†ogf savd‘aed…”-ACK†ogØfe" << 
’dl
;

713 
û¼
 << " -Á° u£ NTPime¡am°š†ogfe" << 
’dl
;

714 
û¼
 << " -­³nd‡µ’d†ogfe" << 
’dl
;

715 
û¼
 << " -™emli¡‡dd i‹m†i¡ iÀbegšnšg oàlog fe" << 
’dl
;

716 
û¼
 << " -d‘aed d‘aed†og,…” ACKed RTP" << 
’dl
;

717 
û¼
 << " -³riodicdrİš‹rv® iÁ”v® [s] b‘w“À³riodiødrİ š„©(deçuÉ 60s)" << 
’dl
;

718 
û¼
 << " -miüobur¡š‹rv® miüobur¡ iÁ”v® [ms] fÜ…ack‘…acšg (deçuÉ 2ms)" << 
’dl
;

719 
û¼
 << " -hy¡”esi  inhib™ upd©ed¬g‘„©tØ’cod” iàth¿‹ chªgi sm®l" << 
’dl
;

720 
û¼
 << "‡ v®uoà0.1 m—n ¨hy¡”esi oà+10%/-2.5%" << 
’dl
;

721 
	`ex™
(-1);

723 
ix
 = 1;

724 
boŞ
 
v”bo£
 = 
çl£
;

725 *
logFe
 = 0;

727 
	`¡r¡r
(
¬gv
[
ix
], "-")) {

728 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ect")) {

729 
eù
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

730 
ix
 += 2;

731 ià(!(
eù
 == 1 ||ƒct == 0 ||ƒct == 1 ||ƒct == 3)) {

732 
û¼
 << "eù mu¡ b-1, 0, 1 o¸3 " << 
’dl
;

733 
	`ex™
(0);

738 ià(
	`¡r¡r
(
¬gv
[
ix
], "-time")) {

739 
runTime
 = 
	`©of
(
¬gv
[
ix
 + 1]);

740 
ix
 += 2;

743 ià(
	`¡r¡r
(
¬gv
[
ix
], "-scale")) {

744 
sÿËFaùÜ
 = 
	`©of
(
¬gv
[
ix
 + 1]);

745 
ix
 += 2;

748 ià(
	`¡r¡r
(
¬gv
[
ix
], "-dscale")) {

749 
dsÿË
 = 
	`©of
(
¬gv
[
ix
 + 1]);

750 
ix
 += 2;

753 ià(
	`¡r¡r
(
¬gv
[
ix
], "-delaytarget")) {

754 
d–ayT¬g‘
 = 
	`©of
(
¬gv
[
ix
 + 1]);

755 
ix
 += 2;

759 ià(
	`¡r¡r
(
¬gv
[
ix
], "-paceheadroom")) {

760 
·ck‘PacšgH—droom
 = 
	`©of
(
¬gv
[
ix
 + 1]);

761 
ix
 += 2;

765 ià(
	`¡r¡r
(
¬gv
[
ix
], "-txqueuesizefactor")) {

766 
txQueueSizeFaùÜ
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

767 
ix
 += 2;

770 ià(
	`¡r¡r
(
¬gv
[
ix
], "-queuedelayguard")) {

771 
queueD–ayGu¬d
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

772 
ix
 += 2;

775 ià(
	`¡r¡r
(
¬gv
[
ix
], "-mtu")) {

776 
mtu
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

777 
ix
 += 2;

780 ià(
	`¡r¡r
(
¬gv
[
ix
], "-fixedrate")) {

781 
fixedR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

782 
ix
 += 2;

785 ià(
	`¡r¡r
(
¬gv
[
ix
], "-burst")) {

786 
bur¡Time
 = 
	`©of
(
¬gv
[
ix
 + 1]);

787 
bur¡SË•
 = 
	`©of
(
¬gv
[
ix
 + 2]);

788 
ix
 += 3;

791 ià(
	`¡r¡r
(
¬gv
[
ix
], "-key")) {

792 
isKeyF¿me
 = 
Œue
;

793 
keyF¿meIÁ”v®
 = 
	`©of
(
¬gv
[
ix
 + 1]);

794 
keyF¿meSize
 = 
	`©of
(
¬gv
[
ix
 + 2]);

795 
ix
 += 3;

798 ià(
	`¡r¡r
(
¬gv
[
ix
], "-nopace")) {

799 
di§bËPacšg
 = 
Œue
;

800 
ix
++;

803 ià(
	`¡r¡r
(
¬gv
[
ix
], "-fps")) {

804 
FPS
 = 
	`©of
(
¬gv
[
ix
 + 1]);

805 
ix
 += 2;

808 ià(
	`¡r¡r
(
¬gv
[
ix
], "-rand")) {

809 
¿ndR©e
 = 
	`©of
(
¬gv
[
ix
 + 1]) / 100.0;

810 
ix
 += 2;

813 ià(
	`¡r¡r
(
¬gv
[
ix
], "-initrate")) {

814 
š™R©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

815 
ix
 += 2;

818 ià(
	`¡r¡r
(
¬gv
[
ix
], "-minrate")) {

819 
mšR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

820 
ix
 += 2;

823 ià(
	`¡r¡r
(
¬gv
[
ix
], "-maxrate")) {

824 
maxR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

825 
ix
 += 2;

828 ià(
	`¡r¡r
(
¬gv
[
ix
], "-rateincrease")) {

829 
¿‹Inü—£
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

830 
ix
 += 2;

833 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ratescale")) {

834 
¿‹SÿË
 = 
	`©of
(
¬gv
[
ix
 + 1]);

835 
ix
 += 2;

838 ià(
	`¡r¡r
(
¬gv
[
ix
], "-verbose")) {

839 
v”bo£
 = 
Œue
;

840 
ix
++;

843 ià(
	`¡r¡r
(
¬gv
[
ix
], "-nosummary")) {

844 
´štSumm¬y
 = 
çl£
;

845 
ix
++;

848 ià(
	`¡r¡r
(
¬gv
[
ix
], "-log")) {

849 
logFe
 = 
¬gv
[
ix
 + 1];

850 
ix
 += 2;

853 ià(
	`¡r¡r
(
¬gv
[
ix
], "-sierralog")) {

854 
s›¼aLog
 = 
Œue
;

855 
ix
++;

858 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ntp")) {

859 
Áp
 = 
Œue
;

860 
ix
++;

863 ià(
	`¡r¡r
(
¬gv
[
ix
], "-append")) {

864 
­³nd
 = 
Œue
;

865 
ix
++;

868 ià(
	`¡r¡r
(
¬gv
[
ix
], "-itemlist")) {

869 
™emli¡
 = 
Œue
;

870 
ix
++;

873 ià(
	`¡r¡r
(
¬gv
[
ix
], "-detailed")) {

874 
d‘aed
 = 
Œue
;

875 
ix
++;

878 ià(
	`¡r¡r
(
¬gv
[
ix
], "-pushtraffic")) {

879 
pushT¿ffic
 = 
Œue
;

880 
ix
++;

883 ià(
	`¡r¡r
(
¬gv
[
ix
], "-clockdrift")) {

884 
’abËClockDriáCom³n§tiÚ
 = 
Œue
;

885 
ix
++;

888 ià(
	`¡r¡r
(
¬gv
[
ix
], "-if")) {

889 
iâame
 = 
¬gv
[
ix
 + 1];

890 
ix
 += 2;

893 ià(
	`¡r¡r
(
¬gv
[
ix
], "-periodicdropinterval")) {

894 
³riodicR©eDrİIÁ”v®
 = ()(
	`©of
(
¬gv
[
ix
 + 1])*10.0f);

895 
ix
 += 2;

898 ià(
	`¡r¡r
(
¬gv
[
ix
], "-microburstinterval")) {

899 
mšPaûIÁ”v®
 = 0.001*(
	`©of
(
¬gv
[
ix
 + 1]));

900 
mšPaûIÁ”v®Us
 = ()(
mšPaûIÁ”v®
*1e6f);

901 
ix
 += 2;

902 ià(
mšPaûIÁ”v®
 < 0.002f || minPaceInterval > 0.020f) {

903 
û¼
 << "miüobur¡š‹rv® mu¡ bš„ªg2..20ms" << 
’dl
;

904 
	`ex™
(0);

908 ià(
	`¡r¡r
(
¬gv
[
ix
], "-hysteresis")) {

909 
hy¡”esis
 = 
	`©of
(
¬gv
[
ix
 + 1]);

910 
ix
 += 2;

911 ià(
hy¡”esis
 < 0.0f || hysteresis > 0.2f) {

912 
û¼
 << "hy¡”esi mu¡ bš„ªg0.0...0.2" << 
’dl
;

913 
	`ex™
(0);

917 
û¼
 << "uÃx³ùed‡rg " << 
¬gv
[
ix
] << 
’dl
;

918 
	`ex™
(0);

922 ià(
pushT¿ffic
 && 
fixedR©e
 == 0) {

923 
û¼
 << "E¼Ü :…ushŒaffiøÿÀÚly bu£d w™h fixed¿‹" << 
’dl
;

924 
	`ex™
(-1);

926 ià(
logFe
) {

927 ià(
­³nd
)

928 
å_log
 = 
	`fİ’
(
logFe
, "a");

930 
å_log
 = 
	`fİ’
(
logFe
, "w");

932 ià(
mšR©e
 > 
š™R©e
)

933 
š™R©e
 = 
mšR©e
;

934 
DECODER_IP
 = 
¬gv
[
ix
];ix++;

935 
DECODER_PORT
 = 
	`©oi
(
¬gv
[
ix
]);ix++;

937 ià(
	`£tup
() == 0)

940 ià(
logFe
 && !
­³nd
 && 
™emli¡
) {

941 
	`årštf
(
å_log
, "%s\n", 
sü—mTx
->
	`g‘D‘aedLogI‹mLi¡
());

944 
sigaùiÚ
 
aùiÚ
;

945 
	`mem£t
(&
aùiÚ
, 0, (
sigaùiÚ
));

946 
aùiÚ
.
§_hªdËr
 = 
¡İAÎ
;

947 
	`sigaùiÚ
(
SIGTERM
, &
aùiÚ
, 
NULL
);

948 
	`sigaùiÚ
(
SIGINT
, &
aùiÚ
, 
NULL
);

950 
sü—mTx
->
	`£tD‘aedLogFp
(
å_log
);

951 
sü—mTx
->
	`u£ExŒaD‘aedLog
(
d‘aed
);

953 
	`±h»ad_mu‹x_š™
(&
lock_sü—m
, 
NULL
);

954 
	`±h»ad_mu‹x_š™
(&
lock_¹p_queue
, 
NULL
);

955 
	`±h»ad_mu‹x_š™
(&
lock_·û
, 
NULL
);

958 
	`±h»ad_ü—‹
(&
ü—‹_¹p_th»ad
, 
NULL
, 
ü—‹RTh»ad
, (*)"Create RTPhread...");

959 ià(
pushT¿ffic
) {

960 
û¼
 << "Sü—m s’d” s¹ed iÀpush¿ffiømod" << 
fixedR©e
 << "kbps" << 
’dl
;

962 !
¡İTh»ad
 && (
runTime
 < 0 || 
	`g‘TimeInN
() <„unTime*65536.0f)) {

963 
	`u¦“p
(50000);

965 
¡İTh»ad
 = 
Œue
;

969 
û¼
 << "Sü—m s’d” s¹ed! " << 
’dl
;

972 
	`±h»ad_ü—‹
(&
¹ı_th»ad
, 
NULL
, 
»adRtıTh»ad
, (*)"RTCPhread...");

974 
	`±h»ad_ü—‹
(&
Œªsm™_¹p_th»ad
, 
NULL
, 
Œªsm™RTh»ad
, (*)"Transmit RTPhread...");

975 ià(
s›¼aLog
) {

977 
	`±h»ad_ü—‹
(&
s›¼a_pythÚ_th»ad
, 
NULL
, 
s›¼aPythÚTh»ad
, (*)"Sierra Python†oghread...");

980 !
¡İTh»ad
 && (
runTime
 < 0 || 
	`g‘TimeInN
() <„unTime*65536.0f)) {

981 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

982 
boŞ
 
isF“dback
 = 
time_Áp
 - 
¹ı_rx_time_Áp
 < 65536;

983 ià((
´štSumm¬y
 || !
isF“dback
è&& 
time_Áp
 - 
Ï¡LogT_Áp
 > 2 * 65536) {

984 ià(!
isF“dback
) {

985 
û¼
 << "NØRTCP f“dback„eûived" << 
’dl
;

988 
time_s
 = 
time_Áp
 / 65536.0f;

989 
s
[500];

990 
sü—mTx
->
	`g‘Sti¡ics
(
time_s
, 
s
);

991 ià(
s›¼aLog
)

992 
cout
 << 
s
 << 
’dl
 << " C–lId, RSRP, RSSI, SINR: {" << 
s›¼aLogSŒšg
 << "}" <<ƒndl <<ƒndl;

994 
cout
 << 
s
 << 
’dl
;

996 
Ï¡LogT_Áp
 = 
time_Áp
;

998 ià(
v”bo£
 && 
time_Áp
 - 
Ï¡LogTv_Áp
 > 13107) {

999 ià(
isF“dback
) {

1000 
time_s
 = 
time_Áp
 / 65536.0f;

1001 
s
[3000];

1002 
s1
[500];

1003 
sü—mTx
->
	`g‘V”yShÜtLog
(
time_s
, 
s1
);

1004 ià(
s›¼aLog
)

1005 
	`¥rštf
(
s
, "%8.3f, % % ", 
time_s
, 
s1
, 
s›¼aLogSŒšg
);

1007 
	`¥rštf
(
s
, "%8.3f, % ", 
time_s
, 
s1
);

1009 
cout
 << 
s
 << 
’dl
;

1014 
s1
[0] = 0x80;

1015 
s1
[1] = 0x7F;

1016 
	`memıy
(&
s1
[2], 
s
, 
	`¡¾’
(s));

1017 
	`£ndPack‘
(
s1
, 
	`¡¾’
(
s
) + 2);

1019 
Ï¡LogTv_Áp
 = 
time_Áp
;

1021 
	`u¦“p
(50000);

1023 
¡İTh»ad
 = 
Œue
;

1025 
	`u¦“p
(500000);

1026 
	`şo£
(
fd_outgošg_¹p
);

1027 ià(
å_log
)

1028 
	`fşo£
(
å_log
);

1029 
	}
}

	@scream/code/scream_sender_copy.cpp

2 
	~"Sü—mTx.h
"

3 
	~"RQueue.h
"

4 
	~"sys/sock‘.h
"

5 
	~"sys/ty³s.h
"

6 
	~"Ãtš‘/š.h
"

7 
	~<¡ršg.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<sys/time.h
>

12 
	~<io¡»am
>

13 
	~<±h»ad.h
>

14 
	~<fú.h
>

15 
	~<uni¡d.h
>

16 
	~<sys/time.h
>

17 
	~<sigÇl.h
>

18 
	~<sys/tim”fd.h
>

19 
™im”v®
 
	gtim”
;

20 
sigaùiÚ
 
	g§
;

22 
	s³riodicInfo


24 
	mtim”_fd
;

25 
	mwakeupsMis£d
;

28 
usšg
 
Çme¥aû
 
	g¡d
;

30 
	#BUFSIZE
 2048

	)

32 
	gmšPaûIÁ”v®
 = 0.002f;

33 
	gmšPaûIÁ”v®Us
 = 1900;

35 
	#ECN_CAPABLE


	)

43 
	geù
 = -1;

45 
	gs›¼aLogSŒšg
[
BUFSIZE
] = " 0, 0, 0, 0";

46 
	gFPS
 = 50.0f;

47 
ušt32_t
 
	gSSRC
 = 100;

48 
	gfixedR©e
 = 0;

49 
boŞ
 
	gisKeyF¿me
 = 
çl£
;

50 
boŞ
 
	gdi§bËPacšg
 = 
çl£
;

51 
	gkeyF¿meIÁ”v®
 = 0.0;

52 
	gkeyF¿meSize
 = 1.0;

53 
	gš™R©e
 = 1000;

54 
	gmšR©e
 = 1000;

55 
	gmaxR©e
 = 200000;

56 
	g¿‹Inü—£
 = 10000;

57 
	g¿‹SÿË
 = 0.5f;

58 
	gdsÿË
 = 10.0f;

59 
boŞ
 
	g’abËClockDriáCom³n§tiÚ
 = 
çl£
;

60 
	gbur¡Time
 = -1.0;

61 
	gbur¡SË•
 = -1.0;

62 
boŞ
 
	gisBur¡
 = 
çl£
;

63 
	gbur¡S¹Time
 = -1.0;

64 
	gbur¡SË•Time
 = -1.0;

65 
boŞ
 
	gpushT¿ffic
 = 
çl£
;

66 
	g·ck‘PacšgH—droom
 = 1.25f;

67 
	gtxQueueSizeFaùÜ
 = 0.1f;

68 
	gqueueD–ayGu¬d
 = 0.05f;

69 
	ghy¡”esis
 = 0.0;

71 
	g³riodicR©eDrİIÁ”v®
 = 600;

74 
ušt16_t
 
	g£qNr
 = 0;

75 
ušt32_t
 
	gÏ¡KeyF¿meT_Áp
 = 0;

76 
	gmtu
 = 1200;

77 
	grunTime
 = -1.0;

78 
boŞ
 
	g¡İTh»ad
 = 
çl£
;

79 
±h»ad_t
 
	gü—‹_¹p_th»ad
 = 0;

80 
±h»ad_t
 
	gŒªsm™_¹p_th»ad
 = 0;

81 
±h»ad_t
 
	g¹ı_th»ad
 = 0;

82 
±h»ad_t
 
	gs›¼a_pythÚ_th»ad
 = 0;

83 
boŞ
 
	gs›¼aLog
;

85 
	gsÿËFaùÜ
 = 0.9f;

86 
	gd–ayT¬g‘
 = 0.06f;

87 
boŞ
 
	g´štSumm¬y
 = 
Œue
;

89 
	gfd_outgošg_¹p
;

90 
	gfd_s›¼a_pythÚ
;

91 
Sü—mTx
 *
	gsü—mTx
 = 0;

92 
RQueue
 *
	g¹pQueue
 = 0;

96 cÚ¡ *
	gDECODER_IP
 = "192.168.0.21";

97 
	gDECODER_PORT
 = 30110;

98 cÚ¡ *
	gDUMMY_IP
 = "217.10.68.152";

100 
	gSIERRA_PYTHON_PORT
 = 35000;

102 
sockaddr_š
 
	goutgošg_¹p_addr
;

103 
sockaddr_š
 
	gšcomšg_¹ı_addr
;

104 
sockaddr_š
 
	gdummy_¹ı_addr
;

105 
sockaddr_š
 
	gs›¼a_pythÚ_addr
;

107 
	gbuf_¹ı
[
BUFSIZE
];

109 
	gbuf_s›¼a
[
BUFSIZE
];

111 
sockËn_t
 
	gadd¾’_outgošg_¹p
;

112 
sockËn_t
 
	gadd¾’_dummy_¹ı
;

113 
ušt32_t
 
	gÏ¡LogT_Áp
 = 0;

114 
ušt32_t
 
	gÏ¡LogTv_Áp
 = 0;

115 
ušt32_t
 
	gtD_Áp
 = 0;

116 
sockËn_t
 
	gadd¾’_šcomšg_¹ı
 = (
šcomšg_¹ı_addr
);

117 
sockËn_t
 
	gadd¾’_s›¼a_pythÚ_addr
 = (
s›¼a_pythÚ_addr
);

118 
±h»ad_mu‹x_t
 
	glock_sü—m
;

119 
±h»ad_mu‹x_t
 
	glock_¹p_queue
;

120 
±h»ad_mu‹x_t
 
	glock_·û
;

122 
FILE
 *
	gå_log
 = 0;

124 *
	giâame
 = 0;

127 
boŞ
 
	gÁp
 = 
çl£
;

128 
boŞ
 
	g­³nd
 = 
çl£
;

129 
boŞ
 
	g™emli¡
 = 
çl£
;

130 
boŞ
 
	gd‘aed
 = 
çl£
;

131 
	g¿ndR©e
 = 0.0f;

133 
	gt0
 = 0;

143 
	$·ck‘_ä“
(*
buf
) {

144 
	`ä“
(
buf
);

145 
	}
}

147 
ušt32_t
 
	$g‘TimeInN
() {

148 
timev®
 

;

149 
	`g‘timeofday
(&

, 
NULL
);

150 
time
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6 - 
t0
;

151 
ušt64_t
 
Áp64
 = 
	`ušt64_t
(
time
*65536.0);

152 
ušt32_t
 
Áp
 = 0xFFFFFFFF & 
Áp64
;

153  
Áp
;

154 
	}
}

158 
	gaccumuÏ‹dPaûTime
 = 0.0f;

172 
	$·r£R
(*
buf
, 
ušt16_t
* 
£qNr
, 
ušt32_t
* 
timeSmp
, *
±
) {

173 
ušt16_t
 
¿wSeq
;

174 
ušt32_t
 
¿wTs
;

175 
	`memıy
(&
¿wSeq
, 
buf
 + 2, 2);

176 
	`memıy
(&
¿wTs
, 
buf
 + 4, 4);

177 
	`memıy
(
±
, 
buf
 + 1, 1);

178 *
£qNr
 = 
	`Áohs
(
¿wSeq
);

179 *
timeSmp
 = 
	`Áohl
(
¿wTs
);

180 
	}
}

182 
	$wr™eR
(*
buf
, 
ušt16_t
 
£qNr
, 
ušt32_t
 
timeSmp
, 
±
) {

183 
£qNr
 = 
	`htÚs
(seqNr);

184 
timeSmp
 = 
	`htÚl
(timeStamp);

185 
ušt32_t
 
tmp
 = 
	`htÚl
(
SSRC
);

186 
	`memıy
(
buf
 + 2, &
£qNr
, 2);

187 
	`memıy
(
buf
 + 4, &
timeSmp
, 4);

188 
	`memıy
(
buf
 + 8, &
tmp
, 4);

189 
	`memıy
(
buf
 + 1, &
±
, 1);

190 
buf
[0] = 0x80;

191 
	}
}

193 
	$wr™eEncodedVideoR
(*
buf
, 
ušt16_t
 
£qNr
, 
ušt32_t
 
timeSmp
, 
±
) {

194 
£qNr
 = 
	`htÚs
(seqNr);

195 
timeSmp
 = 
	`htÚl
(timeStamp);

196 
ušt32_t
 
tmp
 = 
	`htÚl
(
SSRC
);

197 
	`memıy
(
buf
 + 2, &
£qNr
, 2);

198 
	`memıy
(
buf
 + 4, &
timeSmp
, 4);

199 
	`memıy
(
buf
 + 8, &
tmp
, 4);

200 
	`memıy
(
buf
 + 1, &
±
, 1);

201 
buf
[0] = 0x80;

202 
	}
}

207 
	$£ndPack‘
(* 
buf
, 
size
) {

208 
	`£ndto
(
fd_outgošg_¹p
, 
buf
, 
size
, 0, (
sockaddr
 *)&
outgošg_¹p_addr
, (outgoing_rtp_addr));

209 
	}
}

216 *
	$Œªsm™RTh»ad
(*
¬g
) {

217 
size
;

218 
ušt16_t
 
£qNr
;

219 
boŞ
 
isM¬k
;

220 
buf
[2000];

221 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

222 
¦“pTime_us
 = 10;

223 
»tV®
 = 0.0f;

224 
sizeOfQueue
;

225 
timev®
 
¡¬t
, 
’d
;

226 
u£cÚds_t
 
diff
 = 0;

227 
·ûIÁ”v®FixedR©e
 = 0.0f;

228 ià(
fixedR©e
 > 0 && !
di§bËPacšg
) {

229 
·ûIÁ”v®FixedR©e
 = (
mtu
 + 40)*8.0à/ (
fixedR©e
 * 1000)*0.9;

232 ià(
¡İTh»ad
) {

233  
NULL
;

236 
¦“pTime_us
 = 1;

237 
»tV®
 = 0.0f;

238 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

239 
time_Áp
 = 
	`g‘TimeInN
();

240 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
SSRC
);

241 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

243 ià(
»tV®
 != -1.0f) {

244 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

245 
sizeOfQueue
 = 
¹pQueue
->
	`sizeOfQueue
();

246 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

248 
	`g‘timeofday
(&
¡¬t
, 0);

249 
time_Áp
 = 
	`g‘TimeInN
();

251 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
SSRC
);

252 ià(
fixedR©e
 > 0 && 
»tV®
 >ğ0.0à&& 
sizeOfQueue
 > 0)

253 
»tV®
 = 
·ûIÁ”v®FixedR©e
;

254 ià(
di§bËPacšg
 && 
sizeOfQueue
 > 0 && 
»tV®
 > 0.0f)

255 
»tV®
 = 0.0f;

256 ià(
»tV®
 > 0.0f)

257 
accumuÏ‹dPaûTime
 +ğ
»tV®
;

258 ià(
»tV®
 != -1.0) {

259 *
buf
;

260 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

261 
¹pQueue
->
	`pİ
(&
buf
, 
size
, 
£qNr
, 
isM¬k
);

262 
	`£ndPack‘
(
buf
, 
size
);

263 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

264 
	`·ck‘_ä“
(
buf
);

265 
buf
 = 
NULL
;

266 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

267 
time_Áp
 = 
	`g‘TimeInN
();

268 
»tV®
 = 
sü—mTx
->
	`addT¿nsm™‹d
(
time_Áp
, 
SSRC
, 
size
, 
£qNr
, 
isM¬k
);

269 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

272 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

273 
sizeOfQueue
 = 
¹pQueue
->
	`sizeOfQueue
();

274 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

275 
	`g‘timeofday
(&
’d
, 0);

276 
diff
 = 
’d
.
tv_u£c
 - 
¡¬t
.tv_usec;

277 
accumuÏ‹dPaûTime
 = 
¡d
::
	`max
(0.0f,‡ccumuÏ‹dPaûTim- 
diff
 * 1e-6f);

278 } 
accumuÏ‹dPaûTime
 <ğ
mšPaûIÁ”v®
 &&

279 
»tV®
 != -1.0f &&

280 
sizeOfQueue
 > 0);

281 ià(
accumuÏ‹dPaûTime
 > 0) {

282 
¦“pTime_us
 = 
¡d
::
	`mš
(()(
accumuÏ‹dPaûTime
*1e6f), 
mšPaûIÁ”v®Us
);

283 
accumuÏ‹dPaûTime
 = 0.0f;

286 
	`u¦“p
(
¦“pTime_us
);

287 
¦“pTime_us
 = 0;

289  
NULL
;

290 
	}
}

292 
	$makeP”iodic
(
³riod
, 
³riodicInfo
 *
šfo
)

294 
»t
;

295 
ns
;

296 
£c
;

297 
fd
;

298 
™im”¥ec
 
™v®
;

301 
fd
 = 
	`tim”fd_ü—‹
(
CLOCK_MONOTONIC
, 0);

302 
šfo
->
wakeupsMis£d
 = 0;

303 
šfo
->
tim”_fd
 = 
fd
;

304 ià(
fd
 == -1)

305  
fd
;

308 
£c
 = 
³riod
 / 1000000;

309 
ns
 = (
³riod
 - (
£c
 * 1000000)) * 1000;

310 
™v®
.
™_š‹rv®
.
tv_£c
 = 
£c
;

311 
™v®
.
™_š‹rv®
.
tv_n£c
 = 
ns
;

312 
™v®
.
™_v®ue
.
tv_£c
 = 
£c
;

313 
™v®
.
™_v®ue
.
tv_n£c
 = 
ns
;

314 
»t
 = 
	`tim”fd_£‰ime
(
fd
, 0, &
™v®
, 
NULL
);

315  
»t
;

316 
	}
}

318 
	$wa™P”iod
(
³riodicInfo
 *
šfo
)

320 
mis£d
;

321 
»t
;

325 
»t
 = 
	`»ad
(
šfo
->
tim”_fd
, &
mis£d
, (missed));

326 ià(
»t
 == -1)

328 
	`³¼Ü
("readimer");

333 ià(
mis£d
 > 0)

334 
šfo
->
wakeupsMis£d
 +ğ(
mis£d
 - 1);

335 
	}
}

337 *
	$ü—‹RTh»ad
(*
¬g
) {

338 
ušt32_t
 
keyF¿meIÁ”v®_Áp
 = (ušt32_t)(
keyF¿meIÁ”v®
 * 65536.0f);

339 
¿‹SÿË
 = 1.0f;

340 ià(
isKeyF¿me
) {

341 
¿‹SÿË
 = 1.0à+ 0.0*
keyF¿meSize
 / (
FPS
*
keyF¿meIÁ”v®
) / 2.0;

342 
¿‹SÿË
 = (1.0f /„ateScale);

344 
ušt32_t
 
dT_us
 = (ušt32_t)(1e6 / 
FPS
);

345 
PT
 = 98;

346 
³riodicInfo
 
šfo
;

348 
	`makeP”iodic
(
dT_us
, &
šfo
);

354 ià(
¡İTh»ad
) {

355  
NULL
;

357 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

359 
ušt32_t
 
ts
 = (ušt32_t)(
time_Áp
 / 65536.0 * 90000);

360 
¿‹Tx
 = 
sü—mTx
->
	`g‘T¬g‘B™¿‹
(
SSRC
)*
¿‹SÿË
;

361 
¿ndV®
 = (
	`¿nd
()è/ 
RAND_MAX
 - 0.5;

362 
by‹s
 = ()(
¿‹Tx
 / 
FPS
 / 8 * (1.0 + 
¿ndV®
 * 
¿ndR©e
));

364 ià(
isKeyF¿me
 && 
time_Áp
 - 
Ï¡KeyF¿meT_Áp
 >ğ
keyF¿meIÁ”v®_Áp
) {

368 
by‹s
 = ()(by‹s*
keyF¿meSize
);

369 
Ï¡KeyF¿meT_Áp
 = 
time_Áp
;

372 ià(!
pushT¿ffic
 && 
bur¡Time
 < 0) {

373 
tmp
 = 
time_Áp
 / 6554;

374 
tmp_mod
 = 
tmp
 % 
³riodicR©eDrİIÁ”v®
;

375 ià(
tmp_mod
 > (
³riodicR©eDrİIÁ”v®
 - 2)) {

382 
by‹s
 = 10;

384 ià(
tmp
 > 2 && (
tmp_mod
 > (
³riodicR©eDrİIÁ”v®
 - 2) ||mp_mod <= 2)) {

390 
sü—mTx
->
	`£tEÇbËR©eUpd©e
(
çl£
);

393 
sü—mTx
->
	`£tEÇbËR©eUpd©e
(
Œue
);

395 
time_s
 = 
time_Áp
 / 65536.0f;

396 ià(
bur¡S¹Time
 < 0) {

397 
bur¡S¹Time
 = 
time_s
;

398 
isBur¡
 = 
Œue
;

400 ià(
time_s
 > 
bur¡S¹Time
 + 
bur¡Time
 && 
isBur¡
) {

401 
isBur¡
 = 
çl£
;

402 
bur¡SË•Time
 = 
time_s
;

404 ià(
time_s
 > 
bur¡SË•Time
 + 
bur¡SË•
 && !
isBur¡
) {

405 
isBur¡
 = 
Œue
;

406 
bur¡S¹Time
 = 
time_s
;

408 ià(!
isBur¡
)

409 
by‹s
 = 0;

412 
by‹s
 > 0) {

413 
¶_size
 = 
	`mš
(
by‹s
, 
mtu
);

414 
»cvËn
 = 
¶_size
 + 12;

416 
by‹s
 = 
¡d
::
	`max
(0, by‹ - 
¶_size
);

417 
±
 = 
PT
;

418 
boŞ
 
isM¬k
;

419 ià(
by‹s
 == 0) {

421 
±
 |= 0x80;

422 
isM¬k
 = 
Œue
;

424 
isM¬k
 = 
çl£
;

426 
ušt8_t
 *
buf_¹p
 = (ušt8_ˆ*)
	`m®loc
(
BUFSIZE
);

427 
	`wr™eR
(
buf_¹p
, 
£qNr
, 
ts
, 
±
);

429 ià(
pushT¿ffic
) {

430 
	`£ndPack‘
(
buf_¹p
, 
»cvËn
);

431 
	`·ck‘_ä“
(
buf_¹p
);

432 
buf_¹p
 = 
NULL
;

435 
	`±h»ad_mu‹x_lock
(&
lock_¹p_queue
);

436 
¹pQueue
->
	`push
(
buf_¹p
, 
»cvËn
, 
£qNr
, 
isM¬k
, (
time_Áp
) / 65536.0f);

437 
	`±h»ad_mu‹x_uÆock
(&
lock_¹p_queue
);

439 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

440 
time_Áp
 = 
	`g‘TimeInN
();

441 
sü—mTx
->
	`ÃwMedŸF¿me
(
time_Áp
, 
SSRC
, 
»cvËn
);

442 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

444 
£qNr
++;

446 
	`wa™P”iod
(&
šfo
);

450  
NULL
;

451 
	}
}

453 
ušt32_t
 
	g¹ı_rx_time_Áp
 = 0;

454 
	#KEEP_ALIVE_PKT_SIZE
 1

	)

455 *
	$»adRtıTh»ad
(*
¬g
) {

460 
»cvËn
 = 
	`»cväom
(
fd_outgošg_¹p
, 
buf_¹ı
, 
BUFSIZE
, 0, (
sockaddr
 *)&
šcomšg_¹ı_addr
, &
add¾’_šcomšg_¹ı
);

461 ià(
¡İTh»ad
)

462  
NULL
;

463 ià(
»cvËn
 > 
KEEP_ALIVE_PKT_SIZE
) {

464 
	`±h»ad_mu‹x_lock
(&
lock_sü—m
);

465 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

466 
s
[100];

467 ià(
Áp
) {

468 
timev®
 

;

469 
	`g‘timeofday
(&

, 
NULL
);

470 
time
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6;

471 
	`¥rštf
(
s
, "%1.6f", 
time
);

474 
	`¥rštf
(
s
, "%1.4f", 
time_Áp
 / 65536.0f);

476 
sü—mTx
->
	`£tTimeSŒšg
(
s
);

478 
sü—mTx
->
	`šcomšgSnd¬dizedF“dback
(
time_Áp
, 
buf_¹ı
, 
»cvËn
);

480 
	`±h»ad_mu‹x_uÆock
(&
lock_sü—m
);

481 
¹ı_rx_time_Áp
 = 
time_Áp
;

483 
	`u¦“p
(10);

485  
NULL
;

486 
	}
}

488 *
	$s›¼aPythÚTh»ad
(*
¬g
) {

489 cÚ¡ *
TOK
 = " {}':,";

494 
»cvËn
 = 
	`»cväom
(
fd_s›¼a_pythÚ
, 
buf_s›¼a
, 
BUFSIZE
, 0, (
sockaddr
 *)&
s›¼a_pythÚ_addr
, &
add¾’_s›¼a_pythÚ_addr
);

495 
n
 = 0;‚ < 
	`¡¾’
((*)
buf_s›¼a
);‚++) {

496 ià(
buf_s›¼a
[
n
] == '"')

497 
buf_s›¼a
[
n
] = ' ';

499 
RSSI
 = 0;

500 
RSRP
 = 0;

501 
C–lId
 = 0;

502 
SINR
 = 0;

503 *
s
 = 
	`¡¹ok
((*)
buf_s›¼a
, 
TOK
);

504 
s
 != 0) {

505 ià(
	`¡r¡r
(
s
, "RSSI")) {

506 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

507 
RSSI
 = 
	`©oi
(
s
);

509 ià(
	`¡r¡r
(
s
, "ID")) {

510 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

511 
C–lId
 = 
	`©oi
(
s
);

513 ià(
	`¡r¡r
(
s
, "SINR")) {

514 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

515 
SINR
 = 
	`©oi
(
s
);

517 ià(
	`¡r¡r
(
s
, "RSRP")) {

518 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

519 
RSRP
 = 
	`©oi
(
s
);

521 
s
 = 
	`¡¹ok
(
NULL
, 
TOK
);

524 
	`¥rštf
(
s›¼aLogSŒšg
, " %9d, %4d, %4d, %4d", 
C–lId
, 
RSRP
, 
RSSI
, 
SINR
);

525 
sü—mTx
->
	`£tD‘aedLogExŒaD©a
(
s›¼aLogSŒšg
);

526 ià(
¡İTh»ad
)

527  
NULL
;

528 
	`u¦“p
(500000);

530  
NULL
;

531 
	}
}

533 
	$£tup
() {

534 
outgošg_¹p_addr
.
sš_çmy
 = 
AF_INET
;

535 
	`š‘_©Ú
(
DECODER_IP
, (
š_addr
*)&
outgošg_¹p_addr
.
sš_addr
.
s_addr
);

536 
outgošg_¹p_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

537 
add¾’_outgošg_¹p
 = (
outgošg_¹p_addr
);

539 
šcomšg_¹ı_addr
.
sš_çmy
 = 
AF_INET
;

540 
šcomšg_¹ı_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

541 
šcomšg_¹ı_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

543 
dummy_¹ı_addr
.
sš_çmy
 = 
AF_INET
;

544 
	`š‘_©Ú
(
DUMMY_IP
, (
š_addr
*)&
dummy_¹ı_addr
.
sš_addr
.
s_addr
);

545 
dummy_¹ı_addr
.
sš_pÜt
 = 
	`htÚs
(
DECODER_PORT
);

547 ià((
fd_outgošg_¹p
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

548 
	`³¼Ü
("cannot create socket");

552 ià(
iâame
 != 0) {

553 cÚ¡ 
Ën
 = 
	`¡¾’
(
iâame
);

554 ià(
	`£tsockİt
(
fd_outgošg_¹p
, 
SOL_SOCKET
, 
SO_BINDTODEVICE
, 
iâame
, 
Ën
) < 0) {

555 
	`³¼Ü
("setsockopt(SO_BINDTODEVICE) failed");

560 ià(
	`bšd
(
fd_outgošg_¹p
, (
sockaddr
 *)&
šcomšg_¹ı_addr
, (incoming_rtcp_addr)) < 0) {

561 
	`³¼Ü
("bind outgoing_rtp_addr failed");

565 ià(!
pushT¿ffic
)

566 
û¼
 << "Li¡’ oÀpÜˆ" << 
DECODER_PORT
 << "Ø»ûivRTCP from decod” " << 
’dl
;

569 ià(
s›¼aLog
) {

570 
s›¼a_pythÚ_addr
.
sš_çmy
 = 
AF_INET
;

571 
s›¼a_pythÚ_addr
.
sš_pÜt
 = 
	`htÚs
(
SIERRA_PYTHON_PORT
);

572 
s›¼a_pythÚ_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

574 ià((
fd_s›¼a_pythÚ
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

575 
	`³¼Ü
("cannot create socket");

579 ià(
	`bšd
(
fd_s›¼a_pythÚ
, (
sockaddr
 *)&
s›¼a_pythÚ_addr
, (sierra_python_addr)) < 0) {

580 
	`³¼Ü
("bind incoming_sierra_addr failed");

584 
û¼
 << "Li¡’ oÀpÜˆ" << 
SIERRA_PYTHON_PORT
 << "Ø»ûivd©¨äom s›¼¨pythÚ†og süˆ " << 
’dl
;

590 #ifdeà
ECN_CAPABLE


591 
tos
 = 0;

592 ià(
eù
 == 0 ||ƒct == 1)

593 
tos
 = 2 - 
eù
;

594 ià(
eù
 == 3)

595 
tos
 = 3;

596 
»s
 = 
	`£tsockİt
(
fd_outgošg_¹p
, 
IPPROTO_IP
, 
IP_TOS
, &
tos
, (iptos));

597 ià(
»s
 < 0) {

598 
û¼
 << "NÙ…ossibËØ£ˆECN b™s" << 
’dl
;

600 
tmp
 = 0;

602 
buf
[10];

603 ià(
fixedR©e
 > 0)

604 
sü—mTx
 = 
Ãw
 
	`Sü—mTx
(1.0f, 1.0f,

605 
d–ayT¬g‘
,

606 
çl£
,

608 (
fixedR©e
 * 100) / 8,

611 
eù
 == 1,

612 
Œue
,

613 
’abËClockDriáCom³n§tiÚ
);

615 
sü—mTx
 = 
Ãw
 
	`Sü—mTx
(
sÿËFaùÜ
, scaleFactor,

616 
d–ayT¬g‘
,

617 
çl£
,

618 1.0f, 
dsÿË
,

619 (
š™R©e
 * 100) / 8,

620 
·ck‘PacšgH—droom
,

622 
eù
 == 1,

623 
çl£
,

624 
’abËClockDriáCom³n§tiÚ
);

625 
¹pQueue
 = 
Ãw
 
	`RQueue
();

626 
sü—mTx
->
	`£tCwndMšLow
(5000);

628 ià(
fixedR©e
 > 0) {

629 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
,

630 
SSRC
,

632 
fixedR©e
*1000.0f,

633 
fixedR©e
*1000.0f,

634 
fixedR©e
*1000.0f,

640 
sÿËFaùÜ
,

641 
sÿËFaùÜ
,

642 
çl£
,

643 
hy¡”esis
);

646 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
,

647 
SSRC
,

649 
mšR©e
 * 1000,

650 
š™R©e
 * 1000,

651 
maxR©e
 * 1000,

652 
¿‹Inü—£
 * 1000,

653 
¿‹SÿË
,

655 
txQueueSizeFaùÜ
,

656 
queueD–ayGu¬d
,

657 
sÿËFaùÜ
,

658 
sÿËFaùÜ
,

659 
çl£
,

660 
hy¡”esis
);

663 
	}
}

665 
ušt32_t
 
	gÏ¡T_Áp
;

667 vŞ©
sig_©omic_t
 
	gdÚe
 = 0;

669 
	$¡İAÎ
(
signum
)

671 
¡İTh»ad
 = 
Œue
;

672 
	}
}

674 
	$maš
(
¬gc
, * 
¬gv
[]) {

676 
timev®
 

;

677 
	`g‘timeofday
(&

, 
NULL
);

678 
t0
 = 

.
tv_£c
 +p.
tv_u£c
*1e-6 - 1e-3;

679 
Ï¡T_Áp
 = 
	`g‘TimeInN
();

684 ià(
¬gc
 <= 1) {

685 
û¼
 << "SCReAM BWe¡oŞ, s’d”. EricssÚ AB. V”siÚ 2022-06-10" << 
’dl
;

686 
û¼
 << "U§g: " << 
’dl
 << " > scream_bw_test_tx <options> decoder_ip decoder_port " <<ƒndl;

687 
û¼
 << " -iàÇm bšdØ¥ecifiøš‹rçû" << 
’dl
;

688 
û¼
 << " -timv®u„uÀfÜim£cÚd (deçuÉ infš™e)" << 
’dl
;

689 
û¼
 << " -bur¡ v®1 v®2 bur¡ medŸ fÜ‡ giv’imªdh’ sË• ¨giv’ime" << 
’dl
;

690 
û¼
 << "ƒxam¶-bur¡ 1.0 0.2 bur¡ medŸ fÜ 1 th’ sË• fÜ 0.2 " << 
’dl
;

691 
û¼
 << " -nİaû di§bË…ack‘…acšg" << 
’dl
;

692 
û¼
 << " -fixed¿‹ v®u s‘‡ fixed 'cod”' b™¿‹ " << 
’dl
;

693 
û¼
 << " -pushŒaffiø ju¡…ushŒaffiø©‡ fixed b™¿‹,‚Øãedback‚“ded" << 
’dl
;

694 
û¼
 << " mu¡ bu£d w™h -fixed¿‹ o±iÚ" << 
’dl
;

695 
û¼
 << " -key v®1 v®2 s‘‡ giv’ key f¿mš‹rv® [s]‡nd sizmuÉl›¸" << 
’dl
;

696 
û¼
 << "ƒxam¶-key 2.0 5.0 " << 
’dl
;

697 
û¼
 << " -¿nd v®u f¿mesize v¬y„ªdomly‡roundhnomš® " << 
’dl
;

698 
û¼
 << "ƒxam¶-¿nd 10 f¿mesizv¬y +/- 10% " << 
’dl
;

699 
û¼
 << " -š™¿‹ v®u s‘‡ s¹ b™¿‹ [kbps]" << 
’dl
;

700 
û¼
 << "ƒxam¶-š™¿‹ 2000 " << 
’dl
;

701 
û¼
 << " -mš¿‹ v®u s‘‡ mš b™¿‹ [kbps], deçuÉ 1000kbps" << 
’dl
;

702 
û¼
 << "ƒxam¶-mš¿‹ 1000 " << 
’dl
;

703 
û¼
 << " -max¿‹ v®u s‘‡ max b™¿‹ [kbps], deçuÉ 200000kbps" << 
’dl
;

704 
û¼
 << "ƒxam¶-max¿‹ 10000 " << 
’dl
;

705 
û¼
 << " -¿‹šü—£ v®u s‘‡ max‡Îowed„©šü—£ s³ed [kbps/s]," << 
’dl
;

706 
û¼
 << " deçuÉ 10000kbps/s" << 
’dl
;

707 
û¼
 << "ƒxam¶-¿‹šü—£ 1000 " << 
’dl
;

708 
û¼
 << " -¿‹sÿË v®u s‘‡ max‡Îowed„©šü—£ s³ed‡ ¨äaùiÚ oàth" << 
’dl
;

709 
û¼
 << " cu¼’ˆ¿‹, deçuÉ 0.5" << 
’dl
;

710 
û¼
 << "ƒxam¶-¿‹sÿË 1.0 " << 
’dl
;

711 
û¼
 << " -eù‚ ECN c­abË¿n¥Üt,‚ = 0 o¸1 fÜ ECT(0èÜ ECT(1)," << 
’dl
;

712 
û¼
 << " -1 fÜ‚Ù-ECT (deçuÉ)" << 
’dl
;

713 
û¼
 << " -sÿË v®u sÿË faùÜ iÀÿ£ oàlos Ü ECNƒv’ˆ(deçuÉ 0.9è" << 
’dl
;

714 
û¼
 << " -dsÿË v®u sÿË faùÜ iÀÿ£ oàšü—£d d–ay (deçuÉ 10.0è" << 
’dl
;

715 
û¼
 << " -d–ayrg‘ v®u s‘‡ queud–ay¬g‘ (deçuÉ = 0.06sè" << 
’dl
;

716 
û¼
 << " -·ûh—droom v®u s‘‡…ack‘…acšg h—droom (deçuÉ = 1.25sè" << 
’dl
;

717 
û¼
 << " -txqueuesizeçùÜ v®u»aùiÚØšü—£d RTP queud–ay (deçuÉ 0.1è" << 
’dl
;

718 
û¼
 << " -queued–aygu¬d v®u„—ùiÚØšü—£d‚‘wÜk queud–ay (deçuÉ 0.05)" << 
’dl
;

719 
û¼
 << " -mtu v®u s‘hmax RTP…aylßd siz(deçuÉ 1200 by‹)" << 
’dl
;

720 
û¼
 << " -å v®u s‘häam¿‹ (deçuÉ 50)" << 
’dl
;

721 
û¼
 << " -şockdriáƒÇbË clock driá com³n§tiÚ fÜhÿ£h©he" << 
’dl
;

722 
û¼
 << "„eûiv”ƒnd clock i ç¡”" << 
’dl
;

723 
û¼
 << " -v”bo£…ršˆ¨mÜex‹nsivlog" << 
’dl
;

724 
û¼
 << " -nosumm¬y dÚ'ˆ´šˆsumm¬y" << 
’dl
;

725 
û¼
 << " -log†ogf savd‘aed…”-ACK†ogØfe" << 
’dl
;

726 
û¼
 << " -Á° u£ NTPime¡am°š†ogfe" << 
’dl
;

727 
û¼
 << " -­³nd‡µ’d†ogfe" << 
’dl
;

728 
û¼
 << " -™emli¡‡dd i‹m†i¡ iÀbegšnšg oàlog fe" << 
’dl
;

729 
û¼
 << " -d‘aed d‘aed†og,…” ACKed RTP" << 
’dl
;

730 
û¼
 << " -³riodicdrİš‹rv® iÁ”v® [s] b‘w“À³riodiødrİ š„©(deçuÉ 60s)" << 
’dl
;

731 
û¼
 << " -miüobur¡š‹rv® miüobur¡ iÁ”v® [ms] fÜ…ack‘…acšg (deçuÉ 2ms)" << 
’dl
;

732 
û¼
 << " -hy¡”esi  inhib™ upd©ed¬g‘„©tØ’cod” iàth¿‹ chªgi sm®l" << 
’dl
;

733 
û¼
 << "‡ v®uoà0.1 m—n ¨hy¡”esi oà+10%/-2.5%" << 
’dl
;

734 
	`ex™
(-1);

736 
ix
 = 1;

737 
boŞ
 
v”bo£
 = 
çl£
;

738 *
logFe
 = 0;

740 
	`¡r¡r
(
¬gv
[
ix
], "-")) {

741 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ect")) {

742 
eù
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

743 
ix
 += 2;

744 ià(!(
eù
 == 1 ||ƒct == 0 ||ƒct == 1 ||ƒct == 3)) {

745 
û¼
 << "eù mu¡ b-1, 0, 1 o¸3 " << 
’dl
;

746 
	`ex™
(0);

751 ià(
	`¡r¡r
(
¬gv
[
ix
], "-time")) {

752 
runTime
 = 
	`©of
(
¬gv
[
ix
 + 1]);

753 
ix
 += 2;

756 ià(
	`¡r¡r
(
¬gv
[
ix
], "-scale")) {

757 
sÿËFaùÜ
 = 
	`©of
(
¬gv
[
ix
 + 1]);

758 
ix
 += 2;

761 ià(
	`¡r¡r
(
¬gv
[
ix
], "-dscale")) {

762 
dsÿË
 = 
	`©of
(
¬gv
[
ix
 + 1]);

763 
ix
 += 2;

766 ià(
	`¡r¡r
(
¬gv
[
ix
], "-delaytarget")) {

767 
d–ayT¬g‘
 = 
	`©of
(
¬gv
[
ix
 + 1]);

768 
ix
 += 2;

772 ià(
	`¡r¡r
(
¬gv
[
ix
], "-paceheadroom")) {

773 
·ck‘PacšgH—droom
 = 
	`©of
(
¬gv
[
ix
 + 1]);

774 
ix
 += 2;

778 ià(
	`¡r¡r
(
¬gv
[
ix
], "-txqueuesizefactor")) {

779 
txQueueSizeFaùÜ
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

780 
ix
 += 2;

783 ià(
	`¡r¡r
(
¬gv
[
ix
], "-queuedelayguard")) {

784 
queueD–ayGu¬d
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

785 
ix
 += 2;

788 ià(
	`¡r¡r
(
¬gv
[
ix
], "-mtu")) {

789 
mtu
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

790 
ix
 += 2;

793 ià(
	`¡r¡r
(
¬gv
[
ix
], "-fixedrate")) {

794 
fixedR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

795 
ix
 += 2;

798 ià(
	`¡r¡r
(
¬gv
[
ix
], "-burst")) {

799 
bur¡Time
 = 
	`©of
(
¬gv
[
ix
 + 1]);

800 
bur¡SË•
 = 
	`©of
(
¬gv
[
ix
 + 2]);

801 
ix
 += 3;

804 ià(
	`¡r¡r
(
¬gv
[
ix
], "-key")) {

805 
isKeyF¿me
 = 
Œue
;

806 
keyF¿meIÁ”v®
 = 
	`©of
(
¬gv
[
ix
 + 1]);

807 
keyF¿meSize
 = 
	`©of
(
¬gv
[
ix
 + 2]);

808 
ix
 += 3;

811 ià(
	`¡r¡r
(
¬gv
[
ix
], "-nopace")) {

812 
di§bËPacšg
 = 
Œue
;

813 
ix
++;

816 ià(
	`¡r¡r
(
¬gv
[
ix
], "-fps")) {

817 
FPS
 = 
	`©of
(
¬gv
[
ix
 + 1]);

818 
ix
 += 2;

821 ià(
	`¡r¡r
(
¬gv
[
ix
], "-rand")) {

822 
¿ndR©e
 = 
	`©of
(
¬gv
[
ix
 + 1]) / 100.0;

823 
ix
 += 2;

826 ià(
	`¡r¡r
(
¬gv
[
ix
], "-initrate")) {

827 
š™R©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

828 
ix
 += 2;

831 ià(
	`¡r¡r
(
¬gv
[
ix
], "-minrate")) {

832 
mšR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

833 
ix
 += 2;

836 ià(
	`¡r¡r
(
¬gv
[
ix
], "-maxrate")) {

837 
maxR©e
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

838 
ix
 += 2;

841 ià(
	`¡r¡r
(
¬gv
[
ix
], "-rateincrease")) {

842 
¿‹Inü—£
 = 
	`©oi
(
¬gv
[
ix
 + 1]);

843 
ix
 += 2;

846 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ratescale")) {

847 
¿‹SÿË
 = 
	`©of
(
¬gv
[
ix
 + 1]);

848 
ix
 += 2;

851 ià(
	`¡r¡r
(
¬gv
[
ix
], "-verbose")) {

852 
v”bo£
 = 
Œue
;

853 
ix
++;

856 ià(
	`¡r¡r
(
¬gv
[
ix
], "-nosummary")) {

857 
´štSumm¬y
 = 
çl£
;

858 
ix
++;

861 ià(
	`¡r¡r
(
¬gv
[
ix
], "-log")) {

862 
logFe
 = 
¬gv
[
ix
 + 1];

863 
ix
 += 2;

866 ià(
	`¡r¡r
(
¬gv
[
ix
], "-sierralog")) {

867 
s›¼aLog
 = 
Œue
;

868 
ix
++;

871 ià(
	`¡r¡r
(
¬gv
[
ix
], "-ntp")) {

872 
Áp
 = 
Œue
;

873 
ix
++;

876 ià(
	`¡r¡r
(
¬gv
[
ix
], "-append")) {

877 
­³nd
 = 
Œue
;

878 
ix
++;

881 ià(
	`¡r¡r
(
¬gv
[
ix
], "-itemlist")) {

882 
™emli¡
 = 
Œue
;

883 
ix
++;

886 ià(
	`¡r¡r
(
¬gv
[
ix
], "-detailed")) {

887 
d‘aed
 = 
Œue
;

888 
ix
++;

891 ià(
	`¡r¡r
(
¬gv
[
ix
], "-pushtraffic")) {

892 
pushT¿ffic
 = 
Œue
;

893 
ix
++;

896 ià(
	`¡r¡r
(
¬gv
[
ix
], "-clockdrift")) {

897 
’abËClockDriáCom³n§tiÚ
 = 
Œue
;

898 
ix
++;

901 ià(
	`¡r¡r
(
¬gv
[
ix
], "-if")) {

902 
iâame
 = 
¬gv
[
ix
 + 1];

903 
ix
 += 2;

906 ià(
	`¡r¡r
(
¬gv
[
ix
], "-periodicdropinterval")) {

907 
³riodicR©eDrİIÁ”v®
 = ()(
	`©of
(
¬gv
[
ix
 + 1])*10.0f);

908 
ix
 += 2;

911 ià(
	`¡r¡r
(
¬gv
[
ix
], "-microburstinterval")) {

912 
mšPaûIÁ”v®
 = 0.001*(
	`©of
(
¬gv
[
ix
 + 1]));

913 
mšPaûIÁ”v®Us
 = ()(
mšPaûIÁ”v®
*1e6f);

914 
ix
 += 2;

915 ià(
mšPaûIÁ”v®
 < 0.002f || minPaceInterval > 0.020f) {

916 
û¼
 << "miüobur¡š‹rv® mu¡ bš„ªg2..20ms" << 
’dl
;

917 
	`ex™
(0);

921 ià(
	`¡r¡r
(
¬gv
[
ix
], "-hysteresis")) {

922 
hy¡”esis
 = 
	`©of
(
¬gv
[
ix
 + 1]);

923 
ix
 += 2;

924 ià(
hy¡”esis
 < 0.0f || hysteresis > 0.2f) {

925 
û¼
 << "hy¡”esi mu¡ bš„ªg0.0...0.2" << 
’dl
;

926 
	`ex™
(0);

930 
û¼
 << "uÃx³ùed‡rg " << 
¬gv
[
ix
] << 
’dl
;

931 
	`ex™
(0);

935 ià(
pushT¿ffic
 && 
fixedR©e
 == 0) {

936 
û¼
 << "E¼Ü :…ushŒaffiøÿÀÚly bu£d w™h fixed¿‹" << 
’dl
;

937 
	`ex™
(-1);

939 ià(
logFe
) {

940 ià(
­³nd
)

941 
å_log
 = 
	`fİ’
(
logFe
, "a");

943 
å_log
 = 
	`fİ’
(
logFe
, "w");

945 ià(
mšR©e
 > 
š™R©e
)

946 
š™R©e
 = 
mšR©e
;

947 
DECODER_IP
 = 
¬gv
[
ix
];ix++;

948 
DECODER_PORT
 = 
	`©oi
(
¬gv
[
ix
]);ix++;

950 ià(
	`£tup
() == 0)

953 ià(
logFe
 && !
­³nd
 && 
™emli¡
) {

954 
	`årštf
(
å_log
, "%s\n", 
sü—mTx
->
	`g‘D‘aedLogI‹mLi¡
());

957 
sigaùiÚ
 
aùiÚ
;

958 
	`mem£t
(&
aùiÚ
, 0, (
sigaùiÚ
));

959 
aùiÚ
.
§_hªdËr
 = 
¡İAÎ
;

960 
	`sigaùiÚ
(
SIGTERM
, &
aùiÚ
, 
NULL
);

961 
	`sigaùiÚ
(
SIGINT
, &
aùiÚ
, 
NULL
);

963 
sü—mTx
->
	`£tD‘aedLogFp
(
å_log
);

964 
sü—mTx
->
	`u£ExŒaD‘aedLog
(
d‘aed
);

966 
	`±h»ad_mu‹x_š™
(&
lock_sü—m
, 
NULL
);

967 
	`±h»ad_mu‹x_š™
(&
lock_¹p_queue
, 
NULL
);

968 
	`±h»ad_mu‹x_š™
(&
lock_·û
, 
NULL
);

971 
	`±h»ad_ü—‹
(&
ü—‹_¹p_th»ad
, 
NULL
, 
ü—‹RTh»ad
, (*)"Create RTPhread...");

972 ià(
pushT¿ffic
) {

973 
û¼
 << "Sü—m s’d” s¹ed iÀpush¿ffiømod" << 
fixedR©e
 << "kbps" << 
’dl
;

975 !
¡İTh»ad
 && (
runTime
 < 0 || 
	`g‘TimeInN
() <„unTime*65536.0f)) {

976 
	`u¦“p
(50000);

978 
¡İTh»ad
 = 
Œue
;

982 
û¼
 << "Sü—m s’d” s¹ed! " << 
’dl
;

985 
	`±h»ad_ü—‹
(&
¹ı_th»ad
, 
NULL
, 
»adRtıTh»ad
, (*)"RTCPhread...");

987 
	`±h»ad_ü—‹
(&
Œªsm™_¹p_th»ad
, 
NULL
, 
Œªsm™RTh»ad
, (*)"Transmit RTPhread...");

988 ià(
s›¼aLog
) {

990 
	`±h»ad_ü—‹
(&
s›¼a_pythÚ_th»ad
, 
NULL
, 
s›¼aPythÚTh»ad
, (*)"Sierra Python†oghread...");

993 !
¡İTh»ad
 && (
runTime
 < 0 || 
	`g‘TimeInN
() <„unTime*65536.0f)) {

994 
ušt32_t
 
time_Áp
 = 
	`g‘TimeInN
();

995 
boŞ
 
isF“dback
 = 
time_Áp
 - 
¹ı_rx_time_Áp
 < 65536;

996 ià((
´štSumm¬y
 || !
isF“dback
è&& 
time_Áp
 - 
Ï¡LogT_Áp
 > 2 * 65536) {

997 ià(!
isF“dback
) {

998 
û¼
 << "NØRTCP f“dback„eûived" << 
’dl
;

1001 
time_s
 = 
time_Áp
 / 65536.0f;

1002 
s
[500];

1003 
sü—mTx
->
	`g‘Sti¡ics
(
time_s
, 
s
);

1004 ià(
s›¼aLog
)

1005 
cout
 << 
s
 << 
’dl
 << " C–lId, RSRP, RSSI, SINR: {" << 
s›¼aLogSŒšg
 << "}" <<ƒndl <<ƒndl;

1007 
cout
 << 
s
 << 
’dl
;

1009 
Ï¡LogT_Áp
 = 
time_Áp
;

1011 ià(
v”bo£
 && 
time_Áp
 - 
Ï¡LogTv_Áp
 > 13107) {

1012 ià(
isF“dback
) {

1013 
time_s
 = 
time_Áp
 / 65536.0f;

1014 
s
[3000];

1015 
s1
[500];

1016 
sü—mTx
->
	`g‘V”yShÜtLog
(
time_s
, 
s1
);

1017 ià(
s›¼aLog
)

1018 
	`¥rštf
(
s
, "%8.3f, % % ", 
time_s
, 
s1
, 
s›¼aLogSŒšg
);

1020 
	`¥rštf
(
s
, "%8.3f, % ", 
time_s
, 
s1
);

1022 
cout
 << 
s
 << 
’dl
;

1027 
s1
[0] = 0x80;

1028 
s1
[1] = 0x7F;

1029 
	`memıy
(&
s1
[2], 
s
, 
	`¡¾’
(s));

1030 
	`£ndPack‘
(
s1
, 
	`¡¾’
(
s
) + 2);

1032 
Ï¡LogTv_Áp
 = 
time_Áp
;

1034 
	`u¦“p
(50000);

1036 
¡İTh»ad
 = 
Œue
;

1038 
	`u¦“p
(500000);

1039 
	`şo£
(
fd_outgošg_¹p
);

1040 ià(
å_log
)

1041 
	`fşo£
(
å_log
);

1042 
	}
}

	@scream/code/scream_v_a.cpp

4 
	~"¡dafx.h
"

5 
	#NO_LOG_TAG


	)

6 
	~"VideoEnc.h
"

7 
	~"RQueue.h
"

8 
	~"N‘Queue.h
"

9 
	~"Sü—mTx.h
"

10 
	~"Sü—mRx.h
"

12 
usšg
 
Çme¥aû
 
	g¡d
;

14 cÚ¡ 
	gTmax
 = 100;

15 cÚ¡ 
boŞ
 
	gisChR©e
 = 
çl£
;

16 cÚ¡ 
boŞ
 
	g´štLog
 = 
Œue
;

17 cÚ¡ 
boŞ
 
	geúC­abË
 = 
çl£
;

18 cÚ¡ 
boŞ
 
	gisL4s
 = 
çl£
;

19 cÚ¡ 
	gFR
 = 50.0f;

20 
	gsw´io
 = -1;

24 
	#TRACEFILE
 "../Œaûs/Œaû_æ©.txt"

	)

29 cÚ¡ 
	gmode
 = 0x01;

30 cÚ¡ 
	gtimeBa£
 = 10000.0;

32 
	$maš
(
¬gc
, * 
¬gv
[])

34 
tick
 = ()(
timeBa£
 / 
FR
);

35 
Sü—mTx
 *
sü—mTx
 = 
Ãw
 
	`Sü—mTx
(0.8f, 0.9f, 0.06f, 
çl£
, 1.0f, 5.0f, 50000, 1.25f, 20, 
isL4s
, false, false);

37 
sü—mTx
->
	`£tCwndMšLow
(3000);

38 
sü—mTx
->
	`£tPo¡CÚge¡iÚD–ay
(2);

40 
Sü—mRx
 *
sü—mRx
 = 
Ãw
 
	`Sü—mRx
(0,1,1);

41 
RQueue
 *
¹pQueue
[3] = { 
Ãw
 
	`RQueue
(),‚ew RtpQueue(),‚ew RtpQueue() };

42 
VideoEnc
 *
videoEnc
[3] = { 0, 0, 0};

43 
N‘Queue
 *
ÃtQueueD–ay
 = 
Ãw
 
	`N‘Queue
(0.02f, 0.0f, 0.0f);

44 
N‘Queue
 *
ÃtQueueR©e
 = 
Ãw
 
	`N‘Queue
(0.0f, 20e6, 0.0f, 
isL4s
);

45 
videoEnc
[0] = 
Ãw
 
	`VideoEnc
(
¹pQueue
[0], 
FR
, (*)
TRACEFILE
, 0);

46 
videoEnc
[1] = 
Ãw
 
	`VideoEnc
(
¹pQueue
[1], 
FR
, (*)
TRACEFILE
, 50);

47 
videoEnc
[2] = 
Ãw
 
	`VideoEnc
(
¹pQueue
[2], 
FR
, (*)
TRACEFILE
, 100);

48 ià(
mode
 & 0x01)

49 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
[0], 10, 1.0f, 1e6f, 1e6f, 20e6f, 10e6f, 1.0f, 0.1f, 0.2f, 0.1f, 0.9f, 0.95f, 
Œue
);

50 ià(
mode
 & 0x02)

51 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
[1], 11, 0.9f, 1e6f, 1e6f, 20e6f, 10e6f, 1.0f, 0.1f, 0.2f, 0.1f, 0.9f, 0.95f, 
Œue
);

52 ià(
mode
 & 0x04)

53 
sü—mTx
->
	`»gi¡”NewSŒ—m
(
¹pQueue
[2], 12, 0.2f, 256e3f, 1024e3f, 8192e3f, 1e6f, 0.5f, 0.2f, 0.1f, 0.1f);

56 
time
 = 0.0f;

57 
ušt32_t
 
time_Áp
 = 0;

58 
ušt32_t
 
time_Áp_rx
 = 0;

59 
n
 = 0;

60 
nPkt
 = 0;

61 
ušt32_t
 
s¤c
;

62 
¹pPack‘
[2000];

63 
size
;

64 
ušt16_t
 
£qNr
;

65 
ÃxtC®lN
 = -1;

66 
boŞ
 
isF“dback
 = 
çl£
;

67 
Ï¡LogT
 = -1.0;

68 
time
 <ğ
Tmax
) {

69 
»tV®
 = -1.0;

70 
time
 = 
n
 / 
timeBa£
;

71 
time_Áp
 = 
n
*(65536 / 
timeBa£
) + 100;

72 
time
 = 
time_Áp
 / 65536.0f;

73 
time_Áp_rx
 = 
n
 * (65536.0à/ 
timeBa£
);

74 
ÃtQueueR©e
->
	`upd©eR©e
(
time
);

75 
boŞ
 
isEv’t
 = 
çl£
;

77 ià(
n
 % 
tick
 == 0) {

79 ià(
mode
 & 0x01) {

80 
videoEnc
[0]->
	`£tT¬g‘B™¿‹
(
sü—mTx
->
	`g‘T¬g‘B™¿‹
(10));

81 
by‹s
 = 
videoEnc
[0]->
	`’code
(
time
);

82 
sü—mTx
->
	`ÃwMedŸF¿me
(
time_Áp
, 10, 
by‹s
);

84 ià(
mode
 & 0x02) {

85 
videoEnc
[1]->
	`£tT¬g‘B™¿‹
(
sü—mTx
->
	`g‘T¬g‘B™¿‹
(11));

86 
by‹s
 = 
videoEnc
[1]->
	`’code
(
time
);

87 
sü—mTx
->
	`ÃwMedŸF¿me
(
time_Áp
, 11, 
by‹s
);

89 ià(
mode
 & 0x04) {

90 
videoEnc
[2]->
	`£tT¬g‘B™¿‹
(
sü—mTx
->
	`g‘T¬g‘B™¿‹
(12));

91 
by‹s
 = 
videoEnc
[2]->
	`’code
(
time
);

92 
sü—mTx
->
	`ÃwMedŸF¿me
(
time_Áp
, 12, 
by‹s
);

97 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
s¤c
);

98 
isEv’t
 = 
Œue
;

102 
boŞ
 
isCe
 = 
çl£
;

103 ià(
ÃtQueueD–ay
->
	`exŒaù
(
time
, 
¹pPack‘
, 
s¤c
, 
size
, 
£qNr
, 
isCe
)) {

104 
ÃtQueueR©e
->
	`š£¹
(
time
, 
¹pPack‘
, 
s¤c
, 
size
, 
£qNr
, 
isCe
);

107 ià(
Œue
 || 
time
 < 30.0 ||ime > 30.1) {

108 ià(
ÃtQueueR©e
->
	`exŒaù
(
time
, 
¹pPack‘
, 
s¤c
, 
size
, 
£qNr
, 
isCe
)) {

109 ià(
£qNr
 % 200 =ğ19 && 
çl£
) {

110 
û¼
 << "lo¡ " << 
£qNr
 << 
’dl
;

113 
ušt8_t
 
ûB™s
 = 0x00;

114 ià(
eúC­abË
) {

115 ià(
isL4s
)

116 
ûB™s
 = 0x01;

118 
ûB™s
 = 0x02;

119 ià(
isCe
è
ûB™s
 = 0x03;

124 
sü—mRx
->
	`»ûive
(
time_Áp_rx
, 0, 
s¤c
, 
size
, 
£qNr
, 
ûB™s
);

126 
nPkt
++;

130 
buf
[2000];

131 
fb_size
 = -1;

132 ià(
Œue
 || 
time
 < 30.0 ||ime > 30.5) {

133 
boŞ
 
isF“dback
 = 
sü—mRx
->
	`isF“dback
(
time_Áp_rx
) &&

134 (
time_Áp_rx
 - 
sü—mRx
->
	`g‘La¡F“dbackT
(è> sü—mRx->
	`g‘RtıFbIÁ”v®
(è|| sü—mRx->
	`checkIfFlushAck
());

136 ià(
isF“dback
 && 
sü—mRx
->
	`ü—‹Snd¬dizedF“dback
(
time_Áp_rx
, 
çl£
, 
buf
, 
fb_size
)) {

137 
sü—mTx
->
	`šcomšgSnd¬dizedF“dback
(
time_Áp
, 
buf
, 
fb_size
);

138 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
s¤c
);

139 
isEv’t
 = 
Œue
;

143 ià(
n
 =ğ
ÃxtC®lN
 && 
»tV®
 != 0.0f) {

144 
»tV®
 = 
sü—mTx
->
	`isOkToT¿nsm™
(
time_Áp
, 
s¤c
);

145 ià(
»tV®
 > 0) {

146 
ÃxtC®lN
 = 
n
 + 
	`max
(1, ()(1000.0*
»tV®
));

147 
isEv’t
 = 
Œue
;

151 ià(
»tV®
 == 0) {

155 **
¹pPack‘
 = 0;

156 
s¤c
) {

158 
¹pQueue
[0]->
	`£ndPack‘
(
¹pPack‘
, 
size
, 
£qNr
);

161 
¹pQueue
[1]->
	`£ndPack‘
(
¹pPack‘
, 
size
, 
£qNr
);

164 
¹pQueue
[2]->
	`£ndPack‘
(
¹pPack‘
, 
size
, 
£qNr
);

167 
ÃtQueueD–ay
->
	`š£¹
(
time
, 
¹pPack‘
, 
s¤c
, 
size
, 
£qNr
);

168 
boŞ
 
isM¬k
 = 
çl£
;

169 
»tV®
 = 
sü—mTx
->
	`addT¿nsm™‹d
(
time_Áp
, 
s¤c
, 
size
, 
£qNr
, 
isM¬k
);

170 
ÃxtC®lN
 = 
n
 + 
	`max
(1, ()(1000.0*
»tV®
));

171 
isEv’t
 = 
Œue
;

174 ià(
Œue
 && 
´štLog
 && 
time
 - 
Ï¡LogT
 > 0.05) {

175 
cout
 << 
time
 << " " ;

176 
s
[500];

177 
sü—mTx
->
	`g‘ShÜtLog
(
time
, 
s
);

179 
cout
 << " " << 
s
 << 
’dl
;

180 
Ï¡LogT
 = 
time
;

190 ià(
isChR©e
) {

191 ià((
time
 > 10.0 &&im< 20è&& 
isChR©e
) {

192 
ÃtQueueR©e
->
¿‹
 = 10000e3;

195 
ÃtQueueR©e
->
¿‹
 = 20000e3;

199 ià(
time
 > 30 && 
sw´io
 == 0) {

200 
sw´io
 = 1;

201 
sü—mTx
->
	`£tT¬g‘PriÜ™y
(10, 0.2);

202 
sü—mTx
->
	`£tT¬g‘PriÜ™y
(11, 1.0);

204 ià(
time
 > 35 && 
sw´io
 == 1) {

205 
sw´io
 = 2;

206 
sü—mTx
->
	`£tT¬g‘PriÜ™y
(10, 1.0);

207 
sü—mTx
->
	`£tT¬g‘PriÜ™y
(11, 0.2);

210 ià(
çl£
 && 
time
 > 50)

211 
ÃtQueueR©e
->
¿‹
 = 8e6;

224 
n
++;

225 #ifdeà
_WIN32


226 
	`SË•
(0);

228 
	`¦“p
(0);

233 
	}
}

	@scream/code/stdafx.cpp

5 
	~"¡dafx.h
"

	@scream/code/stdafx.h

6 #´agm¨
Úû


8 #ifdeà
_WIN32


9 
	~"rg‘v”.h
"

10 
	~<tch¬.h
>

11 
	~<wšdows.h
>

13 
	~"uni¡d.h
"

17 
	~<¡ršg.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<io¡»am
>

	@scream/code/targetver.h

1 #´agm¨
Úû


8 
	~<SDKDDKV”.h
>

	@
1
.
1
/usr/include
18
453
scream/code/NetQueue.cpp
scream/code/NetQueue.h
scream/code/RtpQueue.cpp
scream/code/RtpQueue.h
scream/code/ScreamRx.cpp
scream/code/ScreamRx.h
scream/code/ScreamTx.cpp
scream/code/ScreamTx.h
scream/code/TxList.h
scream/code/VideoEnc.cpp
scream/code/VideoEnc.h
scream/code/scream_receiver.cpp
scream/code/scream_sender.cpp
scream/code/scream_sender_copy.cpp
scream/code/scream_v_a.cpp
scream/code/stdafx.cpp
scream/code/stdafx.h
scream/code/targetver.h
